<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="HandheldFriendly" content="true">
    <title>טופס איסוף נתונים לבעל מקצוע - Collabo AI Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Simple Form to Prompt JSON - מוטמע בקובץ -->
    <style>
        :root {
            --ai-purple: rgba(76, 29, 149, 0.5);
            --text-primary: #37352f;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-light: #e5e7eb;
            --bg-light: #ffffff;
            --bg-gray: #f3f4f6;
            --border-radius: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: #37352f;
            direction: rtl;
            background: #ffffff;
            font-weight: 400;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .main-wrapper {
            min-height: 100vh;
            background: var(--bg-gray);
            padding: 60px 0;
        }

        .page-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .page-header h1 {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .page-header p {
            font-size: 1em;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .brand-tag {
            display: inline-block;
            background: rgba(76, 29, 149, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: 0.5px;
        }

        /* Contact Form Styles - מעתק מדף הנחיתה */
        .contact-form {
            max-width: 700px;
            margin: 0 auto;
        }

        .form-input {
            width: 100%;
            height: 48px;
            padding: 12px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-light);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-sizing: border-box;
            text-align: right;
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.2);
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .form-section {
            margin-bottom: 60px;
            padding: 32px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .form-section h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0px;
        }

        .section-description {
            background: rgba(76, 29, 149, 0.05);
            border: 1px solid rgba(76, 29, 149, 0.15);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .section-description strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 28px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .question-number {
            color: var(--ai-purple);
            font-weight: 800;
            margin-left: 8px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Radio/Checkbox Groups */
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 0;
            flex-direction: column;
        }

        /* Yes/No radio groups - horizontal layout */
        .radio-group.yes-no {
            flex-direction: row;
            justify-content: flex-start;
        }

        .radio-group.yes-no .radio-item {
            flex: 0 0 auto;
            min-width: 80px;
            max-width: 120px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 48px;
            padding: 12px 20px;
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .radio-item:hover {
            border-color: var(--ai-purple);
            background: rgba(76, 29, 149, 0.05);
        }

        .radio-item input {
            accent-color: rgba(76, 29, 149, 0.8);
        }

        .radio-item.selected {
            border-color: rgba(76, 29, 149, 0.8);
            background: rgba(76, 29, 149, 0.1);
            color: rgba(76, 29, 149, 0.8);
            font-weight: 600;
        }




        /* Checkbox styling */
        .work-area-checkbox-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            height: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .work-area-checkbox-item:hover {
            background-color: #f8fafc;
        }

        .work-area-checkbox-item:last-child {
            border-bottom: none;
        }

        /* ==============================================
           CHECKBOX STYLING - UNIFIED ACROSS ALL POPUPS
        ============================================== */
        
        /* Standard checkbox styling for all popup checkboxes */
        input[type="checkbox"] {
            accent-color: rgba(76, 29, 149, 0.8);
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        /* Specific styling for popup checkboxes */
        .popup-checkbox {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
            accent-color: rgba(76, 29, 149, 0.8);
        }

        /* Popup item containers - unified styling */
        .benefit-item,
        .restriction-item,
        .subcategory-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .benefit-item:hover,
        .restriction-item:hover,
        .subcategory-item:hover {
            background-color: rgba(76, 29, 149, 0.05);
        }





        /* ==============================================
           TAG CONTAINERS ARCHITECTURE
        ============================================== */
        
        /* Base layout for all dynamic content containers */
        .dynamic-content-container {
            display: flex;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Layout modifiers */
        .layout--inline-wrap {
            flex-wrap: wrap;
        }

        .layout--vertical-stack {
            flex-direction: column;
        }

        /* ==============================================
           COMPONENT-SPECIFIC IMPLEMENTATIONS
        ============================================== */

        /* Area selection tags - wrap horizontally */
        .work-area-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Business benefits categories - stack vertically */
        .business-benefits-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Restriction input containers - stack vertically */
        .restriction-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Business benefits display styling */

        #businessBenefitsDisplay {
            cursor: pointer;
            transition: border-color 0.2s;
        }

        #businessBenefitsDisplay:hover {
            border-color: var(--ai-purple);
        }


        /* ==============================================
           BUSINESS BENEFIT INPUT STYLING
        ============================================== */
        
        .business-benefit-input {
            /* Desktop base styling */
            padding: 12px 16px 12px 40px;
            font-size: 14px;
            text-align: right;
            direction: rtl;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .business-benefit-input:focus {
            border-color: var(--ai-purple) !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
        }

        .business-benefit-input:hover {
            border-color: #d1d5db;
        }

        /* ==============================================
           RESTRICTION INPUT STYLING
        ============================================== */
        
        .restriction-input {
            /* Desktop base styling */
            padding: 12px 16px 12px 40px;
            font-size: 14px;
            text-align: right;
            direction: rtl;
            background: #f9fafb;
        }

        .restriction-input:focus {
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .restriction-input:hover {
            border-color: #d1d5db;
        }

        /* Reset margins when containers have content */
        .work-area-tags:not(:empty),
        .business-benefits-tags:not(:empty),
        .restriction-tags:not(:empty) {
            margin-top: 0;
        }

        /* ==============================================
           TAG ELEMENTS (Individual items within containers)
        ============================================== */
        
        .work-area-tag,
        .business-benefit-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f9fafb;
            color: #374151;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid #d1d5db;
        }

        .work-area-tag .remove-tag,
        .business-benefit-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #dc2626;
            transition: background-color 0.2s;
        }

        .work-area-tag .remove-tag:hover,
        .business-benefit-tag .remove-tag:hover {
            background: rgba(220, 38, 38, 0.1);
        }


        /* Work area styling */
        .work-area-select-container {
            position: relative;
            width: 100%;
        }

        .work-area-select {
            width: 100%;
            height: 48px;
            padding: 12px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .work-area-select:hover {
            border-color: var(--ai-purple);
        }

        .work-area-select.active {
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.2);
        }

        .work-area-placeholder {
            color: var(--text-muted);
        }

        .work-area-arrow {
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }

        .work-area-select.active .work-area-arrow {
            transform: rotate(180deg);
        }





        /* Submit Button - מעתק מדף הנחיתה */
        .contact-form button {
            width: 100%;
            padding: 16px 20px;
            background: rgba(76, 29, 149, 0.8);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0px;
        }

        .contact-form button:hover {
            background: #3730a3;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(76, 29, 149, 0.3);
        }

        .footer-info {
            text-align: center;
            margin-top: 40px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .footer-info .brand {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 16px;
        }

        /* Responsive Design */
        /* Large mobile / Small tablet styles (600px and below) */
        @media (max-width: 600px) {
            .container {
                padding: 0 14px;
            }
            
        }
        
        /* Tablet styles (768px and below) */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .main-wrapper {
                padding: 40px 0;
            }

            .page-header h1 {
                font-size: 2em;
            }

            .page-header p {
                font-size: 1em;
            }

            .form-section {
                padding: 24px;
                margin-bottom: 40px;
            }

            .form-input, .work-area-select, .radio-item {
                height: 44px;
                padding: 10px 16px;
                font-size: 16px;
            }

            /* Tablet: Container margins */
            .work-area-tags,
            .business-benefits-tags,
            .restriction-tags {
                margin-top: 0;
            }

            .form-label {
                font-size: 15px;
                margin-bottom: 0;
            }

            .question-number {
                font-size: 18px;
            }

            .radio-group {
                flex-direction: column;
            }

            .radio-item {
                min-width: 100%;
            }


            .contact-form button {
                padding: 14px 20px;
                font-size: 16px;
            }
        }

        /* Universal popup styling - ensure consistency across all devices */
        #saveCombinedSpecializations,
        #saveBusinessBenefits,
        #saveRestrictions {
            width: 120px !important;
            font-size: 14px !important;
            padding: 10px 12px !important;
            min-height: 44px !important;
        }
        
        .set-primary-btn {
            width: 90px !important;
            height: 32px !important;
            font-size: 12px !important;
            padding: 4px 8px !important;
            min-height: 32px !important;
        }

        /* Desktop styles (769px and above) - Force same styling as mobile */
        @media (min-width: 769px) {
            /* Force all popup containers to look exactly like mobile */
            #combinedSpecializationsPopupContent,
            #businessBenefitsPopupContent,
            #restrictionsPopupContent {
                max-height: 85vh !important;
                margin: 0 auto !important;
            }
            
            /* Force popup headers to match mobile */
            #combinedSpecializationsPopup div[style*="padding: 24px"],
            #businessBenefitsPopup div[style*="padding: 24px"],
            #restrictionsPopup div[style*="padding: 24px"] {
                padding: 16px !important;
            }
            
            /* Force save buttons to be exactly like mobile */
            #saveCombinedSpecializations,
            #saveBusinessBenefits,
            #saveRestrictions {
                width: 120px !important;
                font-size: 14px !important;
                padding: 10px 12px !important;
                min-height: 44px !important;
            }
            
            /* Force category buttons to match mobile */
            .set-primary-btn {
                width: 90px !important;
                height: 32px !important;
                font-size: 12px !important;
                padding: 4px 8px !important;
                min-height: 32px !important;
            }
            
            /* Force popup category headers to match mobile height */
            #combinedSpecializationsPopup div[style*="padding: 10px"],
            #businessBenefitsPopup div[style*="padding: 10px"],
            #restrictionsPopup div[style*="padding: 10px"] {
                padding: 10px !important;
            }
        }

        /* Live Preview Section - Force consistent styling across all devices */
        #livePreviewSection {
            padding: 20px 32px !important;
            margin: 60px 0 !important;
            border: 2px dashed #6366f1 !important;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)) !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
        }

        #livePreviewSection h3 {
            text-align: center !important;
            margin-top: 0 !important;
            font-size: 24px !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
        }

        #livePreviewSection h4 {
            text-align: center !important;
            color: var(--text-secondary) !important;
            font-weight: 400 !important;
            margin-top: 8px !important;
            margin-bottom: 20px !important;
        }

        #generatePreviewBtn {
            width: auto !important;
            padding: 12px 24px !important;
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            margin: 20px auto 0 auto !important;
            display: block !important;
        }

        /* Responsive adjustments for Live Preview */
        @media (max-width: 768px) {
            #livePreviewSection {
                padding: 16px 20px !important;
                margin: 40px 0 !important;
            }
        }

        @media (max-width: 480px) {
            #livePreviewSection {
                padding: 12px 12px 4px 12px !important;
                margin: 24px 0 !important;
            }

            #livePreviewSection h3 {
                font-size: 20px !important;
            }

            #livePreviewSection h4 {
                font-size: 14px !important;
                margin-bottom: 12px !important;
            }

            #generatePreviewBtn {
                font-size: 14px !important;
                padding: 10px 20px !important;
                margin: 0 auto !important;
            }
        }

        /* Facebook-style posts and comments - Force consistent styling across all devices */
        .facebook-post-card {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            padding: 20px !important;
            min-height: 300px !important;
        }

        .post-header {
            display: flex !important;
            align-items: center !important;
            padding: 12px 16px !important;
            border-bottom: 1px solid #f0f2f5 !important;
        }

        .post-content {
            padding: 16px !important;
            color: #1c1e21 !important;
            line-height: 1.5 !important;
            font-size: 15px !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
        }

        .facebook-post-card h4 {
            font-size: 16px !important;
            margin-bottom: 12px !important;
            line-height: 1.4 !important;
        }

        .facebook-post-card p {
            font-size: 14px !important;
            line-height: 1.5 !important;
            margin-bottom: 8px !important;
        }

        .facebook-post-card .response {
            background: #f8fafc !important;
            border-right: 4px solid #6366f1 !important;
            padding: 15px !important;
            margin-top: 12px !important;
            border-radius: 8px !important;
        }

        .comments-section {
            background: #f8f9fa !important;
            border: 1px solid #dddfe2 !important;
            border-radius: 8px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            padding: 0 !important;
            border-top: 1px solid #f0f2f5 !important;
            min-height: 80px !important;
        }

        .comment {
            display: flex !important;
            align-items: flex-start !important;
            padding: 12px 16px !important;
            border-bottom: 1px solid #f0f2f5 !important;
        }

        .comment-avatar {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            background: #6366f1 !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            margin-left: 8px !important;
        }

        .comment-content {
            flex: 1 !important;
        }

        .comment-author {
            font-weight: 600 !important;
            color: #365899 !important;
            font-size: 13px !important;
            margin-bottom: 2px !important;
        }

        .comment-time {
            color: #90949c !important;
            font-size: 12px !important;
            margin-bottom: 4px !important;
        }

        .comment-text {
            padding: 0 16px 12px !important;
            color: #1c1e21 !important;
            line-height: 1.34 !important;
            font-size: 15px !important;
        }

        .post-interactions {
            border-top: 1px solid #f0f2f5 !important;
            padding: 8px 16px !important;
        }

        .interactions-bar {
            display: flex !important;
            justify-content: space-between !important;
            padding: 0 4px !important;
            gap: 8px !important;
            height: 30px !important;
        }

        .interaction-btn {
            flex: 1 !important;
            padding: 0 8px !important;
            font-size: 13px !important;
            text-align: center !important;
            background-color: transparent !important;
            border-radius: 6px !important;
            border: none !important;
            color: #65676b !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            line-height: 1 !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            transition: background-color 0.2s ease !important;
        }

        .interaction-btn:hover {
            background-color: #f0f2f5 !important;
        }

        /* Post avatar and meta elements */
        .post-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: #1877f2 !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            margin-left: 12px !important;
        }

        .post-meta {
            flex: 1 !important;
        }

        .post-author {
            font-weight: 600 !important;
            color: #1c1e21 !important;
            font-size: 15px !important;
            margin-bottom: 2px !important;
        }

        .post-time {
            color: #65676b !important;
            font-size: 13px !important;
        }

        /* Single consistent styling - no device variations */
        /* All devices get the same mobile-optimized design */

        /* API Status Indicator */
        .api-status-indicator {
            background: #fef3c7 !important;
            border: 1px solid #f59e0b !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            margin-bottom: 20px !important;
            text-align: center !important;
            font-size: 14px !important;
            color: #92400e !important;
            display: none !important;
        }

        .api-status-indicator.show {
            display: block !important;
        }

        .api-status-indicator strong {
            color: #78350f !important;
        }

        /* Mobile styles (480px and below) */
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }

            .main-wrapper {
                padding: 20px 0;
            }

            .page-header {
                margin-bottom: 12px;
            }

            .page-header h1 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }

            .page-header p {
                font-size: 0.875em;
            }

            .brand-tag {
                font-size: 0.8em;
                padding: 6px 12px;
                margin-bottom: 16px;
            }

            .form-section {
                padding: 8px 16px 16px 16px;
                margin-bottom: 24px;
            }

            .form-section h3 {
                font-size: 24px;
                margin-bottom: 0px;
            }

            .form-group {
                gap: 14px;
                margin-bottom: 24px;
            }

            .form-input, .work-area-select, .radio-item {
                height: 44px;
                padding: 10px 14px;
                font-size: 14px;
                border-width: 1px;
            }

            .form-label {
                font-size: 16px;
                margin-bottom: 0;
            }

            .question-number {
                font-size: 16px;
                margin-left: 8px;
            }


            /* Mobile display adjustments */
            #businessBenefitsDisplay {
                height: auto;
                min-height: 44px;
                padding: 10px 14px;
            }

            /* Mobile radio buttons - yes/no specific */
            .radio-group.yes-no {
                flex-direction: row;
                gap: 8px;
            }

            .radio-group.yes-no .radio-item {
                flex: 1;
                min-width: auto;
                max-width: none;
                text-align: center;
                justify-content: center;
            }
            
            /* Mobile radio buttons - regular groups stay vertical */
            .radio-group:not(.yes-no) {
                flex-direction: column;
                gap: 8px;
            }
            
            .radio-group:not(.yes-no) .radio-item {
                width: 100%;
                justify-content: flex-start;
                text-align: right;
                padding: 12px 16px;
                height: 44px;
                gap: 10px;
            }
            
            .radio-group:not(.yes-no) .radio-item span {
                line-height: 1.4;
                word-wrap: break-word;
            }

            /* Mobile tags - removed duplicate, handled below */

            .contact-form button {
                padding: 12px 16px;
                font-size: 14px;
                height: 48px;
            }

            /* Fix mobile touch targets */
            .fas {
                font-size: 14px;
            }

            
            
            /* Mobile business benefits display */
            #businessBenefitsDisplay {
                padding: 10px 14px !important;
                border-width: 1px !important;
                font-size: 14px !important;
            }
            
            #businessBenefitsDisplay span {
                font-size: 14px !important;
            }
            
            #specializationsDisplay {
                padding: 10px 14px !important;
                border-width: 1px !important;
                font-size: 14px !important;
            }
            
            #specializationsDisplay span {
                font-size: 14px !important;
            }
            
            /* Mobile: Special input types */
            .business-benefit-input,
            .restriction-input {
                font-size: 14px !important;
                padding: 10px 14px 10px 35px !important;
                text-align: right !important;
            }
            

            /* Mobile preview button */
            #generatePreviewBtn {
                width: 100% !important;
                padding: 16px 20px !important;
                font-size: 14px !important;
                margin: 20px 0 !important;
                white-space: normal !important;
                line-height: 1.4 !important;
                height: auto !important;
                min-height: 50px !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                text-align: center !important;
                display: block !important;
                box-sizing: border-box !important;
            }

            /* Mobile preview container spacing */
            #previewContainer {
                margin-top: 30px !important;
            }

            /* All post styling now handled by single global CSS system above */
            
            /* Ensure popup mobile responsiveness */
            #combinedSpecializationsPopupContent,
            #businessBenefitsPopupContent,
            #restrictionsPopupContent {
                margin: 0 auto !important;
                max-height: 85vh !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            /* Popup headers compact on mobile */
            #combinedSpecializationsPopup .popup-header,
            #businessBenefitsPopup .popup-header,
            #restrictionsPopup .popup-header {
                padding: 16px !important;
            }
            
            /* Popup titles readable on mobile */
            #combinedSpecializationsPopup h3,
            #businessBenefitsPopup h3,
            #restrictionsPopup h3 {
                font-size: 18px !important;
            }
            
            /* Save buttons touch-friendly */
            #saveCombinedSpecializations,
            #saveBusinessBenefits,
            #saveRestrictions {
                min-height: 44px !important;
                width: 120px !important;
                padding: 12px !important;
                font-size: 14px !important;
            }
            
            /* Category buttons in popups - mobile friendly */
            .set-primary-btn {
                width: 90px !important;
                height: 32px !important;
                font-size: 12px !important;
                padding: 4px 8px !important;
                min-height: 32px !important;
            }
        }
            
        /* Preview Section Styles */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .preview-btn:hover {
                background: linear-gradient(135deg, #5b64f0, #7c3aed) !important;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            
            .preview-post {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .preview-post-content {
                background: white;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 12px;
                border-left: 4px solid #3b82f6;
            }
            
            .preview-response {
                background: #f0f9ff;
                border: 1px solid #0ea5e9;
                border-radius: 6px;
                padding: 12px;
                margin-top: 8px;
            }
            
            .preview-response-header {
                font-weight: 600;
                color: #0c4a6e;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .preview-response-content {
                color: #334155;
                line-height: 1.6;
                white-space: pre-wrap;
            }

            
            /* Mobile textarea */
            .form-textarea {
                font-size: 14px !important;
                padding: 10px 14px !important;
            }
            
            
            
            /* Mobile specific spacing fixes */
            .form-section {
                margin-bottom: 40px !important;
            }
            
            .form-group {
                gap: 14px;
                margin-bottom: 22px !important;
            }
            
            /* Mobile viewport fix */
            body {
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
            }
            
            /* Mobile: All tag elements */
            .work-area-tag, 
            .business-benefit-tag {
                font-size: 12px !important;
                padding: 4px 8px !important;
                margin: 2px !important;
            }
            
            /* Mobile: Reset margins for all dynamic containers */
            .work-area-tags,
            .business-benefits-tags, 
            .restriction-tags {
                margin-top: 0 !important;
            }
            
            /* Mobile button improvements */
            .contact-form button:hover {
                transform: none;
            }
            
        
        /* Clean CSS architecture - single source of truth for all post styling */
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="container">
            <div class="page-header">
                <div class="brand-tag">Collabo AI Pro</div>
                <h1>טופס איסוף נתונים לבעל מקצוע</h1>
                <p>כדי ליצור עבורכם מערכת תגובות מותאמת אישית שתייצג אתכם בצורה הכי טובה, אנחנו צריכים לאסוף מספר פרטים חשובים.</p>
            </div>

            <form class="contact-form" id="clientForm">
                <!-- פרטים בסיסיים -->
                <div class="form-section">
                    <h3>פרטים בסיסיים</h3>
                    <div class="section-description">
                        פרטים בסיסיים ליצירת זהות מקצועית ברורה בתגובות.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">1.</span>
                            שם העסק שלכם <strong>(כפי שתרצו שיופיע בתגובות)</strong>:
                        </label>
                        <input type="text" class="form-input" name="client_name" placeholder="לדוגמה: משה, דני הטכנאי, אליהו" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">2.</span>
                            כמה שנים העסק שלכם פעיל?
                        </label>
                        <input type="number" class="form-input" name="experience_years" placeholder="לדוגמה: 12" required min="1" max="50">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">3.</span>
                            מספר טלפון ליצירת קשר:
                        </label>
                        <input type="tel" class="form-input" name="phone_number" placeholder="לדוגמה: 050-1234567" required style="text-align: right;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">4.</span>
                            באילו אזורים אתם עובדים? <strong>(ניתן לבחור כמה אפשרויות)</strong>
                        </label>
                        
                        <div class="work-area-select-container">
                            <div class="work-area-select" id="workAreaSelect" tabindex="0">
                                <span class="work-area-placeholder">לחץ לבחירת אזורי עבודה</span>
                                <i class="fas fa-chevron-down work-area-arrow"></i>
                            </div>
                            <div id="workAreaDropdown" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 1px solid #e5e7eb; border-radius: 6px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1000; display: none; max-height: 300px; overflow-y: auto;"></div>
                        </div>
                        
                        <div class="work-area-tags" id="workAreaTags"></div>
                    </div>
                </div>

                <!-- תחומי פעילות והתמחויות -->
                <div class="form-section">
                    <h3>תחומי פעילות והתמחויות</h3>
                    <div class="section-description">
                        תחום ראשי - ההתמחויות תחתיו יקבלו את מירב הפניות (עדיפות ראשונה). התמחויות תחת תחומים נוספים יהיו בסדר עדיפות שני.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">5.</span>
                            תחומי פעילות והתמחויות:
                        </label>
                        
                        <div id="combinedSpecializationsContainer" style="position: relative;">
                            <div id="combinedSpecializationsDisplay" class="form-input" tabindex="0" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; position: relative; font-size: 14px;">
                                <span id="combinedSpecializationsPlaceholder" style="color: var(--text-muted);">לחצו לבחירת תחום ראשי והתמחויות</span>
                                <i class="fas fa-chevron-down" style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>
                            
                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" id="primaryFieldHidden" name="primary_field" required>
                        </div>
                        
                        <div class="business-benefits-tags" id="combinedSpecializationsTags" style="margin-top: 12px;"></div>
                        
                        <!-- Combined Specializations Popup Modal -->
                        <div id="combinedSpecializationsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 9999; overflow-y: auto;">
                            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                                <div id="combinedSpecializationsPopupContent" style="background: white; border-radius: var(--border-radius); border: 1px solid var(--border-light); max-width: 700px; width: 100%; max-height: 85vh; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                                    <!-- Popup Header -->
                                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--border-light);">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">בחירת תחום ראשי והתמחויות</h3>
                                            <button type="button" id="closeCombinedSpecializationsPopup" style="background: none; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">בחרו תחום ראשי (חובה) - ההתמחויות תחתיו יקבלו עדיפות ראשונה. התמחויות תחת תחומים נוספים יקבלו עדיפות שנייה.</p>
                                    </div>
                                    
                                    <!-- Search Section - Fixed -->
                                    <div id="combinedSearchSection" style="padding: 20px 20px 0 20px; border-bottom: 1px solid var(--border-light);">
                                        <div style="margin-bottom: 20px;">
                                            <input type="text" id="combinedSearchInput" placeholder="חיפוש תחומים והתמחויות..." 
                                                   style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 16px;">
                                        </div>
                                    </div>
                                    
                                    <!-- Popup Content - Scrollable -->
                                    <div id="combinedSpecializationsPopupBody" style="flex: 1; overflow-y: auto; min-height: 0;">
                                    </div>
                                    
                                    <!-- Popup Footer -->
                                    <div style="padding: 16px; border-top: 1px solid var(--border-light); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div id="selectedCombinedCount" style="color: var(--text-secondary); font-size: 14px;">יש לבחור תחום ראשי</div>
                                        <button type="button" id="saveCombinedSpecializations" style="background: var(--ai-purple); color: white; border: none; padding: 10px 12px; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; font-weight: 500; width: 120px;">שמור בחירות</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- יתרונות עסקיים -->
                <div class="form-section">
                    <h3>יתרונות עסקיים</h3>
                    <div class="section-description">
                        הוסיפו לפחות 4 יתרונות עסקיים שמייחדים אתכם מהמתחרים ומושכים לקוחות.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">6.</span>
                            בחרו יתרונות עסקיים <strong>(לפחות 4 יתרונות)</strong>
                        </label>
                        
                        <div id="businessBenefitsContainer" style="position: relative;">
                            <div id="businessBenefitsDisplay" class="form-input" tabindex="-1" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; position: relative; font-size: 14px;">
                                <span id="businessBenefitsPlaceholder" style="color: var(--text-muted);">לחצו לבחירת יתרונות עסקיים</span>
                                <i class="fas fa-chevron-down" style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>
                        </div>
                        
                        <!-- Business Benefits Popup Modal -->
                        <div id="businessBenefitsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 9999; overflow-y: auto;">
                            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                                <div id="businessBenefitsPopupContent" style="background: white; border-radius: var(--border-radius); border: 1px solid var(--border-light); max-width: 700px; width: 100%; max-height: 85vh; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                                    <!-- Popup Header -->
                                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--border-light);">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">בחירת יתרונות עסקיים</h3>
                                            <button type="button" class="popup-close" style="background: none; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">בחרו לפחות 4 יתרונות עסקיים שמייחדים אתכם מהמתחרים ומושכים לקוחות</p>
                                    </div>
                                    
                                    <!-- Popup Content - Scrollable -->
                                    <div id="businessBenefitsPopupBody" style="flex: 1; overflow-y: auto; min-height: 0;">
                                    </div>
                                    
                                    <!-- Popup Footer -->
                                    <div style="padding: 16px; border-top: 1px solid var(--border-light); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div id="selectedBusinessBenefitsCount" style="color: var(--text-secondary); font-size: 14px;">לא נבחרו יתרונות</div>
                                        <button type="button" id="saveBusinessBenefits" style="background: var(--ai-purple); color: white; border: none; padding: 10px 12px; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; font-weight: 500; width: 120px;">שמור בחירות</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="business-benefits-tags" id="businessBenefitsTags" style="margin-top: 12px;"></div>
                    </div>
                </div>



                <!-- הגדרות מיוחדות -->
                <div class="form-section">
                    <h3>הגדרות מיוחדות</h3>
                    <div class="section-description">
                        הגדירו נושאים להימנעות בתגובות. זה שומר על מקצועיות ומתאים לפרופיל שלכם. אם אין לכם הגבלות מיוחדות, דלגו על השאלה.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">7.</span>
                            יש נושאים שאתם מעדיפים להימנע מהם בתגובות? <strong>(עד 5 נושאים)</strong>
                        </label>
                        
                        <div id="restrictionsContainer" style="position: relative;">
                            <div id="restrictionsDisplay" class="form-input" tabindex="-1" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; position: relative; font-size: 14px;">
                                <span id="restrictionsPlaceholder" style="color: var(--text-muted);">לחצו לבחירת נושאים להימנעות</span>
                                <i class="fas fa-chevron-down" style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>
                        </div>
                        
                        <!-- Restrictions Popup Modal -->
                        <div id="restrictionsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 9999; overflow-y: auto;">
                            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                                <div id="restrictionsPopupContent" style="background: white; border-radius: var(--border-radius); border: 1px solid var(--border-light); max-width: 700px; width: 100%; max-height: 85vh; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                                    <!-- Popup Header -->
                                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--border-light);">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">בחירת נושאים להימנעות</h3>
                                            <button type="button" class="popup-close" style="background: none; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">בחרו עד 5 נושאים שאתם מעדיפים להימנע מהם בתגובות</p>
                                    </div>
                                    
                                    <!-- Popup Content - Scrollable -->
                                    <div id="restrictionsPopupBody" style="flex: 1; overflow-y: auto; min-height: 0;">
                                    </div>
                                    
                                    <!-- Popup Footer -->
                                    <div style="padding: 16px; border-top: 1px solid var(--border-light); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div id="selectedRestrictionsCount" style="color: var(--text-secondary); font-size: 14px;">לא נבחרו הגבלות</div>
                                        <button type="button" id="saveRestrictions" style="background: var(--ai-purple); color: white; border: none; padding: 10px 12px; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; font-weight: 500; width: 120px;">שמור בחירות</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="restriction-tags" id="restrictionTags"></div>

                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">8.</span>
                            הערות נוספות או בקשות מיוחדות:
                        </label>
                        <textarea class="form-input form-textarea" name="additional_notes" placeholder="כל מידע נוסף שחשוב לכם שנדע..."></textarea>
                    </div>
                </div>

                <!-- Live Preview Section -->
                <div class="form-section" id="livePreviewSection" style="display: block;">
                    <h3 style="text-align: center; margin-top: 0;">תצוגה מקדימה - איך הסוכן שלך יגיב לפוסטים</h3>
                    <h4 style="text-align: center; color: var(--text-secondary); font-weight: 400; margin-top: 8px; margin-bottom: 20px;">לפני שליחת הטופס, בואו נראה איך הסוכן שלך יגיב לפוסטים דומים בתחום שלך</h4>
                    
                    <button type="button" id="generatePreviewBtn" class="preview-btn" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 20px auto 0 auto; display: block;">
                        🚀 תראה לי איך הסוכן שלי מגיב לפוסטים
                    </button>
                    
                    <div id="previewContainer" style="display: none;">
                        <div id="previewLoading" style="text-align: center; padding: 20px; display: none;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: #6b7280;">יוצר דוגמאות פוסטים ותשובות...</p>
                        </div>
                        
                        <!-- API Status Indicator -->
                        <div id="apiStatusIndicator" class="api-status-indicator">
                            <strong>📡 מצב דמו:</strong> אין חיבור לשרת AI - התגובות שמוצגות הן לדוגמה בלבד
                        </div>
                        
                        <div id="previewResults"></div>
                    </div>
                </div>

                <button type="submit" id="submitBtn">שלח טופס</button>
            </form>

            <div class="footer-info">
                ✅ בסיום המילוי, הטופס יישלח אלינו אוטומטית.<br>
                ⏰ תהליך הכנת המערכת לוקח 24-48 שעות לאחר קבלת הטופס המלא.
                <div class="brand">
                    תודה רבה על הסבלנות! 🙏<br>
                    צוות Collabo AI
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to format links in text
        function formatLinksInText(text) {
            if (!text) return text;
            
            
            // Convert line breaks to <br> tags first
            let formattedText = text.replace(/\n/g, '<br>');
            
            // Remove automatic period line breaks - handle manually by content structure
            
            // Convert WhatsApp URLs to clickable links - more aggressive regex
            const whatsappRegex = /(https:\/\/wa\.me\/[^\s<>\n]+)/g;
            const matches = formattedText.match(whatsappRegex);
            
            if (matches) {
                matches.forEach(match => {
                    const clickableLink = `<br><a href="${match}" target="_blank" rel="noopener noreferrer" style="color: #25d366; text-decoration: none; font-weight: 500; display: block; margin-top: 8px; direction: ltr;">${match}</a>`;
                    formattedText = formattedText.replace(match, clickableLink);
                });
            }
            
            return formattedText;
        }

        // API Configuration
        const API_BASE_URL = 'https://worthy-choice-badger.ngrok-free.app';

        document.addEventListener('DOMContentLoaded', function() {
            // Load categories and subcategories from JSON
            let categoriesData = [];
            let professions = [];
            let specializations = {};
            
            // Embedded JSON data
            const embeddedCategoriesData = [
                {
                    "Category": "בנייה",
                    "Subcategories": [
                        {"Name": "עבודות שלד"},
                        {"Name": "עבודות גמר"},
                        {"Name": "עבודות עפר"},
                        {"Name": "עבודות פיתוח ותשתיות"},
                        {"Name": "הריסה ופינוי"}
                    ]
                },
                {
                    "Category": "שיפוצים",
                    "Subcategories": [
                        {"Name": "שיפוץ דירות/משרדים"}
                    ]
                },
                {
                    "Category": "ניקיון",
                    "Subcategories": [
                        {"Name": "ניקיון משרדים"},
                        {"Name": "ניקיון דירות לפני אכלוס"},
                        {"Name": "ניקיון דירות אחרי שיפוץ"},
                        {"Name": "ניקיון חדרי מדרגות"}
                    ]
                },
                {
                    "Category": "גינון",
                    "Subcategories": [
                        {"Name": "פיתוח גינות"},
                        {"Name": "אחזקת גינות"},
                        {"Name": "ניקיון גינות ופינוי פסולת"}
                    ]
                },
                {
                    "Category": "צילום",
                    "Subcategories": [
                        {"Name": "צילום אירועים פרטיים"},
                        {"Name": "צילום תדמית"},
                        {"Name": "צילום וידאו"},
                        {"Name": "עריכת תמונות וסרטונים"}
                    ]
                },
                {
                    "Category": "אינסטלציה",
                    "Subcategories": [
                        {"Name": "התקנת כלים סניטריים"},
                        {"Name": "איתור נזילות"},
                        {"Name": "תשתיות אינסטלציה"},
                        {"Name": "החלפת צנרת"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "חשמל",
                    "Subcategories": [
                        {"Name": "התקנת נקודות חשמל"},
                        {"Name": "לוחות חשמל"},
                        {"Name": "תשתיות חשמל"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "מיזוג אוויר",
                    "Subcategories": [
                        {"Name": "התקנת מזגנים"},
                        {"Name": "התקנת מיני מרכזי"},
                        {"Name": "ניקוי מזגנים"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "גבס",
                    "Subcategories": [
                        {"Name": "עבודות גבס"},
                        {"Name": "עבודות גבס גדולות"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "צבע",
                    "Subcategories": [
                        {"Name": "צביעת דירות / משרדים"},
                        {"Name": "עבודות צבע גדולות"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "טיח ושליכט",
                    "Subcategories": [
                        {"Name": "טיח חוץ / פנים"},
                        {"Name": "שליכט חיצוני"}
                    ]
                },
                {
                    "Category": "ריצוף וחיפוי",
                    "Subcategories": [
                        {"Name": "ריצוף פנים"},
                        {"Name": "ריצוף חוץ"},
                        {"Name": "חיפוי קירות"},
                        {"Name": "פרקטים"},
                        {"Name": "עבודות ריצוף גדולות"},
                        {"Name": "תיקונים כלליים"}
                    ]
                },
                {
                    "Category": "סוככים והצללות",
                    "Subcategories": [
                        {"Name": "סוכך זרועות"},
                        {"Name": "סוכך קבוע"},
                        {"Name": "רשתות הצללה"},
                        {"Name": "תיקונים ואחזקה"}
                    ]
                },
                {
                    "Category": "אלומיניום",
                    "Subcategories": [
                        {"Name": "פרגולה מאלומיניום"},
                        {"Name": "פרגולה חשמלית"},
                        {"Name": "שערים"},
                        {"Name": "גדרות"},
                        {"Name": "חלונות ודלתות"},
                        {"Name": "סגירת מרפסת"},
                        {"Name": "מעקות ומדרגות"},
                        {"Name": "תיקונים ואחזקה"}
                    ]
                },
                {
                    "Category": "חלונות וזגגות",
                    "Subcategories": [
                        {"Name": "התקנת זכוכיות ופתחים"},
                        {"Name": "החלפת זכוכית"},
                        {"Name": "סגירת חללים בזכוכית"},
                        {"Name": "תיקונים ואחזקה"}
                    ]
                },
                {
                    "Category": "עבודות עץ",
                    "Subcategories": [
                        {"Name": "פרגולה מעץ"},
                        {"Name": "דק עץ"},
                        {"Name": "גדרות מעץ"},
                        {"Name": "ריהוט חוץ מעץ"},
                        {"Name": "תיקונים ואחזקה"}
                    ]
                },
                {
                    "Category": "נגרות",
                    "Subcategories": [
                        {"Name": "מטבחים"},
                        {"Name": "ארונות"},
                        {"Name": "דלתות פנים"},
                        {"Name": "נגרות בהתאמה אישית"},
                        {"Name": "תיקונים ואחזקה"}
                    ]
                },
                {
                    "Category": "אדריכלות ועיצוב",
                    "Subcategories": [
                        {"Name": "אדריכלות ותכנון"},
                        {"Name": "עיצוב פנים"},
                        {"Name": "עיצוב גינות ונוף"},
                        {"Name": "עיצוב מסחרי"},
                        {"Name": "יעוץ עיצובי"}
                    ]
                }
            ];

            // Load JSON data
            async function loadCategoriesData() {
                try {
                    // Try to fetch from file first
                    const response = await fetch('clicknmove_bot.categories.json');
                    categoriesData = await response.json();
                    
                    // Extract categories for professions dropdown - only Category names
                    professions = categoriesData.map(item => item.Category);
                    
                    // Extract subcategories for specializations (question 5) - only Category and Name fields
                    specializations = {};
                    categoriesData.forEach(item => {
                        if (item.Subcategories && item.Subcategories.length > 0) {
                            specializations[item.Category] = item.Subcategories.map(sub => sub.Name);
                        }
                    });
                    
                    console.log('Categories loaded:', professions);
                    console.log('Specializations loaded:', specializations);
                } catch (error) {
                    console.log('Fetch failed, using embedded data:', error.message);
                    // Use embedded data when fetch fails
                    categoriesData = embeddedCategoriesData;
                    
                    // Extract categories for professions dropdown - only Category names
                    professions = categoriesData.map(item => item.Category);
                    
                    // Extract subcategories for specializations (question 5) - only Category and Name fields
                    specializations = {};
                    categoriesData.forEach(item => {
                        if (item.Subcategories && item.Subcategories.length > 0) {
                            specializations[item.Category] = item.Subcategories.map(sub => sub.Name);
                        }
                    });
                    
                    console.log('Using embedded categories:', professions);
                    console.log('Using embedded specializations:', specializations);
                }
            }
            
            // Combined specializations functionality (replaces old primary field + specializations)
            let selectedCombinedSpecializations = [];
            let primaryField = null;
            let additionalSpecializations = [];
            
            // Initialize combined specializations popup functionality
            function initializeCombinedSpecializationsPopup() {
                const display = document.getElementById('combinedSpecializationsDisplay');
                const popup = document.getElementById('combinedSpecializationsPopup');
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                const closeBtn = document.getElementById('closeCombinedSpecializationsPopup');
                const saveBtn = document.getElementById('saveCombinedSpecializations');
                const countDisplay = document.getElementById('selectedCombinedCount');
                
                if (!display || !popup || !popupBody) return;
                
                // Open popup on click
                display.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openCombinedSpecializationsPopup();
                });
                
                // Close popup handlers
                closeBtn?.addEventListener('click', closeCombinedSpecializationsPopup);
                popup.addEventListener('click', function(e) {
                    if (e.target === popup) {
                        closeCombinedSpecializationsPopup();
                    }
                });
                
                // Save selections handler
                saveBtn?.addEventListener('click', saveCombinedSpecializations);
            }
            
            function openCombinedSpecializationsPopup() {
                const popup = document.getElementById('combinedSpecializationsPopup');
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                
                if (!popup || !popupBody) return;
                
                // Build popup content
                buildCombinedPopupContent();
                
                // Show popup
                popup.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            function closeCombinedSpecializationsPopup() {
                const popup = document.getElementById('combinedSpecializationsPopup');
                if (!popup) return;
                
                popup.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function buildCombinedPopupContent() {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;
                
                popupBody.innerHTML = '';
                
                // Build categories and subcategories
                Object.keys(specializations).forEach(category => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.marginBottom = '24px';
                    categoryContainer.className = 'combined-category-container';
                    categoryContainer.dataset.categoryName = category;
                    
                    // Category header with primary option
                    const isPrimaryField = primaryField === category;
                    const categoryHeader = document.createElement('div');
                    categoryHeader.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: var(--bg-gray); border-radius: var(--border-radius); margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="font-weight: 600; font-size: 16px;">${category}</span>
                                ${isPrimaryField ? '<span style="color: #d97706; font-size: 12px;">🏆 תחום ראשי</span>' : ''}
                            </div>
                            <button type="button" class="set-primary-btn" data-category="${category}" 
                                    style="padding: 4px 8px; border: 1px solid ${isPrimaryField ? '#d97706' : 'var(--border-light)'}; 
                                           background: ${isPrimaryField ? '#fef3c7' : 'white'}; color: ${isPrimaryField ? '#d97706' : 'var(--text-primary)'}; 
                                           border-radius: 4px; font-size: 12px; cursor: pointer; width: 90px; white-space: nowrap; overflow: hidden; height: 32px;">
                                ${isPrimaryField ? 'ראשי' : 'הפוך לראשי'}
                            </button>
                        </div>
                    `;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Add subcategories
                    if (specializations[category] && specializations[category].length > 0) {
                        const subcategoriesContainer = document.createElement('div');
                        subcategoriesContainer.style.paddingRight = '20px';
                        subcategoriesContainer.className = 'subcategories-list';

                        specializations[category].forEach(subcategory => {
                            const isSelected = additionalSpecializations.includes(subcategory);
                            const subcategoryDiv = document.createElement('div');
                            subcategoryDiv.className = 'subcategory-wrapper';
                            subcategoryDiv.dataset.subcategoryName = subcategory;
                            subcategoryDiv.innerHTML = `
                                <label class="subcategory-item" data-subcategory="${subcategory}">
                                    <input type="checkbox" class="popup-checkbox" ${isSelected ? 'checked' : ''} data-subcategory="${subcategory}">
                                    <span style="flex: 1; text-align: right; color: var(--text-primary); font-size: 16px;">${subcategory}</span>
                                </label>
                            `;
                            subcategoriesContainer.appendChild(subcategoryDiv);
                        });

                        categoryContainer.appendChild(subcategoriesContainer);
                    }
                    
                    popupBody.appendChild(categoryContainer);
                });
                
                // Add event listeners
                addCombinedPopupEventListeners();
                updateCombinedSelectionCount();
            }
            
            function addCombinedPopupEventListeners() {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;
                
                // Primary field buttons
                popupBody.querySelectorAll('.set-primary-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const category = this.dataset.category;
                        setPrimaryField(category);
                        buildCombinedPopupContent(); // Rebuild to update UI
                    });
                });
                
                // Subcategory selection - updated for checkbox inputs
                popupBody.querySelectorAll('.subcategory-item input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const subcategory = this.dataset.subcategory;

                        if (this.checked) {
                            if (!additionalSpecializations.includes(subcategory)) {
                                additionalSpecializations.push(subcategory);
                            }

                            // If no primary field is set, find which category this subcategory belongs to
                            // and set it as primary automatically (without auto-selecting all subs)
                            if (!primaryField) {
                                const categoryForSubcategory = findCategoryForSubcategory(subcategory);
                                if (categoryForSubcategory) {
                                    // Set primary field but don't auto-select all subs
                                    primaryField = categoryForSubcategory;
                                    const hiddenInput = document.getElementById('primaryFieldHidden');
                                    if (hiddenInput) {
                                        hiddenInput.value = categoryForSubcategory;
                                    }
                                    buildCombinedPopupContent(); // Rebuild to show new primary
                                    return; // Exit early since we rebuilt
                                }
                            }
                        } else {
                            const index = additionalSpecializations.indexOf(subcategory);
                            if (index >= 0) {
                                additionalSpecializations.splice(index, 1);
                            }

                            // Check if this was the last subcategory of the primary field
                            const primaryWasDeselected = checkAndDeselectPrimaryIfEmpty();

                            // If primary was deselected, update everything
                            if (primaryWasDeselected) {
                                updateCombinedDisplay(); // Update the main display
                                buildCombinedPopupContent(); // Rebuild popup UI
                                return; // Exit early since we rebuilt everything
                            }
                        }

                        updateCombinedSelectionCount();
                    });
                });
                
                // Search functionality
                const searchInput = document.getElementById('combinedSearchInput');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value;
                        filterCombinedCategories(searchTerm);
                    });
                    
                    // Prevent form submission on Enter key
                    searchInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            e.stopPropagation();
                            return false;
                        }
                    });
                }
            }
            
            function setPrimaryField(category) {
                primaryField = category;
                
                // Update hidden input
                const hiddenInput = document.getElementById('primaryFieldHidden');
                if (hiddenInput) {
                    hiddenInput.value = category;
                }
                
                // Auto-select all subcategories under the selected primary field
                autoSelectSubcategoriesForPrimary(category);
                
                updateCombinedSelectionCount();
            }
            
            function autoSelectSubcategoriesForPrimary(category) {
                // Clear current additional specializations first
                additionalSpecializations = [];

                // Add all subcategories of the selected primary field to additional specializations
                if (specializations[category] && Array.isArray(specializations[category])) {
                    specializations[category].forEach(subcategory => {
                        if (!additionalSpecializations.includes(subcategory)) {
                            additionalSpecializations.push(subcategory);
                        }
                    });
                }
            }

            function findCategoryForSubcategory(subcategory) {
                // Search through all categories to find which one contains this subcategory
                for (const category in specializations) {
                    if (specializations[category] && specializations[category].includes(subcategory)) {
                        return category;
                    }
                }
                return null;
            }

            // Make it globally accessible
            window.findCategoryForSubcategory = findCategoryForSubcategory;

            function buildCategoriesHierarchy() {
                // Build hierarchical structure of categories and their selected subcategories
                const hierarchy = {};

                // Go through all selected subcategories and group them by category
                additionalSpecializations.forEach(subcategory => {
                    const category = findCategoryForSubcategory(subcategory);
                    if (category) {
                        if (!hierarchy[category]) {
                            hierarchy[category] = [];
                        }
                        hierarchy[category].push(subcategory);
                    }
                });

                return hierarchy;
            }

            // Make it globally accessible
            window.buildCategoriesHierarchy = buildCategoriesHierarchy;

            function checkAndDeselectPrimaryIfEmpty() {
                // If there's no primary field set, nothing to check
                if (!primaryField) return false;

                // Get all subcategories that belong to the primary field
                const primaryFieldSubcategories = specializations[primaryField] || [];

                // Check if any subcategory from the primary field is still selected
                const hasAnyPrimarySubcategory = primaryFieldSubcategories.some(sub =>
                    additionalSpecializations.includes(sub)
                );

                // If no subcategories from primary field are selected, deselect the primary field
                if (!hasAnyPrimarySubcategory) {
                    primaryField = null;
                    const hiddenInput = document.getElementById('primaryFieldHidden');
                    if (hiddenInput) {
                        hiddenInput.value = '';
                    }
                    return true; // Primary field was deselected
                }

                return false; // Primary field still has subcategories
            }
            
            function toggleAdditionalSpecialization(subcategory) {
                const index = additionalSpecializations.indexOf(subcategory);
                if (index > -1) {
                    additionalSpecializations.splice(index, 1);
                } else {
                    additionalSpecializations.push(subcategory);
                }
            }
            
            function updateCombinedSelectionCount() {
                const countDisplay = document.getElementById('selectedCombinedCount');
                if (!countDisplay) return;
                
                const primaryCount = primaryField ? 1 : 0;
                const additionalCount = additionalSpecializations.length;
                
                if (primaryCount === 0) {
                    countDisplay.textContent = 'יש לבחור תחום ראשי';
                    countDisplay.style.color = '#dc2626';
                } else if (additionalCount === 0) {
                    countDisplay.textContent = `תחום ראשי: ${primaryField}`;
                    countDisplay.style.color = 'var(--text-secondary)';
                } else {
                    countDisplay.textContent = `תחום ראשי: ${primaryField} | התמחויות נוספות: ${additionalCount}`;
                    countDisplay.style.color = 'var(--text-secondary)';
                }
            }
            
            function saveCombinedSpecializations() {
                if (!primaryField) {
                    alert('יש לבחור תחום פעילות ראשי');
                    return;
                }
                
                // Update the display
                updateCombinedDisplay();
                
                // Close popup
                closeCombinedSpecializationsPopup();
            }
            
            function updateCombinedDisplay() {
                const display = document.getElementById('combinedSpecializationsDisplay');
                const placeholder = document.getElementById('combinedSpecializationsPlaceholder');
                const tagsContainer = document.getElementById('combinedSpecializationsTags');
                
                if (!display || !placeholder || !tagsContainer) return;
                
                // Clear existing tags
                tagsContainer.innerHTML = '';
                
                // Placeholder always visible since tags are now below
                placeholder.style.display = 'inline';
                
                // Group specializations by category for organized display
                updateCombinedSpecializationsTags();
            }
            
            function updateCombinedSpecializationsTags() {
                const tagsContainer = document.getElementById('combinedSpecializationsTags');
                if (!tagsContainer) return;
                
                tagsContainer.innerHTML = '';
                
                // Group specializations by category
                const specializationsByCategory = {};
                
                // Add primary field
                if (primaryField) {
                    specializationsByCategory[primaryField] = [primaryField];
                }
                
                // Add additional specializations
                additionalSpecializations.forEach(spec => {
                    // Find which category this specialization belongs to
                    let categoryName = 'התמחויות נוספות'; // default category
                    
                    Object.keys(specializations).forEach(category => {
                        if (specializations[category] && specializations[category].includes(spec)) {
                            categoryName = category;
                        }
                    });
                    
                    // Don't add to primary field category if it's not the primary field itself
                    if (categoryName === primaryField && spec !== primaryField) {
                        if (!specializationsByCategory[categoryName]) {
                            specializationsByCategory[categoryName] = [];
                        }
                        specializationsByCategory[categoryName].push(spec);
                    } else if (categoryName !== primaryField) {
                        if (!specializationsByCategory[categoryName]) {
                            specializationsByCategory[categoryName] = [];
                        }
                        specializationsByCategory[categoryName].push(spec);
                    }
                });
                
                // Create display for each category - exactly like in question 6
                Object.keys(specializationsByCategory).forEach(categoryName => {
                    const items = specializationsByCategory[categoryName];
                    if (items.length === 0) return;
                    
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = 'margin-bottom: 20px;';
                    
                    // Create category header (only once per category) - same style as question 6
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 12px;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e7eb;
                    `;
                    
                    if (categoryName === primaryField) {
                        categoryHeader.innerHTML = `<span style="font-weight: 600;">🏆 ${categoryName} (תחום ראשי)</span> <span style="font-weight: 400;">- עדיפות ראשונה לקבלת לידים</span>`;
                    } else {
                        categoryHeader.innerHTML = `<span style="font-weight: 600;">${categoryName}</span> <span style="font-weight: 400;">- עדיפות שנייה לקבלת לידים</span>`;
                    }
                    
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Create tags container for this category
                    const tagsInCategory = document.createElement('div');
                    tagsInCategory.style.cssText = `
                        display: flex;
                        flex-wrap: wrap;
                        gap: 8px;
                    `;
                    
                    items.forEach(item => {
                        const tag = document.createElement('div');
                        tag.className = item === primaryField ? 'work-area-tag primary-tag' : 'work-area-tag additional-tag';
                        
                        if (item === primaryField) {
                            tag.innerHTML = `
                                <span>${item}</span>
                                <span class="remove-tag" onclick="removePrimaryField()">&times;</span>
                            `;
                        } else {
                            tag.innerHTML = `
                                <span>${item}</span>
                                <span class="remove-tag" onclick="removeAdditionalSpecialization('${item}')">&times;</span>
                            `;
                        }
                        
                        tagsInCategory.appendChild(tag);
                    });
                    
                    categoryContainer.appendChild(tagsInCategory);
                    tagsContainer.appendChild(categoryContainer);
                });
            }
            
            function filterCombinedCategories(searchTerm) {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;

                // If search is empty, show everything
                if (!searchTerm || searchTerm.trim() === '') {
                    popupBody.querySelectorAll('.combined-category-container').forEach(container => {
                        container.style.display = 'block';
                        container.querySelectorAll('.subcategory-wrapper').forEach(sub => {
                            sub.style.display = 'block';
                        });
                    });
                    return;
                }

                const normalizedSearch = searchTerm.toLowerCase().trim();

                // Search through each category
                popupBody.querySelectorAll('.combined-category-container').forEach(categoryContainer => {
                    const categoryName = categoryContainer.dataset.categoryName?.toLowerCase() || '';
                    const categoryMatches = categoryName.includes(normalizedSearch);

                    // Get all subcategory wrappers in this category
                    const subcategoryWrappers = categoryContainer.querySelectorAll('.subcategory-wrapper');
                    let hasVisibleSubcategory = false;

                    // Check each subcategory
                    subcategoryWrappers.forEach(subWrapper => {
                        const subcategoryName = subWrapper.dataset.subcategoryName?.toLowerCase() || '';
                        const subcategoryMatches = subcategoryName.includes(normalizedSearch);

                        // Show subcategory if it matches OR if the category matches
                        if (categoryMatches || subcategoryMatches) {
                            subWrapper.style.display = 'block';
                            hasVisibleSubcategory = true;
                        } else {
                            subWrapper.style.display = 'none';
                        }
                    });

                    // Show category if its name matches OR any subcategory is visible
                    if (categoryMatches || hasVisibleSubcategory) {
                        categoryContainer.style.display = 'block';
                    } else {
                        categoryContainer.style.display = 'none';
                    }
                });
            }
            
            // Global functions for removing tags
            window.removePrimaryField = function() {
                primaryField = null;
                const hiddenInput = document.getElementById('primaryFieldHidden');
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
                updateCombinedDisplay();
            };
            
            window.removeAdditionalSpecialization = function(spec) {
                const index = additionalSpecializations.indexOf(spec);
                if (index > -1) {
                    additionalSpecializations.splice(index, 1);
                }
                // Check if primary field should be deselected
                const primaryWasDeselected = checkAndDeselectPrimaryIfEmpty();

                // Update the display
                updateCombinedDisplay();

                // If popup is open and primary was deselected, rebuild it
                const popup = document.getElementById('combinedSpecializationsPopup');
                if (popup && popup.style.display === 'block' && primaryWasDeselected) {
                    buildCombinedPopupContent();
                }
            };

            // Load categories data on page load
            loadCategoriesData().then(() => {
                console.log('Categories and specializations loaded successfully');
                // Initialize the new combined specializations popup
                setTimeout(() => {
                    initializeCombinedSpecializationsPopup();
                }, 100);
            });

            // Old code removed - replaced with combined specializations functionality
            
            // Commented out old primary field code
            /*
            let currentFocus = -1;

            primaryFieldInput.addEventListener('input', function() {
                const value = this.value;
                if (value.length === 0) {
                    dropdownList.style.display = 'none';
                    updateSpecializationsPlaceholder(); // Update specializations when field cleared
                    return;
                }

                const filtered = professions.filter(profession => 
                    profession.includes(value)
                ); // Show all matching results

                if (filtered.length === 0) {
                    dropdownList.style.display = 'none';
                    return;
                }

                dropdownList.innerHTML = '';
                filtered.forEach((profession, index) => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; text-align: right; transition: background-color 0.2s ease; height: 48px; display: flex; align-items: center;';
                    item.textContent = profession;
                    item.addEventListener('click', function() {
                        primaryFieldInput.value = profession;
                        dropdownList.style.display = 'none';
                        currentFocus = -1;
                        updateSpecializationsPlaceholder(); // Update specializations when field selected
                    });
                    dropdownList.appendChild(item);
                });

                dropdownList.style.display = 'block';
                currentFocus = -1;
            });

            primaryFieldInput.addEventListener('focus', function() {
                if (this.value.length === 0) {
                    // Show all professions when focused with empty input
                    dropdownList.innerHTML = '';
                    professions.forEach((profession, index) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; text-align: right; transition: background-color 0.2s ease; height: 48px; display: flex; align-items: center;';
                        item.textContent = profession;
                        item.addEventListener('click', function() {
                            primaryFieldInput.value = profession;
                            dropdownList.style.display = 'none';
                            currentFocus = -1;
                        });
                        dropdownList.appendChild(item);
                    });
                    dropdownList.style.display = 'block';
                }
            });

            primaryFieldInput.addEventListener('keydown', function(e) {
                const items = dropdownList.children;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActiveItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActiveItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdownList.style.display = 'none';
                    currentFocus = -1;
                }
            });

            function setActiveItem(items) {
                for (let i = 0; i < items.length; i++) {
                    if (i === currentFocus) {
                        items[i].style.backgroundColor = 'rgba(76, 29, 149, 0.1)';
                        items[i].style.color = 'rgba(76, 29, 149, 0.8)';
                    } else {
                        items[i].style.backgroundColor = '';
                        items[i].style.color = '';
                    }
                }
            }

            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!primaryFieldInput.contains(e.target) && !dropdownList.contains(e.target)) {
                    dropdownList.style.display = 'none';
                    currentFocus = -1;
                }
            });
            */


            // Handle radio button and checkbox styling
            const radioItems = document.querySelectorAll('.radio-item');
            radioItems.forEach(item => {
                const input = item.querySelector('input[type="radio"], input[type="checkbox"]');
                if (input) {
                    input.addEventListener('change', function() {
                        if (input.type === 'radio') {
                            // Remove selected class from all radio buttons with same name
                            const radioGroup = document.querySelectorAll(`input[name="${input.name}"]`);
                            radioGroup.forEach(radio => {
                                radio.closest('.radio-item').classList.remove('selected');
                            });
                        }
                        
                        if (this.checked) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }



                    });
                }
            });

            // Business Benefits popup functionality
            const businessBenefitsCategories = {
                'שירות ומחירים': [
                    'הצעת מחיר מפורטת ללא התחייבות',
                    'המלצות חמות מלקוחות קיימים',
                    'ביקור ראשוני להערכת העבודה ללא תשלום',
                    'מחירים הוגנים ושקופים',
                    'יחס איכות-מחיר מעולה',
                    'תשלום מותאם לתקציב הלקוח',
                    'ללא עלויות נסתרות'
                ],
                'זמינות וגמישות': [
                    'זמינות מיידית לקריאות דחופות',
                    'שירות מהיר ואמין בכל שעה',
                    'תגובה מהירה לפניות ושאלות',
                    'גמישות מלאה בתיאום זמנים',
                    'אפשרות עבודה בסופי שבוע וחגים',
                    'התאמה ללוחות זמנים צמודים',
                    'זמינות לייעוץ וקבלת הנחיות'
                ],
                'ניסיון ומקצועיות': [
                    'ניסיון מוכח של שנים בתחום',
                    'צוות עובדים מקצועי ומיומן',
                    'שימוש בציוד מתקדם ואיכותי',
                    'עובדים קבועים עם ניסיון רב',
                    'מומחיות בפתרון בעיות מורכבות',
                    'השתלמויות מקצועיות שוטפות',
                    'הסמכות ורישיונות מקצועיים'
                ],
                'איכות ושירות': [
                    'ביצוע עבודה נקייה ומסודרת',
                    'שימוש בחומרים ורכיבים איכותיים בלבד',
                    'ניקיון יסודי של אתר העבודה בסיום',
                    'התחייבות מלאה לשביעות רצון הלקוח',
                    'שירות לקוחות אדיב ומקצועי',
                    'דיווח שוטף על התקדמות העבודה',
                    'אחריות מלאה על איכות הביצוע'
                ],
                'יעוץ ופתרונות': [
                    'ייעוץ מקצועי חינם לפני תחילת העבודה',
                    'פתרונות חכמים ויעילים לכל בעיה',
                    'התאמה אישית לצרכים הספציפיים',
                    'בדיקה ותכנון מקיפים מראש',
                    'הצעת חלופות וחיסכון בעלויות',
                    'ליווי וטיפול לאורך כל הפרויקט',
                    'שירות לאחר מכירה ותמיכה שוטפת'
                ]
            };

            // Business benefits functionality
            const minBusinessBenefits = 4;
            let selectedBusinessBenefits = [];
            
            const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
            const businessBenefitsPopup = document.getElementById('businessBenefitsPopup');
            const businessBenefitsPopupBody = document.getElementById('businessBenefitsPopupBody');
            const businessBenefitsPlaceholder = document.getElementById('businessBenefitsPlaceholder');

            // Specializations functionality
            const specializationsDisplay = document.getElementById('specializationsDisplay');
            const specializationsPopup = document.getElementById('specializationsPopup');
            const specializationsPopupBody = document.getElementById('specializationsPopupBody');
            const specializationsPlaceholder = document.getElementById('specializationsPlaceholder');

            function initializeBusinessBenefitsPopup() {
                if (!businessBenefitsPopupBody) {
                    console.error('businessBenefitsPopupBody element not found!');
                    return;
                }
                businessBenefitsPopupBody.innerHTML = '';
                
                
                // Add custom option input
                const customInputContainer = document.createElement('div');
                customInputContainer.style.cssText = 'padding: 16px 24px; border-bottom: 1px solid var(--border-light);';
                customInputContainer.innerHTML = `
                    <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 8px; font-size: 14px;">✨ הוסף יתרון בשפה חופשית</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" placeholder="לדוגמה: מחזיר טלפונים תמיד..." style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 14px; text-align: right;" id="customBusinessBenefitInput">
                        <button type="button" style="background: var(--ai-purple); color: white; border: none; padding: 10px 16px; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; font-size: 14px; white-space: nowrap;" id="addCustomBusinessBenefit">הוסף</button>
                    </div>
                `;
                businessBenefitsPopupBody.appendChild(customInputContainer);
                
                // Add categories
                Object.entries(businessBenefitsCategories).forEach(([category, benefits]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-div';
                    categoryDiv.style.cssText = 'border-bottom: 1px solid var(--border-light);';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = 'padding: 16px 24px; background: var(--bg-gray); font-weight: 600; color: var(--text-primary); font-size: 16px; border-bottom: 1px solid var(--border-light);';
                    categoryHeader.textContent = category;
                    categoryDiv.appendChild(categoryHeader);
                    
                    benefits.forEach(benefit => {
                        const isSelected = selectedBusinessBenefits.find(b => b.text === benefit);
                        const benefitItem = document.createElement('label');
                        benefitItem.className = 'benefit-item';
                        /* Styling handled by CSS class */
                        benefitItem.innerHTML = `
                            <input type="checkbox" class="popup-checkbox" ${isSelected ? 'checked' : ''} data-benefit="${benefit}" data-category="${category}">
                            <span style="flex: 1; text-align: right; color: var(--text-primary); font-size: 16px;">${benefit}</span>
                        `;
                        categoryDiv.appendChild(benefitItem);
                    });
                    
                    businessBenefitsPopupBody.appendChild(categoryDiv);
                });
                
                // Add event listeners
                const customInput = document.getElementById('customBusinessBenefitInput');
                const addBtn = document.getElementById('addCustomBusinessBenefit');
                
                // Custom input functionality
                function addCustomBenefit() {
                    const customValue = customInput.value.trim();
                    if (customValue && !selectedBusinessBenefits.find(b => b.text === customValue)) {
                        selectedBusinessBenefits.push({
                            id: Date.now(),
                            text: customValue,
                            category: 'יתרון מותאם אישית',
                            isCustom: true
                        });
                        updateBusinessBenefitsDisplay();
                        updateBusinessBenefitsCounter();
                        customInput.value = '';
                        closeBusinessBenefitsPopup();
                    }
                }
                
                addBtn.addEventListener('click', addCustomBenefit);
                customInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomBenefit();
                    }
                });
                
                // Checkbox functionality
                businessBenefitsPopupBody.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        const benefit = e.target.dataset.benefit;
                        const category = e.target.dataset.category;
                        const existingIndex = selectedBusinessBenefits.findIndex(b => b.text === benefit);
                        
                        if (e.target.checked && existingIndex === -1) {
                            selectedBusinessBenefits.push({
                                id: Date.now(),
                                text: benefit,
                                category: category,
                                isCustom: false
                            });
                        } else if (!e.target.checked && existingIndex >= 0) {
                            selectedBusinessBenefits.splice(existingIndex, 1);
                        }
                        
                        updateBusinessBenefitsDisplay();
                        updateBusinessBenefitsCounter();
                    }
                });
            }

            function updateBusinessBenefitsDisplay() {
                // Clear current display
                businessBenefitsDisplay.innerHTML = '';
                
                if (selectedBusinessBenefits.length === 0) {
                    businessBenefitsDisplay.appendChild(businessBenefitsPlaceholder);
                } else {
                    const countSpan = document.createElement('span');
                    const remainingNeeded = Math.max(0, minBusinessBenefits - selectedBusinessBenefits.length);
                    if (remainingNeeded > 0) {
                        countSpan.textContent = `נבחרו ${selectedBusinessBenefits.length} יתרונות (נדרש עוד ${remainingNeeded})`;
                        countSpan.style.color = '#dc2626';
                    } else {
                        countSpan.textContent = `נבחרו ${selectedBusinessBenefits.length} יתרונות`;
                        countSpan.style.color = '#059669';
                    }
                    businessBenefitsDisplay.appendChild(countSpan);
                }
                
                // Add chevron
                const chevron = document.createElement('i');
                chevron.className = 'fas fa-chevron-down';
                chevron.style.cssText = 'position: absolute; left: 16px; top: 16px; color: var(--text-muted);';
                businessBenefitsDisplay.appendChild(chevron);
                
                // Update separate tags display
                updateBusinessBenefitsTags();
                
                // Sync form data - remove ALL existing business_benefits[] inputs first
                const form = document.querySelector('form');
                const existingInputs = form.querySelectorAll('input[name="business_benefits[]"]');
                existingInputs.forEach(input => input.remove());
                
                // Add hidden inputs for each selected benefit
                selectedBusinessBenefits.forEach((benefit, index) => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'business_benefits[]';
                    hiddenInput.value = benefit.text;
                    form.appendChild(hiddenInput);
                });
            }
            
            function updateBusinessBenefitsTags() {
                const businessBenefitsTags = document.getElementById('businessBenefitsTags');
                businessBenefitsTags.innerHTML = '';
                
                // Group benefits by category
                const benefitsByCategory = {};
                selectedBusinessBenefits.forEach(benefit => {
                    const categoryName = benefit.category || 'יתרון מותאם אישית';
                    if (!benefitsByCategory[categoryName]) {
                        benefitsByCategory[categoryName] = [];
                    }
                    benefitsByCategory[categoryName].push(benefit);
                });
                
                // Create display for each category
                Object.keys(benefitsByCategory).forEach(categoryName => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = 'margin-bottom: 20px;';
                    
                    // Create category header (only once per category)
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        font-weight: 600;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 12px;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e7eb;
                    `;
                    categoryHeader.textContent = categoryName;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Create input for each benefit in this category
                    benefitsByCategory[categoryName].forEach(benefit => {
                        const inputContainer = document.createElement('div');
                        inputContainer.style.cssText = 'position: relative; margin-bottom: 12px;';
                        
                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.value = benefit.text;
                        textInput.className = 'form-input business-benefit-input';
                        /* Styling handled by CSS class */
                        textInput.placeholder = 'הכנס את תיאור היתרון...';
                        
                        // Update benefit text when input changes
                        textInput.addEventListener('input', function() {
                            benefit.text = this.value.trim();
                        });
                        
                        // Create remove button
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '×';
                        removeBtn.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 12px;
                            transform: translateY(-50%);
                            background: none;
                            border: none;
                            font-size: 18px;
                            font-weight: bold;
                            color: #dc2626;
                            cursor: pointer;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background-color 0.2s;
                        `;
                        
                        removeBtn.addEventListener('click', function() {
                            selectedBusinessBenefits = selectedBusinessBenefits.filter(b => b.id !== benefit.id);
                            updateBusinessBenefitsDisplay();
                        });
                        
                        removeBtn.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                        });
                        
                        removeBtn.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = 'transparent';
                        });
                        
                        // Focus styling
                        textInput.addEventListener('focus', function() {
                            this.style.borderColor = 'var(--ai-purple)';
                            this.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.1)';
                        });
                        
                        textInput.addEventListener('blur', function() {
                            this.style.borderColor = 'var(--border-light)';
                            this.style.boxShadow = 'none';
                        });
                        
                        inputContainer.appendChild(textInput);
                        inputContainer.appendChild(removeBtn);
                        categoryContainer.appendChild(inputContainer);
                    });
                    
                    businessBenefitsTags.appendChild(categoryContainer);
                });
                
                // Validate minimum benefits
                const form = document.querySelector('.contact-form');
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        if (selectedBusinessBenefits.length < minBusinessBenefits) {
                            submitBtn.style.opacity = '0.6';
                            submitBtn.title = `נדרש לבחור לפחות ${minBusinessBenefits} יתרונות עסקיים`;
                        } else {
                            submitBtn.style.opacity = '1';
                            submitBtn.title = '';
                        }
                    }
                }
            }

            // Specializations popup functionality
            function initializeSpecializationsPopup() {
                if (!specializationsPopupBody) {
                    console.error('specializationsPopupBody element not found!');
                    return;
                }
                
                // Clear popup body
                specializationsPopupBody.innerHTML = '';
                
                // Get selected primary field from question 2
                const primaryFieldInput = document.querySelector('input[name="primary_field"]');
                const selectedPrimaryField = primaryFieldInput ? primaryFieldInput.value.trim() : '';
                
                // Check if primary field is selected
                if (!selectedPrimaryField) {
                    // Show warning message instead of popup
                    const warningContainer = document.createElement('div');
                    warningContainer.style.cssText = 'padding: 40px 24px; text-align: center; margin: 24px; border: 1px solid var(--border-light); border-radius: var(--border-radius); background: var(--bg-light);';
                    warningContainer.innerHTML = `
                        <div style="color: var(--text-primary); font-weight: 600; font-size: 18px; margin-bottom: 12px;">
                            ⚠️ יש לבחור תחום פעילות עיקרי קודם
                        </div>
                        <div style="color: var(--text-secondary); font-size: 16px; line-height: 1.5; margin-bottom: 20px;">
                            כדי לגשת להתמחויות נוספות, יש לבחור תחילה תחום פעילות עיקרי בשאלה 4
                        </div>
                        <button type="button" id="backToQuestion2Btn" style="background: var(--text-primary); color: white; border: none; padding: 12px 24px; border-radius: var(--border-radius); font-size: 16px; cursor: pointer; font-weight: 500;">
                            חזור לשאלה 4
                        </button>
                    `;
                    specializationsPopupBody.appendChild(warningContainer);
                    
                    // Add event listener to the button
                    const backBtn = document.getElementById('backToQuestion2Btn');
                    if (backBtn) {
                        backBtn.addEventListener('click', function() {
                            specializationsPopup.style.display = 'none';
                            document.getElementById('primaryFieldInput').scrollIntoView({ behavior: 'smooth' });
                            setTimeout(() => {
                                document.getElementById('primaryFieldInput').focus();
                            }, 500);
                        });
                    }
                    
                    return;
                }
                
                // Add search input at the top
                const searchContainer = document.createElement('div');
                searchContainer.style.cssText = 'padding: 20px 24px; border-bottom: 1px solid var(--border-light);';
                searchContainer.innerHTML = `
                    <input type="text" placeholder="חיפוש התמחויות..." style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 16px; text-align: right; background: var(--bg-light); color: var(--text-primary);" id="specializationsSearch">
                `;
                specializationsPopupBody.appendChild(searchContainer);
                
                // Show all categories but prioritize the selected primary field
                const allCategories = Object.keys(specializations);
                
                // Sort categories: primary field first, then alphabetically
                const sortedCategories = allCategories.sort((a, b) => {
                    if (a === selectedPrimaryField) return -1;
                    if (b === selectedPrimaryField) return 1;
                    return a.localeCompare(b, 'he');
                });
                
                sortedCategories.forEach(category => {
                    const isPrimaryField = category === selectedPrimaryField;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-div';
                    categoryDiv.style.cssText = 'border-bottom: 1px solid var(--border-light);';
                    
                    // Category header with checkbox to select all
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `padding: 16px 24px; background: var(--bg-gray); font-weight: 600; color: var(--text-primary); display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-light); ${isPrimaryField ? 'border-right: 3px solid var(--text-primary);' : ''}`;
                    
                    const allSelected = specializations[category].every(spec => 
                        selectedSpecializations.find(s => s.text === spec && s.category === category)
                    );
                    
                    if (isPrimaryField) {
                        categoryHeader.innerHTML = `
                            <div style="width: 100%; display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 16px; font-weight: 600;">🎯 ${category}</span>
                                    <span style="background: var(--text-muted); color: white; padding: 4px 8px; border-radius: var(--border-radius); font-size: 12px; font-weight: 400;">עיקרי</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 18px; height: 18px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; ${allSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                        ${allSelected ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                                    </div>
                                    <span style="font-size: 14px; color: var(--text-secondary);">בחירת הכל</span>
                                </div>
                            </div>
                        `;
                    } else {
                        categoryHeader.innerHTML = `
                            <div style="width: 18px; height: 18px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; margin-left: 16px; ${allSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                ${allSelected ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                            </div>
                            <span style="font-size: 16px;">${category} - בחירת הכל</span>
                        `;
                    }
                    
                    // Toggle all specializations in category
                    categoryHeader.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // Find the checkbox (different for primary vs regular categories)
                        let checkbox;
                        if (isPrimaryField) {
                            // In primary field, the checkbox is in the second div with the specific styling
                            const secondRow = this.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
                            if (secondRow) {
                                checkbox = secondRow.querySelector('div[style*="width: 18px"]');
                            }
                        } else {
                            // In regular categories, checkbox is the first div with width 18px
                            checkbox = this.querySelector('div[style*="width: 18px"]');
                        }
                        const isAllSelected = specializations[category].every(spec => 
                            selectedSpecializations.find(s => s.text === spec && s.category === category)
                        );
                        
                        if (isAllSelected) {
                            // Remove all from this category
                            selectedSpecializations = selectedSpecializations.filter(s => s.category !== category);
                        } else {
                            // Add all from this category
                            selectedSpecializations = selectedSpecializations.filter(s => s.category !== category);
                            specializations[category].forEach(spec => {
                                selectedSpecializations.push({
                                    id: Date.now() + Math.random(),
                                    text: spec,
                                    category: category,
                                    isCustom: false
                                });
                            });
                        }
                        
                        updateSpecializationsDisplay();
                        updateSpecializationsCheckboxes(); // Update checkboxes without recreating popup
                    });
                    
                    categoryDiv.appendChild(categoryHeader);
                    
                    
                    // Individual specializations
                    specializations[category].forEach(specialization => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 12px 24px; cursor: pointer; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px;';
                        
                        const isSelected = selectedSpecializations.find(s => s.text === specialization && s.category === category);
                        item.innerHTML = `
                            <div style="width: 16px; height: 16px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; ${isSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 9px;"></i>' : ''}
                            </div>
                            <span style="flex: 1; text-align: right; color: var(--text-primary);">${specialization}</span>
                        `;
                        
                        item.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const existingIndex = selectedSpecializations.findIndex(s => s.text === specialization && s.category === category);
                            
                            if (existingIndex >= 0) {
                                selectedSpecializations.splice(existingIndex, 1);
                            } else {
                                selectedSpecializations.push({
                                    id: Date.now(),
                                    text: specialization,
                                    category: category,
                                    isCustom: false
                                });
                            }
                            
                            updateSpecializationsDisplay();
                            updateSpecializationsCheckboxes(); // Update checkboxes without recreating popup
                        });
                        
                        item.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'var(--bg-gray)';
                        });
                        
                        item.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        categoryDiv.appendChild(item);
                    });
                    
                    specializationsPopupBody.appendChild(categoryDiv);
                });
                
                // Search functionality with autocomplete
                const searchInput = specializationsPopupBody.querySelector('#specializationsSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        
                        // If search is empty, show all
                        if (searchTerm === '') {
                            const categoryDivs = specializationsPopupBody.querySelectorAll('.category-div');
                            const items = specializationsPopupBody.querySelectorAll('div[style*="padding: 12px 24px"]');
                            categoryDivs.forEach(el => el.style.display = 'block');
                            items.forEach(el => el.style.display = 'flex');
                            return;
                        }
                        
                        // Find category divs (use class selector for reliability)
                        const categoryDivs = specializationsPopupBody.querySelectorAll('.category-div');
                        
                        categoryDivs.forEach(categoryDiv => {
                            // Get category name from header
                            const categoryHeader = categoryDiv.querySelector('div[style*="background: var(--bg-gray)"]');
                            let categoryName = '';
                            
                            if (categoryHeader) {
                                if (categoryHeader.textContent.includes('🎯')) {
                                    // Primary field - get name from first span
                                    const firstSpan = categoryHeader.querySelector('span');
                                    if (firstSpan) {
                                        categoryName = firstSpan.textContent.replace('🎯 ', '').toLowerCase();
                                    }
                                } else {
                                    // Regular category
                                    categoryName = categoryHeader.textContent.replace(' - בחירת הכל', '').toLowerCase();
                                }
                            }
                            
                            // Get specialization items in this category
                            const specializationItems = categoryDiv.querySelectorAll('div[style*="padding: 12px 24px"]');
                            let hasVisibleItems = false;
                            
                            // Check if category name matches (for showing whole category)
                            const categoryMatches = categoryName.includes(searchTerm);
                            
                            // Check each specialization item
                            specializationItems.forEach(item => {
                                const itemText = item.querySelector('span') ? item.querySelector('span').textContent.toLowerCase() : '';
                                const itemMatches = itemText.includes(searchTerm);
                                
                                if (categoryMatches || itemMatches) {
                                    item.style.display = 'flex';
                                    hasVisibleItems = true;
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                            
                            // Show/hide entire category based on matches
                            categoryDiv.style.display = hasVisibleItems || categoryMatches ? 'block' : 'none';
                        });
                    });
                }
                
                updateSpecializationsCounter();
            }
            
            // Function to update specializations counter in popup footer
            function updateSpecializationsCounter() {
                const counterElement = document.getElementById('selectedSpecializationsCount');
                if (counterElement) {
                    const count = selectedSpecializations.length;
                    if (count === 0) {
                        counterElement.textContent = 'לא נבחרו התמחויות';
                        counterElement.style.color = 'var(--text-secondary)';
                    } else {
                        counterElement.textContent = `נבחרו ${count} התמחויות`;
                        counterElement.style.color = 'var(--text-primary)';
                    }
                }
            }
            
            function updateBusinessBenefitsCounter() {
                const counterElement = document.getElementById('selectedBusinessBenefitsCount');
                if (counterElement) {
                    const count = selectedBusinessBenefits.length;
                    const remainingNeeded = Math.max(0, minBusinessBenefits - count);
                    
                    if (count === 0) {
                        counterElement.textContent = 'לא נבחרו יתרונות';
                        counterElement.style.color = 'var(--text-secondary)';
                    } else if (remainingNeeded > 0) {
                        counterElement.textContent = `נבחרו ${count} יתרונות (נדרש עוד ${remainingNeeded})`;
                        counterElement.style.color = '#dc2626';
                    } else {
                        counterElement.textContent = `נבחרו ${count} יתרונות`;
                        counterElement.style.color = '#059669';
                    }
                }
            }
            
            // Function to open business benefits popup
            function openBusinessBenefitsPopup() {
                initializeBusinessBenefitsPopup();
                businessBenefitsPopup.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            // Function to close business benefits popup
            function closeBusinessBenefitsPopup() {
                businessBenefitsPopup.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Function to update only checkboxes in the popup without recreating the whole content
            function updateSpecializationsCheckboxes() {
                const popupBody = document.getElementById('specializationsPopupBody');
                if (!popupBody) return;
                
                // Update category headers
                const categoryHeaders = popupBody.querySelectorAll('div[style*="background: var(--bg-gray)"]');
                categoryHeaders.forEach(header => {
                    // Check if this is a primary field (has emoji)
                    const isPrimaryField = header.textContent.includes('🎯');
                    let category;
                    
                    if (isPrimaryField) {
                        // For primary field, extract category from the first line
                        const firstLine = header.querySelector('span');
                        if (firstLine) {
                            category = firstLine.textContent.replace('🎯 ', '').trim();
                        }
                    } else {
                        // For regular categories
                        category = header.textContent.replace(' - בחירת הכל', '').trim();
                    }
                    
                    if (category && specializations[category]) {
                        const allSelected = specializations[category].every(spec => 
                            selectedSpecializations.find(s => s.text === spec && s.category === category)
                        );
                        
                        // Find the checkbox - different locations for primary vs regular
                        let checkbox;
                        if (isPrimaryField) {
                            // In primary field, checkbox is in the second row
                            const secondRow = header.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
                            if (secondRow) {
                                checkbox = secondRow.querySelector('div[style*="width: 18px"]');
                            }
                        } else {
                            // In regular categories, checkbox is in the main row
                            checkbox = header.querySelector('div[style*="width: 18px"]');
                        }
                        
                        if (checkbox) {
                            if (allSelected) {
                                checkbox.style.background = 'var(--text-primary)';
                                checkbox.style.borderColor = 'var(--text-primary)';
                                checkbox.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>';
                            } else {
                                checkbox.style.background = 'var(--bg-light)';
                                checkbox.style.borderColor = 'var(--border-light)';
                                checkbox.innerHTML = '';
                            }
                        }
                    }
                });
                
                // Update individual items
                const items = popupBody.querySelectorAll('div[style*="padding: 12px 24px"]');
                items.forEach(item => {
                    const text = item.querySelector('span').textContent;
                    const isSelected = selectedSpecializations.find(s => s.text === text);
                    const checkbox = item.querySelector('div[style*="width: 16px"]');
                    
                    if (checkbox) {
                        if (isSelected) {
                            checkbox.style.background = 'var(--text-primary)';
                            checkbox.style.borderColor = 'var(--text-primary)';
                            checkbox.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 9px;"></i>';
                        } else {
                            checkbox.style.background = 'var(--bg-light)';
                            checkbox.style.borderColor = 'var(--border-light)';
                            checkbox.innerHTML = '';
                        }
                    }
                });
                
                updateSpecializationsCounter();
            }
            
            // Function to open specializations popup
            function openSpecializationsPopup() {
                initializeSpecializationsPopup();
                specializationsPopup.style.display = 'block';
            }
            
            // Function to close specializations popup
            function closeSpecializationsPopup() {
                specializationsPopup.style.display = 'none';
            }
            
            // Make function globally accessible
            window.closeSpecializationsPopup = closeSpecializationsPopup;

            function updateSpecializationsDisplay() {
                // Clear current display
                specializationsDisplay.innerHTML = '';
                
                if (selectedSpecializations.length === 0) {
                    specializationsDisplay.appendChild(specializationsPlaceholder);
                } else {
                    const countSpan = document.createElement('span');
                    countSpan.textContent = `נבחרו ${selectedSpecializations.length} התמחויות נוספות`;
                    countSpan.style.color = '#059669';
                    specializationsDisplay.appendChild(countSpan);
                }
                
                // Add chevron
                const chevron = document.createElement('i');
                chevron.className = 'fas fa-chevron-down';
                chevron.style.cssText = 'position: absolute; left: 16px; top: 16px; color: var(--text-muted);';
                specializationsDisplay.appendChild(chevron);
                
                // Update separate tags display
                updateSpecializationsTags();

                // Note: We no longer create hidden inputs - the new system uses categories_hierarchy
            }

            function updateSpecializationsTags() {
                const specializationsTags = document.getElementById('specializationsTags');
                if (!specializationsTags) return;
                
                specializationsTags.innerHTML = '';
                
                if (selectedSpecializations.length === 0) return;
                
                // Group specializations by category
                const specializationsByCategory = {};
                selectedSpecializations.forEach(specialization => {
                    const categoryName = specialization.category || 'התמחויות מותאמות';
                    if (!specializationsByCategory[categoryName]) {
                        specializationsByCategory[categoryName] = [];
                    }
                    specializationsByCategory[categoryName].push(specialization);
                });
                
                // Create display for each category
                Object.keys(specializationsByCategory).forEach(categoryName => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = 'margin-bottom: 20px;';
                    
                    // Create category header
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        font-weight: 600;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 12px;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e7eb;
                    `;
                    categoryHeader.textContent = `${categoryName} (${specializationsByCategory[categoryName].length})`;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Create tags for each specialization in this category
                    specializationsByCategory[categoryName].forEach(specialization => {
                        const tagContainer = document.createElement('div');
                        tagContainer.style.cssText = 'display: inline-block; margin: 4px 8px 4px 0;';
                        
                        const tag = document.createElement('span');
                        tag.style.cssText = `
                            display: inline-flex;
                            align-items: center;
                            padding: 6px 12px;
                            background: ${specialization.isCustom ? '#f0f9ff' : '#f3f4f6'};
                            border: 1px solid ${specialization.isCustom ? '#0ea5e9' : '#d1d5db'};
                            border-radius: 20px;
                            font-size: 13px;
                            color: ${specialization.isCustom ? '#0c4a6e' : '#374151'};
                            gap: 8px;
                        `;
                        
                        tag.innerHTML = `
                            <span>${specialization.text}</span>
                            <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;" title="הסר התמחות"></i>
                        `;
                        
                        // Remove specialization on click
                        tag.querySelector('.fa-times').addEventListener('click', function() {
                            selectedSpecializations = selectedSpecializations.filter(s => s.id !== specialization.id);
                            updateSpecializationsDisplay();
                        });
                        
                        tagContainer.appendChild(tag);
                        categoryContainer.appendChild(tagContainer);
                    });
                    
                    specializationsTags.appendChild(categoryContainer);
                });
            }

            // Initialize with a small delay to ensure DOM is ready
            setTimeout(function() {
                initializeBusinessBenefitsPopup();
                updateSpecializationsPlaceholder();
            }, 100);

            // Handle popup toggle
            if (businessBenefitsDisplay && businessBenefitsPopup) {
                businessBenefitsDisplay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    openBusinessBenefitsPopup();
                });
            } else {
            }
            
            // Handle popup close
            if (businessBenefitsPopup) {
                const closeBtn = businessBenefitsPopup.querySelector('.popup-close');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeBusinessBenefitsPopup();
                    });
                }
                
                // Close popup when clicking outside
                businessBenefitsPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeBusinessBenefitsPopup();
                    }
                });
                
                // Save button functionality
                const saveBtn = document.getElementById('saveBusinessBenefits');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        updateBusinessBenefitsDisplay();
                        closeBusinessBenefitsPopup();
                    });
                }
            }

            // Function to update specializations placeholder based on primary field selection
            function updateSpecializationsPlaceholder() {
                const primaryFieldInput = document.querySelector('input[name="primary_field"]');
                const selectedPrimaryField = primaryFieldInput ? primaryFieldInput.value.trim() : '';
                const placeholder = document.getElementById('specializationsPlaceholder');
                
                if (placeholder) {
                    if (!selectedPrimaryField) {
                        placeholder.textContent = 'יש לבחור תחום פעילות עיקרי תחילה בשאלה 4';
                        placeholder.style.color = '#dc2626'; // Red color for warning
                    } else {
                        placeholder.textContent = 'לחצו לבחירת התמחויות נוספות';
                        placeholder.style.color = 'var(--text-muted)'; // Original color
                    }
                }
            }

            // Handle specializations popup toggle
            if (specializationsDisplay && specializationsPopup) {
                specializationsDisplay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    openSpecializationsPopup();
                });
            }
            
            // Popup event handlers
            if (specializationsPopup) {
                // Close popup when clicking on overlay
                specializationsPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeSpecializationsPopup();
                    }
                });
                
                // Close button
                const closeBtn = document.getElementById('closeSpecializationsPopup');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeSpecializationsPopup();
                    });
                }
            }


            // Restriction popup functionality
            const restrictionOptions = [
                'מחירים ספציפיים',
                'פרטים אישיים של לקוחות',
                'ביקורת על מתחרים',
                'נושאים פוליטיים',
                'מידע פיננסי',
                'עבודות שלא בתחום התמחות',
                'המלצות על חברות אחרות',
                'נושאי דת',
                'תלונות על לקוחות',
                'סודות מקצועיים'
            ];

            const restrictionsDisplay = document.getElementById('restrictionsDisplay');
            const restrictionsPopup = document.getElementById('restrictionsPopup');
            const restrictionsPopupBody = document.getElementById('restrictionsPopupBody');
            const restrictionsPlaceholder = document.getElementById('restrictionsPlaceholder');
            const restrictionTags = document.getElementById('restrictionTags');
            let selectedRestrictions = [];
            const maxRestrictions = 5;

            function initializeRestrictionsPopup() {
                if (!restrictionsPopupBody) {
                    console.error('restrictionsPopupBody element not found!');
                    return;
                }
                restrictionsPopupBody.innerHTML = '';
                
                // Add custom option input
                const customInputContainer = document.createElement('div');
                customInputContainer.style.cssText = 'padding: 16px 24px; border-bottom: 1px solid var(--border-light);';
                customInputContainer.innerHTML = `
                    <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 8px; font-size: 14px;">✨ הוסף נושא בשפה חופשית</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" placeholder="לדוגמה: לא לדבר על פרויקטים ישנים..." style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 14px; text-align: right;" id="customRestrictionInput">
                        <button type="button" style="background: var(--ai-purple); color: white; border: none; padding: 10px 16px; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; font-size: 14px; white-space: nowrap;" id="addCustomRestriction">הוסף</button>
                    </div>
                `;
                restrictionsPopupBody.appendChild(customInputContainer);
                
                // Add predefined options
                const restrictionsContainer = document.createElement('div');
                restrictionsContainer.style.cssText = 'border-bottom: 1px solid var(--border-light);';
                
                const restrictionsHeader = document.createElement('div');
                restrictionsHeader.style.cssText = 'padding: 16px 24px; background: var(--bg-gray); font-weight: 600; color: var(--text-primary); font-size: 16px; border-bottom: 1px solid var(--border-light);';
                restrictionsHeader.textContent = 'נושאים נפוצים להימנעות';
                restrictionsContainer.appendChild(restrictionsHeader);
                
                restrictionOptions.forEach(option => {
                    const isSelected = selectedRestrictions.includes(option);
                    const restrictionItem = document.createElement('label');
                    restrictionItem.className = 'restriction-item';
                    /* Styling handled by CSS class */
                    restrictionItem.innerHTML = `
                        <input type="checkbox" class="popup-checkbox" ${isSelected ? 'checked' : ''} data-restriction="${option}">
                        <span style="flex: 1; text-align: right; color: var(--text-primary); font-size: 16px;">${option}</span>
                    `;
                    restrictionsContainer.appendChild(restrictionItem);
                });
                
                restrictionsPopupBody.appendChild(restrictionsContainer);
                
                // Add event listeners
                const customInput = document.getElementById('customRestrictionInput');
                const addBtn = document.getElementById('addCustomRestriction');
                
                // Custom input functionality
                function addCustomRestriction() {
                    const customValue = customInput.value.trim();
                    if (customValue && !selectedRestrictions.includes(customValue) && selectedRestrictions.length < maxRestrictions) {
                        selectedRestrictions.push(customValue);
                        updateRestrictionsDisplay();
                        updateRestrictionsCounter();
                        customInput.value = '';
                        closeRestrictionsPopup();
                    }
                }
                
                addBtn.addEventListener('click', addCustomRestriction);
                customInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomRestriction();
                    }
                });
                
                // Checkbox functionality
                restrictionsPopupBody.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        const restriction = e.target.dataset.restriction;
                        const existingIndex = selectedRestrictions.indexOf(restriction);
                        
                        if (e.target.checked && existingIndex === -1 && selectedRestrictions.length < maxRestrictions) {
                            selectedRestrictions.push(restriction);
                        } else if (!e.target.checked && existingIndex >= 0) {
                            selectedRestrictions.splice(existingIndex, 1);
                        }
                        
                        updateRestrictionsDisplay();
                        updateRestrictionsCounter();
                    }
                });
            }

            function updateRestrictionsDisplay() {
                // Clear current display
                restrictionsDisplay.innerHTML = '';
                
                if (selectedRestrictions.length === 0) {
                    restrictionsDisplay.appendChild(restrictionsPlaceholder);
                } else {
                    const countSpan = document.createElement('span');
                    const remainingNeeded = Math.max(0, maxRestrictions - selectedRestrictions.length);
                    if (remainingNeeded > 0) {
                        countSpan.textContent = `נבחרו ${selectedRestrictions.length} הגבלות (ניתן עוד ${remainingNeeded})`;
                        countSpan.style.color = 'var(--text-primary)';
                    } else {
                        countSpan.textContent = `נבחרו ${selectedRestrictions.length} הגבלות (מקסימום)`;
                        countSpan.style.color = '#059669';
                    }
                    restrictionsDisplay.appendChild(countSpan);
                }
                
                // Add chevron
                const chevron = document.createElement('i');
                chevron.className = 'fas fa-chevron-down';
                chevron.style.cssText = 'position: absolute; left: 16px; top: 16px; color: var(--text-muted);';
                restrictionsDisplay.appendChild(chevron);
                
                // Update separate tags display
                updateRestrictionTags();
            }

            function updateRestrictionTags() {
                // Clear current display
                restrictionTags.innerHTML = '';
                
                if (selectedRestrictions.length > 0) {
                    selectedRestrictions.forEach((restriction, index) => {
                        const inputContainer = document.createElement('div');
                        inputContainer.style.cssText = 'position: relative; margin-bottom: 12px; width: 100%;';
                        
                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.value = restriction;
                        textInput.name = 'restrictions[]';
                        textInput.className = 'form-input restriction-input';
                        /* Styling handled by CSS class */
                        textInput.placeholder = 'הכנס את תיאור ההגבלה...';
                        
                        // Update restriction text when input changes
                        textInput.addEventListener('input', function() {
                            selectedRestrictions[index] = this.value.trim();
                        });
                        
                        textInput.addEventListener('focus', function() {
                            this.style.borderColor = 'var(--ai-purple)';
                            this.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.1)';
                        });
                        
                        textInput.addEventListener('blur', function() {
                            this.style.borderColor = 'var(--border-light)';
                            this.style.boxShadow = 'none';
                        });
                        
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '×';
                        removeBtn.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 12px;
                            transform: translateY(-50%);
                            background: none;
                            border: none;
                            font-size: 18px;
                            font-weight: bold;
                            color: #dc2626;
                            cursor: pointer;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background-color 0.2s;
                        `;
                        
                        removeBtn.addEventListener('click', function() {
                            selectedRestrictions = selectedRestrictions.filter((_, i) => i !== index);
                            updateRestrictionsDisplay();
                            updateRestrictionsCounter();
                        });
                        
                        removeBtn.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                        });
                        
                        removeBtn.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = 'transparent';
                        });
                        
                        inputContainer.appendChild(textInput);
                        inputContainer.appendChild(removeBtn);
                        restrictionTags.appendChild(inputContainer);
                    });
                }
            }

            function updateRestrictionsCounter() {
                const counterElement = document.getElementById('selectedRestrictionsCount');
                if (counterElement) {
                    const count = selectedRestrictions.length;
                    const remainingAllowed = Math.max(0, maxRestrictions - count);
                    
                    if (count === 0) {
                        counterElement.textContent = 'לא נבחרו הגבלות';
                        counterElement.style.color = 'var(--text-secondary)';
                    } else if (remainingAllowed > 0) {
                        counterElement.textContent = `נבחרו ${count} הגבלות (ניתן עוד ${remainingAllowed})`;
                        counterElement.style.color = 'var(--text-primary)';
                    } else {
                        counterElement.textContent = `נבחרו ${count} הגבלות (מקסימום)`;
                        counterElement.style.color = '#059669';
                    }
                }
            }
            
            // Function to open restrictions popup
            function openRestrictionsPopup() {
                initializeRestrictionsPopup();
                restrictionsPopup.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            // Function to close restrictions popup
            function closeRestrictionsPopup() {
                restrictionsPopup.style.display = 'none';
                document.body.style.overflow = '';
            }

            // Initialize restrictions popup in a timeout to ensure DOM is ready
            setTimeout(function() {
                initializeRestrictionsPopup();
                updateRestrictionsCounter(); // Initialize counter state
            }, 100);

            // Handle popup toggle
            if (restrictionsDisplay && restrictionsPopup) {
                restrictionsDisplay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    openRestrictionsPopup();
                });
            } else {
            }
            
            // Handle popup close
            if (restrictionsPopup) {
                const closeBtn = restrictionsPopup.querySelector('.popup-close');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeRestrictionsPopup();
                    });
                }
                
                // Close popup when clicking outside
                restrictionsPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeRestrictionsPopup();
                    }
                });
                
                // Save button functionality
                const saveBtn = document.getElementById('saveRestrictions');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        updateRestrictionsDisplay();
                        closeRestrictionsPopup();
                    });
                }
            }

            // Work area popup functionality
            const workAreaOptions = [
                'צפון',
                'השרון', 
                'מרכז',
                'ירושלים והסביבה',
                'דרום',
                'אילת',
                'כל הארץ'
            ];

            const workAreaSelect = document.getElementById('workAreaSelect');
            const workAreaDropdown = document.getElementById('workAreaDropdown');
            const workAreaTags = document.getElementById('workAreaTags');
            let selectedWorkAreas = [];

            function initializeWorkAreaPopup() {
                // Clear popup
                workAreaDropdown.innerHTML = '';
                
                // Add predefined options with checkboxes
                workAreaOptions.forEach((option) => {
                    const item = document.createElement('div');
                    item.className = 'work-area-checkbox-item';
                    item.style.cursor = 'pointer';
                    item.innerHTML = `
                        <input type="checkbox" value="${option}" id="work_area_${option.replace(/\s+/g, '_')}">
                        <label for="work_area_${option.replace(/\s+/g, '_')}">${option}</label>
                    `;
                    
                    const checkbox = item.querySelector('input[type="checkbox"]');
                    
                    // Make the entire item clickable
                    item.addEventListener('click', function(e) {
                        // Prevent double triggering when clicking directly on checkbox
                        if (e.target.type !== 'checkbox') {
                            checkbox.checked = !checkbox.checked;
                            checkbox.dispatchEvent(new Event('change'));
                        }
                    });
                    
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            selectedWorkAreas.push(option);
                            updateWorkAreaDisplay();
                            updateWorkAreaDropdownStates();
                        } else {
                            selectedWorkAreas = selectedWorkAreas.filter(area => area !== option);
                            updateWorkAreaDisplay();
                            updateWorkAreaDropdownStates();
                        }
                        // Close popup after selection
                        workAreaDropdown.style.display = 'none';
                    });
                    
                    workAreaDropdown.appendChild(item);
                });
            }

            function updateWorkAreaDisplay() {
                // Clear current display
                workAreaTags.innerHTML = '';
                
                if (selectedWorkAreas.length > 0) {
                    selectedWorkAreas.forEach(area => {
                        const tag = document.createElement('div');
                        tag.className = 'work-area-tag';
                        tag.innerHTML = `
                            <span>${area}</span>
                            <span class="remove-tag">×</span>
                        `;
                        
                        tag.querySelector('.remove-tag').addEventListener('click', function(e) {
                            e.stopPropagation();
                            selectedWorkAreas = selectedWorkAreas.filter(wa => wa !== area);
                            updateWorkAreaDisplay();
                            updateWorkAreaDropdownStates();
                        });
                        
                        workAreaTags.appendChild(tag);
                    });
                }
            }

            function updateWorkAreaDropdownStates() {
                const checkboxes = workAreaDropdown.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(checkbox => {
                    checkbox.checked = selectedWorkAreas.includes(checkbox.value);
                });
            }

            // Initialize work area popup
            initializeWorkAreaPopup();

            workAreaSelect.addEventListener('click', function(e) {
                e.preventDefault();
                if (workAreaDropdown.style.display === 'block') {
                    workAreaDropdown.style.display = 'none';
                } else {
                    workAreaDropdown.style.display = 'block';
                    updateWorkAreaDropdownStates();
                }
            });

            // הוספת תמיכה במקלדת לאזורי עבודה
            workAreaSelect.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    workAreaSelect.click();
                }
            });

            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!workAreaSelect.contains(e.target) && !workAreaDropdown.contains(e.target)) {
                    workAreaDropdown.style.display = 'none';
                }
            });



            // Form submission
            document.getElementById('clientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Collect form data
                const formData = new FormData(this);
                const data = {};
                
                for (let [key, value] of formData.entries()) {
                    if (key === 'work_area' || key === 'business_benefits[]') {
                        // Handle multiple values for these fields
                        if (!data[key]) {
                            data[key] = [];
                        }
                        data[key].push(value);
                    } else {
                        data[key] = value;
                    }
                }
                
                // Validate business benefits minimum requirement
                const businessBenefits = data['business_benefits[]'] || [];
                const businessBenefitsArray = Array.isArray(businessBenefits) ? businessBenefits : [businessBenefits];
                const validBenefits = businessBenefitsArray.filter(b => b && b.trim());
                
                
                if (validBenefits.length < 4) {
                    alert(`נדרש לבחור לפחות 4 יתרונות עסקיים. נמצאו ${validBenefits.length} יתרונות: ${validBenefits.join(', ')}`);
                    const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                    if (businessBenefitsDisplay) {
                        businessBenefitsDisplay.scrollIntoView({ behavior: 'smooth' });
                        businessBenefitsDisplay.style.borderColor = '#dc2626';
                        setTimeout(() => {
                            businessBenefitsDisplay.style.borderColor = '';
                        }, 3000);
                    }
                    return;
                }
                
                // Fix field name mapping
                if (data.work_area) {
                    data.work_areas = data.work_area;
                    delete data.work_area;
                }

                // Normalize business_benefits[] to business_benefits
                if (data['business_benefits[]']) {
                    data.business_benefits = data['business_benefits[]'];
                }

                // הוספת השדות החסרים
                // שאלה 5 - אזורי העבודה
                data.work_areas = selectedWorkAreas;


                // שאלה 7 - הגבלות
                data.restrictions = selectedRestrictions;

                // Format phone number to 9725XXXXXXXX
                if (data.phone_number) {
                    data.phone_number = formatPhoneNumber(data.phone_number);
                }

                // Build hierarchical categories structure
                data.categories = buildCategoriesHierarchy();

                // Clean up old/unused field names
                delete data['specializations[]'];
                delete data['business_benefits[]'];
                
                try {
                    // יצירת System Prompt JSON מהטמפלט הקיים
                    const generator = new SimpleFormToPrompt();
                    const result = await generator.generateJSONFile(data);
                    
                    alert(`System Prompt JSON נוצר בהצלחה! 
📄 שם הקובץ: ${result.fileName}
👤 בעל המקצוע: ${data.name || 'לא צוין'}
🔧 תחום: ${data.primary_field || 'לא צוין'}
📊 גודל: ${Math.round(result.size / 1024)} KB
                    
הקובץ JSON כולל:
• System Prompt מלא עם הפרטים שלך כבר מוחלפים
• הטמפלט המקצועי עם השם והפרטים שלך
• מוכן להעתקה ישירה ל-ChatGPT/Claude!
• ללא פליסהולדרים - הכל מוחלף בפרטים האמיתיים!`);
                    
                } catch (error) {
                    console.error('שגיאה ביצירת System Prompt JSON:', error);
                    
                    // Fallback - הורדת JSON כמו קודם
                    const jsonData = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `client_data_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    alert('שגיאה ביצירת System Prompt JSON. הטופס נשמר כקובץ נתונים רגיל במקום.');
                }
                
                // Reset form
                this.reset();
                
                // Remove all selected classes
                radioItems.forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Reset business benefits
                selectedBusinessBenefits = [];
                updateBusinessBenefitsDisplay();
                
                // Reset specializations
                selectedSpecializations = [];
                updateSpecializationsDisplay();
                
                // Reset work areas if they exist
                if (typeof selectedWorkAreas !== 'undefined') {
                    selectedWorkAreas = [];
                    if (typeof updateWorkAreaDisplay === 'function') {
                        updateWorkAreaDisplay();
                    }
                }
                
                // Clear any error styles
                const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                if (businessBenefitsDisplay) {
                    businessBenefitsDisplay.style.borderColor = '';
                }
                
            });

        }); // End of DOMContentLoaded

        // Live Preview System
        class LivePreviewSystem {
            constructor() {
                this.initializePreview();
            }

            initializePreview() {
                const generateBtn = document.getElementById('generatePreviewBtn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generatePreview());
                }

                // Show preview section when form is mostly filled
                this.watchFormProgress();
            }

            watchFormProgress() {
                const requiredFields = ['client_name', 'primary_field', 'experience_years', 'phone_number'];
                const previewSection = document.getElementById('livePreviewSection');
                
                setInterval(() => {
                    const filledFields = requiredFields.filter(fieldName => {
                        const field = document.querySelector(`[name="${fieldName}"]`);
                        return field && field.value.trim() !== '';
                    });

                    // Check business benefits from the display
                    const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                    const businessBenefitsFilled = businessBenefitsDisplay && 
                        businessBenefitsDisplay.children.length >= 4;
                    
                    if (filledFields.length >= 3 && businessBenefitsFilled) {
                        previewSection.style.display = 'block';
                    }
                }, 1000);
            }

            generateSamplePosts(primaryField, workAreas) {
                const postTemplates = {
                    'חשמל': [
                        'שלום, אני צריך חשמלאי בדחיפות! יש לי בעיה עם הלוח חשמל ונופל לי המגן. מישהו יכול להגיע היום?',
                        'מחפש חשמלאי להתקנת נקודות חשמל בבית החדש. יש לי 5 חדרים. מישהו יכול לתת הערכת מחיר?',
                        'היי! דרוש חשמלאי לתיקון בעיית תאורה בסלון. הנורות נדלקות ומכבות מעצמן. מישהו פנוי?'
                    ],
                    'אינסטלציה': [
                        'עזרה! יש לי דלפת מים חזקה מהברז במטבח. מישהו יכול להגיע עכשיו?',
                        'מחפש אינסטלטור לבדיקת לחץ מים בבית. המים זורמים חלש מאוד. מישהו יכול לעזור?',
                        'צריך התקנת אינסטלציה חדשה לחדר רחצה. מחפש מישהו מנוסה ואמין.'
                    ],
                    'שיפוצים כלליים': [
                        'מחפש בעל מקצוע לשיפוץ דירת 3 חדרים. כולל צבע, גבס ותיקונים קלים.',
                        'דרוש מקצוען לתיקון חור בקיר גבס + צביעה. מישהו פנוי השבוע?',
                        'רוצה לשפץ את הסלון. מחפש מישהו שיכול לעשות הכל - צבע, רצפה, תקרה.'
                    ],
                    'פיתוח מגרשים': [
                        'מחפש חברה לפיתוח מגרש של 800 מ"ר לבניית בית פרטי. יש תוכניות מאושרות.',
                        'צריך פיתוח מגרש חקלאי כולל דרכי גישה וחיבור לתשתיות. מי יכול לעזור?',
                        'דרוש יזם לפיתוח קרקע של 2 דונם. מחפש מישהו עם ניסיון בפרויקטים דומים.'
                    ],
                    'בנייה': [
                        'מחפש קבלן לבניית בית פרטי 200 מ"ר. יש תוכניות מאושרות והיתרים.',
                        'צריך קבלן בנייה לתוספת חדר 20 מ"ר לבית קיים. מישהו יכול להמליץ?',
                        'דרוש קבלן מנוסה לפרויקט בנייה של וילה דו קומתית.'
                    ],
                    'ריצוף וחיפוי': [
                        'מחפש מרצף לדירה 80 מ"ר. רוצה גרניט פורצלן. מישהו יכול לתת הצעת מחיר?',
                        'צריך חיפוי קיר למטבח 15 מ"ר. יש לי כבר את החומרים. מישהו פנוי השבוע?',
                        'דרוש מרצף מנוסה לריצוף חצר בבית פרטי. שטח של 50 מ"ר.'
                    ],
                    'ציור': [
                        'מחפש צייר לצביעת דירה 3 חדרים. כולל תקרות וקירות. מישהו יכול להמליץ?',
                        'צריך צייר לצביעת חדר ילדים. רוצה צבעים עמידים ובטוחים. מי יכול לעזור?',
                        'דרוש צייר מקצועי לצביעת חזית בית פרטי. 2 קומות.'
                    ],
                    'גינון': [
                        'מחפש גנן לעיצוב גינה חדשה בבית פרטי. שטח 200 מ"ר. מישהו יכול להמליץ?',
                        'צריך גיזום עצים בגינה + הקמת מערכת השקיה. מישהו מנוסה בתחום?',
                        'דרוש גנן לתחזוקה חודשית של גינה. מחפש מישהו אמין וקבוע.'
                    ],
                    'מזגנים': [
                        'המזגן לא מקרר! צריך טכנאי בדחיפות. החום הורג אותנו כאן.',
                        'מחפש טכנאי מזגנים להתקנה חדשה בסלון. מה המחיר לאינוורטר?',
                        'המזגן עושה רעשים מוזרים ומטפטף מים. מישהו יכול לבוא לבדוק?'
                    ],
                    'נגרות': [
                        'מחפש נגר לבניית ארון חדר שינה לפי מידה. גובה 2.40 מטר.',
                        'צריך תיקון דלת כניסה שלא נסגרת טוב. מישהו יכול להגיע השבוע?',
                        'דרוש נגר לבניית ספסל פינת אוכל + אחסון. יש לי סקיצות.'
                    ],
                    'מסגרות': [
                        'מחפש מסגר להתקנת גדר לחצר. אורך 30 מטר. מישהו יכול לתת הערכת מחיר?',
                        'צריך תיקון שער חניה שנתקע. המנוע עובד אבל השער לא זז.',
                        'דרוש מסגר לבניית פרגולה בחצר. יש לי את התוכניות מוכנות.'
                    ]
                };

                // Create contextual posts based on field
                const getDefaultPosts = (field) => {
                    if (field.includes('עורך דין') || field.includes('משפטי')) {
                        return [
                            `מחפש עורך דין לייעוץ משפטי בנושא ${field.replace('עורך דין ', '')}. מישהו יכול להמליץ?`,
                            `צריך ייצוג משפטי בעניין דחוף. מחפש עורך דין מנוסה ב${field}.`,
                            `שלום, רוצה להתייעץ עם עורך דין לגבי חוזה. מישהו זמין לפגישה?`
                        ];
                    } else if (field.includes('רופא') || field.includes('רפואה')) {
                        return [
                            `מחפש ${field} טוב ומנוסה. מישהו יכול להמליץ על מומחה?`,
                            `צריך לקבוע תור ל${field} בדחיפות. מישהו מכיר מי זמין?`,
                            `שלום, מחפש המלצה על ${field} באזור. תודה מראש!`
                        ];
                    } else if (field.includes('מדריך') || field.includes('הדרכה')) {
                        return [
                            `מחפש ${field} למפגש חד פעמי. מישהו יכול להמליץ?`,
                            `צריך ${field} לקבוצה של 10 אנשים. מישהו זמין השבוע?`,
                            `שלום, רוצה להזמין ${field} לאירוע. מה המחירים?`
                        ];
                    } else {
                        return [
                            `מחפש ${field} מנוסה ואמין. מישהו יכול להמליץ?`,
                            `צריך ${field} לפרויקט חדש. מישהו זמין השבוע?`,
                            `שלום, מחפש ${field} איכותי. מה המחירים?`
                        ];
                    }
                };
                
                const defaultPosts = getDefaultPosts(primaryField);

                const templates = postTemplates[primaryField] || defaultPosts;
                
                // Add location context if work areas are specified
                const locations = workAreas && workAreas.length > 0 ? workAreas : ['אזור המרכז'];
                
                // Fixed list of author names
                const authorNames = ['דני כהן', 'שרה לוי', 'יוסי אברהם'];
                
                return templates.map((template, index) => {
                    const location = locations[index % locations.length];
                    const authorName = authorNames[index % authorNames.length];
                    return {
                        content: `${authorName}: ${template}`,
                        displayContent: template,
                        authorName: authorName,
                        location: location
                    };
                });
            }

            async callLocalPreviewAPI(formData, samplePosts) {
                try {
                    // Call the backend AI response endpoint with form data
                    // Server will generate the prompt using the master template
                    const response = await fetch(`${API_BASE_URL}/collabo-api/generate-ai-responses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            form_data: formData,
                            posts: samplePosts
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Server Error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && data.responses && data.responses.length > 0) {
                        // Format responses to match expected structure
                        return {
                            success: true,
                            responses: samplePosts.map((post, index) => ({
                                post: post,
                                response: this.appendWhatsAppLink(data.responses[index], formData.phone_number),
                                source: 'ai'
                            })),
                            apiKeyAvailable: true
                        };
                    } else {
                        throw new Error(data.error || 'AI response generation failed');
                    }
                } catch (error) {
                    console.error('AI API Error:', error);
                    // Fallback to mock responses
                    return {
                        success: true,
                        responses: samplePosts.map(post => ({
                            post: post,
                            response: this.generateMockResponse(post, formData.phone_number),
                            source: 'mock'
                        })),
                        apiKeyAvailable: false
                    };
                }
            }

            appendWhatsAppLink(response, phoneNumber) {
                // Append WhatsApp link in the format wa.me/+9725XXXXXXXX
                if (!phoneNumber) return response;
                return `${response}\nhttps://wa.me/+${phoneNumber}`;
            }

            generateMockResponse(userMessage, phoneNumber) {
                const clientName = document.querySelector('[name="client_name"]').value || 'המקצוען';
                const primaryField = document.querySelector('[name="primary_field"]').value || 'השירות';
                const phone = phoneNumber || '972521234567';

                return `שלום!

${clientName} כאן, ${primaryField} עם ניסיון רב בתחום.

אני זמין לעזור לך עם הבקשה שלך.

אשמח לתאם פגישה או שיחה קצרה כדי להבין בדיוק מה נדרש ולתת לך הערכת מחיר מדויקת.

ניתן ליצור קשר בווצאפ: wa.me/+${phone}

בהצלחה!
${clientName}`;
            }

            async generatePreview() {
                const previewContainer = document.getElementById('previewContainer');
                const loadingDiv = document.getElementById('previewLoading');
                const resultsDiv = document.getElementById('previewResults');
                
                // Show loading
                previewContainer.style.display = 'block';
                loadingDiv.style.display = 'block';
                resultsDiv.innerHTML = '';

                try {
                    // Get form data
                    const formData = this.collectFormData();
                    
                    // Validate form data before generating preview
                    const validationResult = this.validateFormData(formData);
                    if (!validationResult.isValid) {
                        throw new Error(validationResult.errorMessage);
                    }
                    
                    // Generate sample posts
                    const samplePosts = this.generateSamplePosts(formData.primary_field, formData.work_areas);
                    const selectedPosts = samplePosts.slice(0, 3);
                    const postsContent = selectedPosts.map(p => p.content);
                    
                    // Call local API to generate responses
                    const apiResponse = await this.callLocalPreviewAPI(formData, postsContent);
                    
                    if (apiResponse.success) {
                        this.updatePreviewResults(apiResponse.responses, selectedPosts);
                        
                        // Show API status indicator
                        const apiIndicator = document.getElementById('apiStatusIndicator');
                        if (!apiResponse.apiKeyAvailable) {
                            apiIndicator.classList.add('show');
                        } else {
                            apiIndicator.classList.remove('show');
                        }
                    } else {
                        throw new Error('API response failed');
                    }
                    
                } catch (error) {
                    console.error('Preview generation error:', error);
                    
                    // Check if this is a validation error
                    if (error.message.includes('חסרים הפרטים הבאים:')) {
                        resultsDiv.innerHTML = `<div style="color: #dc2626; text-align: center; padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin: 10px 0;">
                            <strong>לא ניתן ליצור תצוגה מקדימה</strong><br>
                            ${error.message}
                        </div>`;
                    } else {
                        resultsDiv.innerHTML = '<div style="color: #dc2626; text-align: center;">שגיאה ביצירת התצוגה המקדימה. וודא שהשרת פועל.</div>';
                    }
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            collectFormData() {
                
                // Collect work areas from multiple sources
                let workAreas = [];
                
                // Try global variable first
                if (typeof selectedWorkAreas !== 'undefined' && selectedWorkAreas.length > 0) {
                    workAreas = selectedWorkAreas;
                } else {
                    // Try to read from the display element
                    const workAreaTags = document.getElementById('workAreaTags');
                    if (workAreaTags && workAreaTags.children.length > 0) {
                        workAreas = Array.from(workAreaTags.children).map(span => {
                            return span.textContent.replace('×', '').trim();
                        }).filter(v => v);
                    } else {
                        // Fallback: read from hidden inputs
                        const workAreaInputs = document.querySelectorAll('input[name="work_areas[]"]');
                        workAreas = Array.from(workAreaInputs).map(input => input.value).filter(v => v);
                    }
                }

                // Collect business benefits from the global array (if available) or hidden inputs
                let businessBenefits = [];
                if (typeof selectedBusinessBenefits !== 'undefined' && selectedBusinessBenefits.length > 0) {
                    businessBenefits = selectedBusinessBenefits.map(b => b.text || b);
                } else {
                    // Fallback: read from hidden inputs
                    const benefitInputs = document.querySelectorAll('input[name="business_benefits[]"]');
                    businessBenefits = Array.from(benefitInputs).map(input => input.value).filter(v => v);
                }

                // Collect restrictions from the global array (if available) or hidden inputs
                let restrictions = [];
                if (typeof selectedRestrictions !== 'undefined' && selectedRestrictions.length > 0) {
                    restrictions = selectedRestrictions;
                } else {
                    // Fallback: read from hidden inputs
                    const restrictionInputs = document.querySelectorAll('input[name="restrictions[]"]');
                    restrictions = Array.from(restrictionInputs).map(input => input.value).filter(v => v);
                }

                // Format phone number to 9725XXXXXXXX
                const rawPhone = document.querySelector('[name="phone_number"]').value || '';
                const phoneNumber = formatPhoneNumber(rawPhone);

                // Build hierarchical categories structure
                const categories = buildCategoriesHierarchy();

                const formData = {
                    client_name: document.querySelector('[name="client_name"]').value || 'המקצוען',
                    primary_field: document.getElementById('primaryFieldHidden').value || 'שיפוצים כלליים',
                    experience_years: document.querySelector('[name="experience_years"]').value || '10',
                    phone_number: phoneNumber,
                    work_areas: workAreas,
                    business_benefits: businessBenefits,
                    categories: categories,
                    restrictions: restrictions
                };

                return formData;
            }

            updatePreviewResults(results, selectedPosts) {
                const resultsDiv = document.getElementById('previewResults');
                
                resultsDiv.innerHTML = results.map((result, index) => {
                    // Get post data from selectedPosts
                    const postData = selectedPosts[index];
                    const authorName = postData.authorName;
                    const postContent = postData.displayContent;
                    
                    
                    // Get first letter for avatar
                    const avatarLetter = authorName.charAt(0);
                    
                    return `
                        <div class="facebook-post-card">
                            <div class="post-header">
                                <div class="post-avatar">${avatarLetter}</div>
                                <div class="post-meta">
                                    <div class="post-author">${authorName}</div>
                                    <div class="post-time">${Math.floor(Math.random() * 12) + 1} דק'</div>
                                </div>
                            </div>
                            <div class="post-content">${postContent}</div>
                            
                            <div class="post-interactions">
                                <div class="interactions-bar">
                                    <span class="interaction-btn">אהבתי</span>
                                    <span class="interaction-btn">תגובה</span>
                                    <span class="interaction-btn">שתף</span>
                                </div>
                            </div>
                            
                            <div class="comments-section">
                                <div class="comment">
                                    <div class="comment-avatar">ס</div>
                                    <div class="comment-content">
                                        <div class="comment-author">הסוכן שלך (${document.querySelector('[name="client_name"]').value || 'בעל המקצוע'})</div>
                                        <div class="comment-time">עכשיו</div>
                                    </div>
                                </div>
                                <div class="comment-text">${formatLinksInText(result.response)}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            validateFormData(formData) {
                const missingFields = [];
                
                // Question 1: Name (required)
                if (!formData.client_name || formData.client_name.trim() === '') {
                    missingFields.push('1. שם העסק שלכם');
                }
                
                // Question 2: Experience years (required)
                if (!formData.experience_years || formData.experience_years.trim() === '') {
                    missingFields.push('2. כמה שנים העסק שלכם פעיל');
                }
                
                // Question 3: Phone number (required)
                if (!formData.phone_number || formData.phone_number.trim() === '') {
                    missingFields.push('3. מספר טלפון');
                }
                
                // Question 4: Primary field (required)
                if (!formData.primary_field || formData.primary_field.trim() === '') {
                    missingFields.push('4. תחום פעילות ראשי');
                }
                
                // Question 5: Work areas (required)
                if (!formData.work_areas || formData.work_areas.length === 0) {
                    missingFields.push('5. אזורי פעילות');
                }
                
                // Question 6: Business benefits (required - at least 4)
                if (!formData.business_benefits || formData.business_benefits.length < 4) {
                    missingFields.push('6. יתרונות עסקיים (נדרשים לפחות 4)');
                }
                
                // Question 7: Specializations (OPTIONAL - not required)

                // Question 8: Restrictions/limitations (OPTIONAL - not required)
                
                if (missingFields.length > 0) {
                    const errorMessage = `חסרים הפרטים הבאים:\n${missingFields.join('\n')}`;
                    return {
                        isValid: false,
                        errorMessage: errorMessage
                    };
                }
                
                return {
                    isValid: true,
                    errorMessage: null
                };
            }
        }

        // Initialize Live Preview System when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new LivePreviewSystem();
            });
        } else {
            new LivePreviewSystem();
        }

        /**
         * SimpleFormToPrompt Class - מוטמע מהקובץ המקורי
         * Simple Form to Prompt JSON - יצירת JSON עם הטמפלט המלא והחלפת פליסהולדרים
         */
        class SimpleFormToPrompt {
            /**
             * יצירת JSON עם metadata ו-form data בלבד
             */
            generateJSON(formData) {
                return {
                    metadata: {
                        client_name: formData.client_name || formData.name || 'לא צוין',
                        primary_field: formData.primary_field || 'לא צוין',
                        creation_date: new Date().toISOString(),
                        version: "3.0"
                    },
                    original_form_data: formData
                };
            }

            /**
             * יצירת קובץ JSON ושליחתו לשרת
             */
            async generateJSONFile(formData) {
                const data = this.generateJSON(formData);
                const fileName = `system_prompt_${(formData.name || 'client').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;

                // שליחת JSON לשרת
                const jsonString = this.formatJSONNicely(data);

                const response = await fetch(`${API_BASE_URL}/collabo-api/pro-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                return {
                    fileName: fileName,
                    data: data,
                    size: jsonString.length,
                    serverResponse: result
                };
            }

            /**
             * פורמט JSON יפה עם שורות חדשות אמיתיות
             */
            formatJSONNicely(data) {
                // מטאדאטה מצומצמת - רק החלקים הרלוונטיים
                const cleanMetadata = {
                    client_name: data.metadata.client_name,
                    primary_field: data.metadata.primary_field,
                    creation_date: data.metadata.creation_date
                };

                const jsonObj = {
                    metadata: cleanMetadata,
                    original_form_data: data.original_form_data
                };

                return JSON.stringify(jsonObj, null, 2);
            }
        }

        window.SimpleFormToPrompt = SimpleFormToPrompt;

        /**
         * Format Israeli phone number to 9725XXXXXXXX format
         * @param {string} phone - Phone number in any Israeli format
         * @returns {string} Formatted phone number as 9725XXXXXXXX
         */
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const clean = phone.replace(/\D/g, '');
            if (clean.startsWith('0')) {
                return '972' + clean.slice(1);
            } else if (clean.startsWith('972')) {
                return clean;
            } else {
                return '972' + clean;
            }
        }

        // Make it globally available
        window.formatPhoneNumber = formatPhoneNumber;
    </script>
</body>

</html>
