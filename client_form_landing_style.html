<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yesלא לחשוף
        
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="HandheldFriendly" content="true">
    <title>טופס איסוף נתונים לבעל מקצוע - Collabo AI Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Simple Form to Prompt JSON - מוטמע בקובץ -->
    <style>
        :root {
            --ai-purple: rgba(76, 29, 149, 0.5);
            --text-primary: #37352f;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --border-light: #e5e7eb;
            --bg-light: #ffffff;
            --bg-gray: #f3f4f6;
            --border-radius: 6px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif;
            line-height: 1.5;
            color: #37352f;
            direction: rtl;
            background: #ffffff;
            font-weight: 400;
            min-height: 100vh;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        .main-wrapper {
            min-height: 100vh;
            background: var(--bg-gray);
            padding: 60px 0;
        }

        .page-header {
            text-align: center;
            margin-bottom: 60px;
        }

        .page-header h1 {
            font-size: 2.5em;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
            letter-spacing: -0.025em;
        }

        .page-header p {
            font-size: 1em;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .brand-tag {
            display: inline-block;
            background: rgba(76, 29, 149, 0.8);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-bottom: 24px;
            letter-spacing: 0.5px;
        }

        /* שאלה 7 - עיצוב שדות הגבלות חדשים */
        .restriction-field-wrapper {
            position: relative;
            margin-bottom: 12px;
        }

        .restriction-field {
            width: 100%;
            text-align: right;
            padding-right: 16px;
        }

        .remove-restriction-btn:hover {
            background-color: rgba(220, 38, 38, 0.1);
            border-radius: 50%;
        }

        /* אנימציה למנורה מהבהבת */
        @keyframes lightbulb-glow {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 5px rgba(245, 158, 11, 0.5);
            }
            50% {
                opacity: 0.7;
                text-shadow: 0 0 10px rgba(245, 158, 11, 0.8);
            }
        }

        /* טולטיפ מותאם למובייל */
        @media (max-width: 768px) {
            .fas.fa-lightbulb {
                font-size: 16px !important;
                padding: 4px;
                border-radius: 50%;
                background: rgba(245, 158, 11, 0.1);
            }
        }

        /* Contact Form Styles - מעתק מדף הנחיתה */
        .contact-form {
            max-width: 700px;
            margin: 0 auto;
        }

        .form-input {
            width: 100%;
            height: 48px;
            padding: 12px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 16px;
            font-family: inherit;
            background: var(--bg-light);
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-sizing: border-box;
            text-align: right;
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.2);
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .form-section {
            margin-bottom: 60px;
            padding: 32px;
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }

        .form-section h3 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0px;
        }

        .section-description {
            background: rgba(76, 29, 149, 0.05);
            border: 1px solid rgba(76, 29, 149, 0.15);
            border-radius: var(--border-radius);
            padding: 12px;
            margin-top: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .section-description strong {
            color: var(--text-primary);
            font-weight: 600;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 14px;
            margin-bottom: 28px;
        }

        .form-group:last-child {
            margin-bottom: 0;
        }

        .form-label {
            display: block;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .question-number {
            color: var(--ai-purple);
            font-weight: 800;
            margin-left: 8px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Radio/Checkbox Groups */
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            margin-top: 0;
            flex-direction: column;
        }

        /* Yes/No radio groups - horizontal layout */
        .radio-group.yes-no {
            flex-direction: row;
            justify-content: flex-start;
        }

        .radio-group.yes-no .radio-item {
            flex: 0 0 auto;
            min-width: 80px;
            max-width: 120px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 12px;
            height: 48px;
            padding: 12px 20px;
            background: var(--bg-light);
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
            box-sizing: border-box;
        }

        .radio-item:hover {
            border-color: var(--ai-purple);
            background: rgba(76, 29, 149, 0.05);
        }

        .radio-item input {
            accent-color: rgba(76, 29, 149, 0.8);
        }

        .radio-item.selected {
            border-color: rgba(76, 29, 149, 0.8);
            background: rgba(76, 29, 149, 0.1);
            color: rgba(76, 29, 149, 0.8);
            font-weight: 600;
        }




        /* Checkbox styling */
        .work-area-checkbox-item {
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
            height: 48px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .work-area-checkbox-item:hover {
            background-color: #f8fafc;
        }

        .work-area-checkbox-item:last-child {
            border-bottom: none;
        }

        /* ==============================================
           CHECKBOX STYLING - UNIFIED ACROSS ALL POPUPS
        ============================================== */
        
        /* Standard checkbox styling for all popup checkboxes */
        input[type="checkbox"] {
            accent-color: rgba(76, 29, 149, 0.8);
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
        }

        /* Specific styling for popup checkboxes */
        .popup-checkbox {
            width: 16px;
            height: 16px;
            margin: 0;
            cursor: pointer;
            accent-color: rgba(76, 29, 149, 0.8);
        }

        /* Popup item containers - unified styling */
        .benefit-item,
        .restriction-item,
        .subcategory-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 24px;
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }

        .benefit-item:hover,
        .restriction-item:hover,
        .subcategory-item:hover {
            background-color: rgba(76, 29, 149, 0.05);
        }





        /* ==============================================
           TAG CONTAINERS ARCHITECTURE
        ============================================== */
        
        /* Base layout for all dynamic content containers */
        .dynamic-content-container {
            display: flex;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Layout modifiers */
        .layout--inline-wrap {
            flex-wrap: wrap;
        }

        .layout--vertical-stack {
            flex-direction: column;
        }

        /* ==============================================
           COMPONENT-SPECIFIC IMPLEMENTATIONS
        ============================================== */

        /* Area selection tags - wrap horizontally */
        .work-area-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Business benefits categories - stack vertically */
        .business-benefits-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Restriction input containers - stack vertically */
        .restriction-tags {
            /* inherits: display: flex, gap: 8px, margin-top: 0, min-height: 0 */
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 0;
            min-height: 0;
        }

        /* Business benefits display styling */

        #businessBenefitsDisplay {
            cursor: pointer;
            transition: border-color 0.2s;
        }

        #businessBenefitsDisplay:hover {
            border-color: var(--ai-purple);
        }


        /* ==============================================
           BUSINESS BENEFIT INPUT STYLING
        ============================================== */
        
        .business-benefit-input {
            /* Desktop base styling */
            padding: 12px 16px 12px 40px;
            font-size: 14px;
            text-align: right;
            direction: rtl;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .business-benefit-input:focus {
            border-color: var(--ai-purple) !important;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1) !important;
        }

        .business-benefit-input:hover {
            border-color: #d1d5db;
        }

        /* ==============================================
           RESTRICTION INPUT STYLING
        ============================================== */
        
        .restriction-input {
            /* Desktop base styling */
            padding: 12px 16px 12px 40px;
            font-size: 14px;
            text-align: right;
            direction: rtl;
            background: #f9fafb;
        }

        .restriction-input:focus {
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .restriction-input:hover {
            border-color: #d1d5db;
        }

        /* Reset margins when containers have content */
        .work-area-tags:not(:empty),
        .business-benefits-tags:not(:empty),
        .restriction-tags:not(:empty) {
            margin-top: 0;
        }

        /* ==============================================
           TAG ELEMENTS (Individual items within containers)
        ============================================== */
        
        .work-area-tag,
        .business-benefit-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: #f9fafb;
            color: #374151;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            border: 1px solid #d1d5db;
        }

        .work-area-tag .remove-tag,
        .business-benefit-tag .remove-tag {
            cursor: pointer;
            font-weight: bold;
            font-size: 18px;
            line-height: 1;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: #dc2626;
            transition: background-color 0.2s;
        }

        .work-area-tag .remove-tag:hover,
        .business-benefit-tag .remove-tag:hover {
            background: rgba(220, 38, 38, 0.1);
        }


        /* Work area styling */
        .work-area-select-container {
            position: relative;
            width: 100%;
        }

        .work-area-select {
            width: 100%;
            height: 48px;
            padding: 12px 20px;
            border: 2px solid var(--border-light);
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 16px;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }

        .work-area-select:hover {
            border-color: var(--ai-purple);
        }

        .work-area-select.active {
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 3px rgba(76, 29, 149, 0.2);
        }

        .work-area-placeholder {
            color: var(--text-muted);
        }

        .work-area-arrow {
            transition: transform 0.3s ease;
            color: var(--text-muted);
        }

        .work-area-select.active .work-area-arrow {
            transform: rotate(180deg);
        }

        /* ==============================================
           COMBINED CATEGORY-LOCATION COMPONENT STYLES
        ============================================== */

        /* Subcategory Table - matching location_selection_final.html */
        .subcategory-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-top: 16px;
        }

        .subcategory-table thead tr {
            background: var(--bg-gray);
        }

        .subcategory-table th {
            padding: 12px 16px;
            text-align: right;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-light);
        }

        .subcategory-table td {
            padding: 12px 16px;
            vertical-align: top;
            border-bottom: 1px solid var(--border-light);
        }

        .subcategory-table tr:last-child td {
            border-bottom: none;
        }

        .subcategory-name {
            font-weight: 500;
        }

        .subcategory-category {
            font-size: 12px;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .primary-badge {
            display: inline-block;
            background: var(--ai-purple);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-right: 8px;
        }

        .locations-cell {
            display: flex;
            gap: 12px;
            align-items: flex-start;
            width: 100%;
            justify-content: center;
        }

        .locations-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .no-locations-text {
            color: var(--text-muted);
            font-style: italic;
            text-align: center;
            display: block;
        }

        .location-district-group {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .edit-locations-btn {
            background: transparent !important;
            border: none !important;
            color: #7c3aed !important;
            cursor: pointer;
            padding: 4px !important;
            border-radius: 4px;
            display: inline-flex !important;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
            flex-shrink: 0;
            width: 28px !important;
            height: 28px !important;
            min-width: 28px !important;
            max-width: 28px !important;
        }

        .edit-locations-btn:hover {
            background-color: rgba(124, 58, 237, 0.1) !important;
        }

        .edit-locations-btn i {
            font-size: 16px !important;
            color: #7c3aed !important;
        }

        /* Location tags in table */
        .location-district-group:last-child {
            margin-bottom: 0;
        }

        .district-label {
            font-size: 13px;
            color: #7c3aed;
            font-weight: 500;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 4px;
            justify-content: center;
        }

        .district-label .pin-icon {
            font-size: 14px;
        }

        .county-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            justify-content: center;
        }

        .county-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background: #f3f4f6;
            color: var(--text-primary);
            border-radius: 16px;
            font-size: 13px;
            border: 1px solid #e5e7eb;
        }

        .county-tag .remove-county {
            cursor: pointer;
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1;
            transition: color 0.2s ease;
        }

        .county-tag .remove-county:hover {
            color: #dc2626;
        }

        /* Category selection popup - hierarchy styles */
        .category-hierarchy-item {
            border-bottom: 1px solid #f3f4f6;
        }

        .category-hierarchy-item:last-child {
            border-bottom: none;
        }

        .category-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: #fafbfc;
            cursor: pointer;
            transition: background-color 0.2s ease;
            gap: 12px;
        }

        .category-header:hover {
            background-color: rgba(76, 29, 149, 0.05);
        }

        .category-header.expanded {
            background-color: rgba(76, 29, 149, 0.08);
        }

        .category-toggle {
            font-size: 12px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            width: 16px;
        }

        .category-header.expanded .category-toggle {
            transform: rotate(90deg);
        }

        .category-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-primary);
        }

        .category-checkbox {
            margin-left: 8px;
        }

        .set-primary-btn {
            padding: 4px 10px;
            border: 1px solid var(--border-light);
            background: white;
            color: var(--text-secondary);
            border-radius: 4px;
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .set-primary-btn:hover {
            border-color: var(--ai-purple);
            color: var(--ai-purple);
        }

        .set-primary-btn.is-primary {
            background: #fef3c7;
            border-color: #d97706;
            color: #d97706;
        }

        .subcategories-list {
            display: none;
            background: white;
        }

        .subcategories-list.expanded {
            display: block;
        }

        .subcategory-select-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 16px 10px 40px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .subcategory-select-item:hover {
            background-color: rgba(76, 29, 149, 0.03);
        }

        .subcategory-select-item.selected {
            background-color: rgba(76, 29, 149, 0.08);
        }

        /* Location edit modal */
        .location-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            overflow-y: auto;
        }

        .location-modal-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }

        .location-modal-content {
            background: white;
            border-radius: 12px;
            border: 1px solid var(--border-light);
            max-width: 500px;
            width: 100%;
            max-height: 80vh;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .location-modal-header {
            padding: 20px 20px 16px 20px;
            border-bottom: 1px solid var(--border-light);
        }

        .location-modal-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .location-modal-close {
            background: none;
            color: var(--text-muted);
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }

        .location-modal-close:hover {
            background: var(--bg-gray);
        }

        .location-modal-body {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }

        .location-modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--bg-gray);
        }

        .location-count-text {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .save-locations-btn {
            background: var(--ai-purple);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: var(--border-radius);
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .save-locations-btn:hover {
            background: rgba(76, 29, 149, 0.9);
        }

        /* Location hierarchy in modal */
        .district-item {
            border-bottom: 1px solid #f3f4f6;
        }

        .district-header {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-primary);
            background: #fafbfc;
            transition: background-color 0.2s ease;
            gap: 8px;
        }

        .district-header:hover {
            background-color: rgba(76, 29, 149, 0.05);
        }

        .district-header.expanded {
            background-color: rgba(76, 29, 149, 0.08);
        }

        .district-checkbox {
            margin-left: 8px;
        }

        .counties-list {
            display: none;
            background: white;
        }

        .counties-list.expanded {
            display: block;
        }

        .county-item {
            display: flex;
            align-items: center;
            padding: 10px 16px 10px 32px;
            padding-right: 40px; /* RTL indent under district */
            cursor: pointer;
            transition: background-color 0.2s ease;
            gap: 8px;
            border-bottom: 1px solid #f8f9fa;
        }

        .county-item:hover {
            background-color: rgba(76, 29, 149, 0.03);
        }

        .county-item.selected {
            background-color: rgba(76, 29, 149, 0.08);
        }

        .county-item:last-child {
            border-bottom: none;
        }

        .county-name {
            flex: 1;
            font-weight: 500;
        }

        .county-expand-toggle {
            font-size: 10px;
            color: var(--text-muted);
            transition: transform 0.2s ease;
            cursor: pointer;
            padding: 4px;
        }

        .county-expand-toggle.expanded {
            transform: rotate(90deg);
        }

        .cities-list {
            display: none;
            padding-right: 64px; /* RTL indent under county */
            background: #fafbfc;
        }

        .cities-list.expanded {
            display: block;
        }

        .city-item {
            padding: 6px 16px;
            font-size: 13px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .city-item:hover {
            background-color: rgba(76, 29, 149, 0.05);
            color: var(--text-primary);
        }

        .city-item:hover .county-highlight-hint {
            display: inline;
        }

        .county-highlight-hint {
            display: none;
            font-size: 11px;
            color: var(--ai-purple);
            margin-right: 8px;
        }

        /* Search in location modal */
        .location-search-section {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-light);
            background: #f9fafb;
        }

        .location-search-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border-light);
            border-radius: var(--border-radius);
            font-size: 14px;
            color: var(--text-primary);
            background: white;
            direction: rtl;
            text-align: right;
        }

        .location-search-input:focus {
            outline: none;
            border-color: var(--ai-purple);
            box-shadow: 0 0 0 2px rgba(76, 29, 149, 0.1);
        }

        .search-result-item {
            padding: 10px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f9fafb;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: rgba(76, 29, 149, 0.05);
        }

        .search-result-path {
            color: var(--text-muted);
            font-size: 12px;
            margin-top: 2px;
        }

        .no-results {
            padding: 20px 16px;
            text-align: center;
            color: var(--text-muted);
            font-style: italic;
        }



        /* Submit Button - מעתק מדף הנחיתה */
        .contact-form button {
            width: 100%;
            padding: 16px 20px;
            background: rgba(76, 29, 149, 0.8);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 0px;
        }

        .contact-form button:hover {
            background: #3730a3;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(76, 29, 149, 0.3);
        }

        .footer-info {
            text-align: center;
            margin-top: 40px;
            color: var(--text-secondary);
            font-size: 1.1em;
        }

        .footer-info .brand {
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 16px;
        }

        /* Responsive Design */
        /* Large mobile / Small tablet styles (600px and below) */
        @media (max-width: 600px) {
            .container {
                padding: 0 14px;
            }
            
        }
        
        /* Tablet styles (768px and below) */
        @media (max-width: 768px) {
            .container {
                padding: 0 16px;
            }

            .main-wrapper {
                padding: 40px 0;
            }

            .page-header h1 {
                font-size: 2em;
            }

            .page-header p {
                font-size: 1em;
            }

            .form-section {
                padding: 24px;
                margin-bottom: 40px;
            }

            .form-input, .work-area-select, .radio-item {
                height: 44px;
                padding: 10px 16px;
                font-size: 16px;
            }

            /* Tablet: Container margins */
            .work-area-tags,
            .business-benefits-tags,
            .restriction-tags {
                margin-top: 0;
            }

            .form-label {
                font-size: 15px;
                margin-bottom: 0;
            }

            .question-number {
                font-size: 18px;
            }

            .radio-group {
                flex-direction: column;
            }

            .radio-item {
                min-width: 100%;
            }


            .contact-form button {
                padding: 14px 20px;
                font-size: 16px;
            }
        }

        /* Universal popup styling - ensure consistency across all devices */
        #saveCombinedSpecializations,
        #saveBusinessBenefits,
        #saveRestrictions {
            width: 120px !important;
            font-size: 14px !important;
            padding: 10px 12px !important;
            min-height: 44px !important;
        }
        
        .set-primary-btn {
            width: 90px !important;
            height: 32px !important;
            font-size: 12px !important;
            padding: 4px 8px !important;
            min-height: 32px !important;
        }

        /* Desktop styles (769px and above) - Force same styling as mobile */
        @media (min-width: 769px) {
            /* Force all popup containers to look exactly like mobile */
            #combinedSpecializationsPopupContent,
            #businessBenefitsPopupContent {
                max-height: 85vh !important;
                margin: 0 auto !important;
            }
            
            /* Force popup headers to match mobile */
            #combinedSpecializationsPopup div[style*="padding: 24px"],
            #businessBenefitsPopup div[style*="padding: 24px"] {
                padding: 16px !important;
            }
            
            /* Force save buttons to be exactly like mobile */
            #saveCombinedSpecializations,
            #saveBusinessBenefits,
            #saveRestrictions {
                width: 120px !important;
                font-size: 14px !important;
                padding: 10px 12px !important;
                min-height: 44px !important;
            }
            
            /* Force category buttons to match mobile */
            .set-primary-btn {
                width: 90px !important;
                height: 32px !important;
                font-size: 12px !important;
                padding: 4px 8px !important;
                min-height: 32px !important;
            }
            
            /* Force popup category headers to match mobile height */
            #combinedSpecializationsPopup div[style*="padding: 10px"],
            #businessBenefitsPopup div[style*="padding: 10px"] {
                padding: 10px !important;
            }
        }

        /* Live Preview Section - Force consistent styling across all devices */
        #livePreviewSection {
            padding: 20px 32px !important;
            margin: 60px 0 !important;
            border: 2px dashed #6366f1 !important;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)) !important;
            border-radius: 12px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
        }

        #livePreviewSection h3 {
            text-align: center !important;
            margin-top: 0 !important;
            font-size: 24px !important;
            font-weight: 700 !important;
            color: var(--text-primary) !important;
        }

        #livePreviewSection h4 {
            text-align: center !important;
            color: var(--text-secondary) !important;
            font-weight: 400 !important;
            margin-top: 8px !important;
            margin-bottom: 20px !important;
        }

        #generatePreviewBtn {
            width: auto !important;
            padding: 12px 24px !important;
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            color: white !important;
            border: none !important;
            border-radius: 8px !important;
            font-size: 16px !important;
            font-weight: 600 !important;
            cursor: pointer !important;
            margin: 20px auto 0 auto !important;
            display: block !important;
        }

        /* Responsive adjustments for Live Preview */
        @media (max-width: 768px) {
            #livePreviewSection {
                padding: 16px 20px !important;
                margin: 40px 0 !important;
            }
        }

        @media (max-width: 480px) {
            #livePreviewSection {
                padding: 12px 12px 4px 12px !important;
                margin: 24px 0 !important;
            }

            #livePreviewSection h3 {
                font-size: 20px !important;
            }

            #livePreviewSection h4 {
                font-size: 14px !important;
                margin-bottom: 12px !important;
            }

            #generatePreviewBtn {
                font-size: 14px !important;
                padding: 10px 20px !important;
                margin: 0 auto !important;
            }
        }

        /* Facebook-style posts and comments - Force consistent styling across all devices */
        .facebook-post-card {
            background: #ffffff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            padding: 20px !important;
            min-height: 300px !important;
        }

        .post-header {
            display: flex !important;
            align-items: center !important;
            padding: 12px 16px !important;
            border-bottom: 1px solid #f0f2f5 !important;
        }

        .post-content {
            padding: 16px !important;
            color: #1c1e21 !important;
            line-height: 1.5 !important;
            font-size: 15px !important;
            min-height: 60px !important;
            display: flex !important;
            align-items: center !important;
        }

        .facebook-post-card h4 {
            font-size: 16px !important;
            margin-bottom: 12px !important;
            line-height: 1.4 !important;
        }

        .facebook-post-card p {
            font-size: 14px !important;
            line-height: 1.5 !important;
            margin-bottom: 8px !important;
        }

        .facebook-post-card .response {
            background: #f8fafc !important;
            border-right: 4px solid #6366f1 !important;
            padding: 15px !important;
            margin-top: 12px !important;
            border-radius: 8px !important;
        }

        .comments-section {
            background: #f8f9fa !important;
            border: 1px solid #dddfe2 !important;
            border-radius: 8px !important;
            margin-bottom: 20px !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1) !important;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif !important;
            padding: 0 !important;
            border-top: 1px solid #f0f2f5 !important;
            min-height: 80px !important;
        }

        .comment {
            display: flex !important;
            align-items: flex-start !important;
            padding: 12px 16px !important;
            border-bottom: 1px solid #f0f2f5 !important;
        }

        .comment-avatar {
            width: 32px !important;
            height: 32px !important;
            border-radius: 50% !important;
            background: #6366f1 !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 600 !important;
            font-size: 14px !important;
            margin-left: 8px !important;
        }

        .comment-content {
            flex: 1 !important;
        }

        .comment-author {
            font-weight: 600 !important;
            color: #365899 !important;
            font-size: 13px !important;
            margin-bottom: 2px !important;
        }

        .comment-time {
            color: #90949c !important;
            font-size: 12px !important;
            margin-bottom: 4px !important;
        }

        .comment-text {
            padding: 0 16px 12px !important;
            color: #1c1e21 !important;
            line-height: 1.34 !important;
            font-size: 15px !important;
        }

        .post-interactions {
            border-top: 1px solid #f0f2f5 !important;
            padding: 8px 16px !important;
        }

        .interactions-bar {
            display: flex !important;
            justify-content: space-between !important;
            padding: 0 4px !important;
            gap: 8px !important;
            height: 30px !important;
        }

        .interaction-btn {
            flex: 1 !important;
            padding: 0 8px !important;
            font-size: 13px !important;
            text-align: center !important;
            background-color: transparent !important;
            border-radius: 6px !important;
            border: none !important;
            color: #65676b !important;
            height: 30px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            line-height: 1 !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            transition: background-color 0.2s ease !important;
        }

        .interaction-btn:hover {
            background-color: #f0f2f5 !important;
        }

        /* Post avatar and meta elements */
        .post-avatar {
            width: 40px !important;
            height: 40px !important;
            border-radius: 50% !important;
            background: #1877f2 !important;
            color: white !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            margin-left: 12px !important;
        }

        .post-meta {
            flex: 1 !important;
        }

        .post-author {
            font-weight: 600 !important;
            color: #1c1e21 !important;
            font-size: 15px !important;
            margin-bottom: 2px !important;
        }

        .post-time {
            color: #65676b !important;
            font-size: 13px !important;
        }

        /* Single consistent styling - no device variations */
        /* All devices get the same mobile-optimized design */

        /* API Status Indicator */
        .api-status-indicator {
            background: #fef3c7 !important;
            border: 1px solid #f59e0b !important;
            border-radius: 8px !important;
            padding: 12px 16px !important;
            margin-bottom: 20px !important;
            text-align: center !important;
            font-size: 14px !important;
            color: #92400e !important;
            display: none !important;
        }

        .api-status-indicator.show {
            display: block !important;
        }

        .api-status-indicator strong {
            color: #78350f !important;
        }

        /* Mobile styles (480px and below) */
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }

            .main-wrapper {
                padding: 20px 0;
            }

            .page-header {
                margin-bottom: 12px;
            }

            .page-header h1 {
                font-size: 1.5em;
                margin-bottom: 12px;
            }

            .page-header p {
                font-size: 0.875em;
            }

            .brand-tag {
                font-size: 0.8em;
                padding: 6px 12px;
                margin-bottom: 16px;
            }

            .form-section {
                padding: 8px 16px 16px 16px;
                margin-bottom: 24px;
            }

            .form-section h3 {
                font-size: 24px;
                margin-bottom: 0px;
            }

            .form-group {
                gap: 14px;
                margin-bottom: 24px;
            }

            .form-input, .work-area-select, .radio-item {
                height: 44px;
                padding: 10px 14px;
                font-size: 14px;
                border-width: 1px;
            }

            .form-label {
                font-size: 16px;
                margin-bottom: 0;
            }

            .question-number {
                font-size: 16px;
                margin-left: 8px;
            }


            /* Mobile display adjustments */
            #businessBenefitsDisplay {
                height: auto;
                min-height: 44px;
                padding: 10px 14px;
            }

            /* Mobile radio buttons - yes/no specific */
            .radio-group.yes-no {
                flex-direction: row;
                gap: 8px;
            }

            .radio-group.yes-no .radio-item {
                flex: 1;
                min-width: auto;
                max-width: none;
                text-align: center;
                justify-content: center;
            }
            
            /* Mobile radio buttons - regular groups stay vertical */
            .radio-group:not(.yes-no) {
                flex-direction: column;
                gap: 8px;
            }
            
            .radio-group:not(.yes-no) .radio-item {
                width: 100%;
                justify-content: flex-start;
                text-align: right;
                padding: 12px 16px;
                height: 44px;
                gap: 10px;
            }
            
            .radio-group:not(.yes-no) .radio-item span {
                line-height: 1.4;
                word-wrap: break-word;
            }

            /* Mobile tags - removed duplicate, handled below */

            .contact-form button {
                padding: 12px 16px;
                font-size: 14px;
                height: 48px;
            }

            /* Fix mobile touch targets */
            .fas {
                font-size: 14px;
            }

            
            
            /* Mobile business benefits display */
            #businessBenefitsDisplay {
                padding: 10px 14px !important;
                border-width: 1px !important;
                font-size: 14px !important;
            }
            
            #businessBenefitsDisplay span {
                font-size: 14px !important;
            }
            
            #specializationsDisplay {
                padding: 10px 14px !important;
                border-width: 1px !important;
                font-size: 14px !important;
            }
            
            #specializationsDisplay span {
                font-size: 14px !important;
            }
            
            /* Mobile: Special input types */
            .business-benefit-input,
            .restriction-input {
                font-size: 14px !important;
                padding: 10px 14px 10px 35px !important;
                text-align: right !important;
            }
            

            /* Mobile preview button */
            #generatePreviewBtn {
                width: 100% !important;
                padding: 16px 20px !important;
                font-size: 14px !important;
                margin: 20px 0 !important;
                white-space: normal !important;
                line-height: 1.4 !important;
                height: auto !important;
                min-height: 50px !important;
                word-wrap: break-word !important;
                overflow-wrap: break-word !important;
                text-align: center !important;
                display: block !important;
                box-sizing: border-box !important;
            }

            /* Mobile preview container spacing */
            #previewContainer {
                margin-top: 30px !important;
            }

            /* All post styling now handled by single global CSS system above */
            
            /* Ensure popup mobile responsiveness */
            #combinedSpecializationsPopupContent,
            #businessBenefitsPopupContent {
                margin: 0 auto !important;
                max-height: 85vh !important;
                max-width: calc(100vw - 20px) !important;
            }
            
            /* Popup headers compact on mobile */
            #combinedSpecializationsPopup .popup-header,
            #businessBenefitsPopup .popup-header {
                padding: 16px !important;
            }
            
            /* Popup titles readable on mobile */
            #combinedSpecializationsPopup h3,
            #businessBenefitsPopup h3 {
                font-size: 18px !important;
            }
            
            /* Save buttons touch-friendly */
            #saveCombinedSpecializations,
            #saveBusinessBenefits,
            #saveRestrictions {
                min-height: 44px !important;
                width: 120px !important;
                padding: 12px !important;
                font-size: 14px !important;
            }
            
            /* Category buttons in popups - mobile friendly */
            .set-primary-btn {
                width: 90px !important;
                height: 32px !important;
                font-size: 12px !important;
                padding: 4px 8px !important;
                min-height: 32px !important;
            }
        }
            
        /* Preview Section Styles */
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            .preview-btn:hover {
                background: linear-gradient(135deg, #5b64f0, #7c3aed) !important;
                transform: translateY(-1px);
                box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
            }
            
            .preview-post {
                background: #f8fafc;
                border: 1px solid #e2e8f0;
                border-radius: 8px;
                padding: 16px;
                margin-bottom: 16px;
            }
            
            .preview-post-content {
                background: white;
                padding: 12px;
                border-radius: 6px;
                margin-bottom: 12px;
                border-left: 4px solid #3b82f6;
            }
            
            .preview-response {
                background: #f0f9ff;
                border: 1px solid #0ea5e9;
                border-radius: 6px;
                padding: 12px;
                margin-top: 8px;
            }
            
            .preview-response-header {
                font-weight: 600;
                color: #0c4a6e;
                margin-bottom: 8px;
                display: flex;
                align-items: center;
                gap: 8px;
            }
            
            .preview-response-content {
                color: #334155;
                line-height: 1.6;
                white-space: pre-wrap;
            }

            
            /* Mobile textarea */
            .form-textarea {
                font-size: 14px !important;
                padding: 10px 14px !important;
            }
            
            
            
            /* Mobile specific spacing fixes */
            .form-section {
                margin-bottom: 40px !important;
            }
            
            .form-group {
                gap: 14px;
                margin-bottom: 22px !important;
            }
            
            /* Mobile viewport fix */
            body {
                -webkit-text-size-adjust: 100%;
                -webkit-font-smoothing: antialiased;
            }
            
            /* Mobile: All tag elements */
            .work-area-tag, 
            .business-benefit-tag {
                font-size: 12px !important;
                padding: 4px 8px !important;
                margin: 2px !important;
            }
            
            /* Mobile: Reset margins for all dynamic containers */
            .work-area-tags,
            .business-benefits-tags, 
            .restriction-tags {
                margin-top: 0 !important;
            }
            
            /* Mobile button improvements */
            .contact-form button:hover {
                transform: none;
            }
            

        /* Image Upload Section Styles */
        .image-upload-btn {
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            padding: 14px 32px !important;
            background: linear-gradient(135deg, #6366f1, #8b5cf6) !important;
            color: white !important;
            border-radius: 8px !important;
            cursor: pointer !important;
            text-align: center !important;
            font-weight: 600 !important;
            font-size: 16px !important;
            transition: all 0.2s !important;
            border: none !important;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2) !important;
        }

        .image-upload-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3) !important;
        }

        .image-upload-btn:active {
            transform: translateY(0) !important;
        }

        .image-upload-btn svg {
            flex-shrink: 0 !important;
        }

        .image-preview-container {
            display: none;
            position: relative !important;
            border: 2px dashed #e5e7eb !important;
            border-radius: 8px !important;
            padding: 20px !important;
            text-align: center !important;
            background: #fafafa !important;
        }

        .remove-image-btn {
            position: absolute !important;
            top: 12px !important;
            right: 12px !important;
            background: #ef4444 !important;
            color: white !important;
            border: none !important;
            border-radius: 50% !important;
            width: 36px !important;
            height: 36px !important;
            min-width: 36px !important;
            min-height: 36px !important;
            max-width: 36px !important;
            max-height: 36px !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2) !important;
            z-index: 10 !important;
            padding: 0 !important;
        }

        .remove-image-btn:hover {
            background: #dc2626 !important;
            transform: scale(1.1) !important;
        }

        .remove-image-btn:active {
            transform: scale(0.95) !important;
        }

        .remove-image-btn svg {
            flex-shrink: 0 !important;
            width: 16px !important;
            height: 16px !important;
        }

        .image-preview {
            max-width: 100%;
            max-height: 300px;
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: block;
            margin: 0 auto;
        }

        .image-file-name {
            margin-top: 12px;
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        @media (max-width: 480px) {
            .image-upload-btn {
                width: 100%;
                padding: 12px 24px;
                font-size: 15px;
            }

            .remove-image-btn {
                width: 32px;
                height: 32px;
                top: 8px;
                right: 8px;
            }
        }

        /* Clean CSS architecture - single source of truth for all post styling */
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="container">
            <div class="page-header">
                <div class="brand-tag">Collabo AI Pro</div>
                <h1>טופס איסוף נתונים לבעל מקצוע</h1>
                <p>כדי ליצור עבורכם מערכת תגובות מותאמת אישית שתייצג אתכם בצורה הכי טובה, אנחנו צריכים לאסוף מספר פרטים חשובים.</p>
            </div>

            <form class="contact-form" id="clientForm">
                <!-- פרטים בסיסיים -->
                <div class="form-section">
                    <h3>פרטים בסיסיים</h3>
                    <div class="section-description">
                        פרטים בסיסיים ליצירת זהות מקצועית ברורה בתגובות.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">1.</span>
                            מה השם שלכם? <strong>(כפי שתרצו שיופיע בתגובות)</strong>:
                        </label>
                        <input type="text" class="form-input" name="client_name" placeholder="לדוגמה: משה, דני הטכנאי, אליהו" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">2.</span>
                            כמה שנים העסק שלכם פעיל?
                        </label>
                        <input type="number" class="form-input" name="experience_years" placeholder="לדוגמה: 12" required min="1" max="50">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">3.</span>
                            מספר טלפון ליצירת קשר:
                        </label>
                        <input type="tel" class="form-input" name="phone_number" placeholder="לדוגמה: 050-1234567" required style="text-align: right;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">4.</span>
                            מספר לקוח (זאפ):
                        </label>
                        <input type="text" class="form-input" name="zap_customer_number" placeholder="לדוגמה: 12345" style="text-align: right;">
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">5.</span>
                            כתובת העסק (לא חובה):
                        </label>
                        <input type="text" class="form-input" name="address" placeholder="לדוגמה: רחוב הרצל 123, תל אביב" style="text-align: right;">
                    </div>
                </div>

                <!-- תחומי פעילות, התמחויות ואזורי שירות -->
                <div class="form-section">
                    <h3>תחומי פעילות, התמחויות ואזורי שירות</h3>
                    <div class="section-description">
                        בחרו תחומי פעילות והתמחויות, ולאחר מכן הגדירו באילו אזורים אתם מספקים כל שירות.
                        תחום ראשי - ההתמחויות תחתיו יקבלו את מירב הפניות (עדיפות ראשונה).
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">6.</span>
                            תחומי פעילות והתמחויות:
                        </label>

                        <div id="combinedSpecializationsContainer" style="position: relative;">
                            <div id="combinedSpecializationsDisplay" class="form-input" tabindex="0" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; position: relative; font-size: 14px;">
                                <span id="combinedSpecializationsPlaceholder" style="color: var(--text-muted);">לחצו לבחירת תחומים והתמחויות</span>
                                <i class="fas fa-chevron-down" style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>

                            <!-- Hidden inputs for form submission -->
                            <input type="hidden" id="primaryFieldHidden" name="primary_field" required>
                        </div>

                        <!-- Subcategory Table - appears after selections made -->
                        <div id="subcategoryTableContainer" style="display: none; margin-top: 16px;">
                            <table class="subcategory-table">
                                <thead>
                                    <tr>
                                        <th>התמחות/תחום</th>
                                        <th>אזורי שירות</th>
                                    </tr>
                                </thead>
                                <tbody id="subcategoryTableBody">
                                    <!-- Table rows will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>

                        <!-- Combined Specializations Popup Modal -->
                        <div id="combinedSpecializationsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 9999; overflow-y: auto;">
                            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                                <div id="combinedSpecializationsPopupContent" style="background: white; border-radius: var(--border-radius); border: 1px solid var(--border-light); max-width: 700px; width: 100%; max-height: 85vh; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                                    <!-- Popup Header -->
                                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--border-light);">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">בחירת תחומים והתמחויות</h3>
                                            <button type="button" id="closeCombinedSpecializationsPopup" style="background: none; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">לחיצה על תחום בוחרת את כל ההתמחויות תחתיו. ניתן גם לבחור התמחויות בודדות.</p>
                                    </div>

                                    <!-- Search Section - Fixed -->
                                    <div id="combinedSearchSection" style="padding: 16px 20px; border-bottom: 1px solid var(--border-light); background: #f9fafb;">
                                        <input type="text" id="combinedSearchInput" placeholder="חיפוש תחומים והתמחויות..."
                                               style="width: 100%; padding: 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 14px;">
                                    </div>

                                    <!-- Popup Content - Scrollable -->
                                    <div id="combinedSpecializationsPopupBody" style="flex: 1; overflow-y: auto; min-height: 0;">
                                    </div>

                                    <!-- Popup Footer -->
                                    <div style="padding: 16px; border-top: 1px solid var(--border-light); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center; background: var(--bg-gray);">
                                        <div id="selectedCombinedCount" style="color: var(--text-secondary); font-size: 14px;">לא נבחרו התמחויות</div>
                                        <button type="button" id="saveCombinedSpecializations" style="background: var(--ai-purple); color: white; border: none; padding: 10px 20px; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; font-weight: 500;">שמור בחירות</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Edit Modal -->
                        <div id="locationEditModal" class="location-modal-overlay">
                            <div class="location-modal-container">
                                <div class="location-modal-content">
                                    <!-- Modal Header -->
                                    <div class="location-modal-header">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 id="locationEditModalTitle" class="location-modal-title">בחירת אזורי שירות</h3>
                                            <button type="button" id="closeLocationEditModal" class="location-modal-close">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 13px;">בחרו נפות (אזורים). לחיצה על עיר תבחר את הנפה שלה.</p>
                                    </div>

                                    <!-- Search Section -->
                                    <div class="location-search-section">
                                        <input type="text" id="locationSearchInput" class="location-search-input" placeholder="חיפוש מחוז, נפה או עיר...">
                                    </div>

                                    <!-- Modal Content - Location Hierarchy -->
                                    <div class="location-modal-body" id="locationHierarchyContainer">
                                        <!-- Location hierarchy will be populated by JavaScript -->
                                    </div>

                                    <!-- Modal Footer -->
                                    <div class="location-modal-footer">
                                        <div id="selectedLocationCount" class="location-count-text">לא נבחרו מיקומים</div>
                                        <button type="button" id="saveLocationEdit" class="save-locations-btn">שמור שינויים</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- יתרונות עסקיים -->
                <div class="form-section">
                    <h3>יתרונות עסקיים</h3>
                    <div class="section-description">
                        הוסיפו לפחות 4 יתרונות עסקיים שמייחדים אתכם מהמתחרים ומושכים לקוחות.
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <span class="question-number">7.</span>
                            בחרו יתרונות עסקיים <strong>(לפחות 4 יתרונות)</strong>
                        </label>
                        
                        <div id="businessBenefitsContainer" style="position: relative;">
                            <div id="businessBenefitsDisplay" class="form-input" tabindex="-1" style="cursor: pointer; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; position: relative; font-size: 14px;">
                                <span id="businessBenefitsPlaceholder" style="color: var(--text-muted);">לחצו לבחירת יתרונות עסקיים</span>
                                <i class="fas fa-chevron-down" style="position: absolute; left: 16px; top: 16px; color: var(--text-muted);"></i>
                            </div>
                        </div>
                        
                        <!-- Business Benefits Popup Modal -->
                        <div id="businessBenefitsPopup" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.3); z-index: 9999; overflow-y: auto;">
                            <div style="display: flex; align-items: center; justify-content: center; min-height: 100vh; padding: 20px;">
                                <div id="businessBenefitsPopupContent" style="background: white; border-radius: var(--border-radius); border: 1px solid var(--border-light); max-width: 700px; width: 100%; max-height: 85vh; position: relative; overflow: hidden; display: flex; flex-direction: column;">
                                    <!-- Popup Header -->
                                    <div style="padding: 24px 24px 16px 24px; border-bottom: 1px solid var(--border-light);">
                                        <div style="display: flex; align-items: center; justify-content: space-between;">
                                            <h3 style="margin: 0; font-size: 20px; font-weight: 600; color: var(--text-primary);">בחירת יתרונות עסקיים</h3>
                                            <button type="button" class="popup-close" style="background: none; color: var(--text-muted); border: none; font-size: 24px; cursor: pointer; padding: 0; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                                        </div>
                                        <p style="margin: 8px 0 0 0; color: var(--text-secondary); font-size: 14px;">בחרו לפחות 4 יתרונות עסקיים שמייחדים אתכם מהמתחרים ומושכים לקוחות</p>
                                    </div>
                                    
                                    <!-- Popup Content - Scrollable -->
                                    <div id="businessBenefitsPopupBody" style="flex: 1; overflow-y: auto; min-height: 0;">
                                    </div>
                                    
                                    <!-- Popup Footer -->
                                    <div style="padding: 16px; border-top: 1px solid var(--border-light); flex-shrink: 0; display: flex; justify-content: space-between; align-items: center;">
                                        <div id="selectedBusinessBenefitsCount" style="color: var(--text-secondary); font-size: 14px;">לא נבחרו יתרונות</div>
                                        <button type="button" id="saveBusinessBenefits" style="background: var(--ai-purple); color: white; border: none; padding: 10px 12px; border-radius: var(--border-radius); font-size: 14px; cursor: pointer; font-weight: 500; width: 120px;">שמור בחירות</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="business-benefits-tags" id="businessBenefitsTags" style="margin-top: 12px;"></div>

                        <!-- Editable notice for business benefits -->
                        <div id="businessBenefitsEditableNotice" style="display: none; margin-top: 12px; padding: 12px; background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; color: #0369a1; font-size: 14px;">
                            💡 שימו לב שניתן ומומלץ לערוך את הטקסט של היתרונות שבחרתם, להכניס התאמות, הערות וכדומה...
                        </div>
                    </div>
                </div>



                <!-- נושאים להימנעות בתגובות -->
                <div class="form-section">
                    <h3>נושאים להימנעות בתגובות</h3>
                    <div class="section-description">
                        הגדירו נושאים להימנעות בתגובות. זה שומר על מקצועיות ומתאים לפרופיל שלכם. אם אין לכם הגבלות מיוחדות, דלגו על השאלה.
                    </div>

                    <div class="form-group">
                        <label class="form-label" style="position: relative;">
                            <span class="question-number">8.</span>
                            יש נושאים שאתם מעדיפים להימנע מהם בתגובות? <strong>(עד 5 נושאים)</strong>
                            <i class="fas fa-lightbulb restriction-tooltip-trigger" style="color: #f59e0b; margin-right: 8px; cursor: pointer; font-size: 16px; transition: all 0.2s; animation: lightbulb-glow 2s ease-in-out infinite;"></i>
                            <div class="restriction-tooltip" id="restrictionTooltip" style="
                                display: none;
                                position: absolute;
                                background: white;
                                border: 2px solid #f59e0b;
                                padding: 16px 20px;
                                border-radius: 12px;
                                font-size: 14px;
                                max-width: 350px;
                                z-index: 1000;
                                top: 100%;
                                right: 0;
                                margin-top: 8px;
                                box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
                                line-height: 1.6;
                                color: var(--text-primary);
                            "></div>
                        </label>
                        
                        <div id="restrictionsContainer">
                            <div id="restrictionFields">
                                <!-- שדה ראשון -->
                                <div class="restriction-field-wrapper" style="position: relative; margin-bottom: 12px;">
                                    <input type="text" class="form-input restriction-field" placeholder="לדוגמה: לא לדבר על מחירים">
                                    <button type="button" class="remove-restriction-btn" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #dc2626; font-size: 18px; cursor: pointer; width: 24px; height: 24px; display: none; align-items: center; justify-content: center;">×</button>
                                </div>
                            </div>
                            
                            <div id="addRestrictionContainer" style="display: flex; align-items: center; gap: 12px; margin-top: 12px; cursor: pointer; padding: 8px; border-radius: 6px; transition: background-color 0.2s;" onmouseover="this.style.backgroundColor='rgba(76, 29, 149, 0.05)'" onmouseout="this.style.backgroundColor='transparent'">
                                <button type="button" id="addRestrictionBtn" style="
                                    background: var(--ai-purple);
                                    color: white;
                                    border: none;
                                    padding: 12px;
                                    border-radius: 5px;
                                    cursor: pointer;
                                    font-size: 14px;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    justify-content: center;
                                    width: 20px;
                                    height: 20px;
                                    pointer-events: none;
                                ">
                                    <i class="fas fa-plus"></i>
                                </button>
                                <span id="restrictionCounter" style="color: var(--text-secondary); font-size: 14px; pointer-events: none;">הוסף נושא נוסף (עד 5 מקסימום)</span>
                            </div>
                        </div>

                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="form-section">
                    <h3>הוספת תמונה (לא חובה)</h3>
                    <p style="color: var(--text-secondary); margin-bottom: 20px;">
                        העלה תמונה שתצורף אוטומטית לכל התגובות של הסוכן שלך (לוגו, תמונה מייצגת של העסק, וכו')
                    </p>

                    <div style="display: flex; flex-direction: column; gap: 16px;">
                        <label for="commentImage" class="image-upload-btn">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: 8px; vertical-align: middle;">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <circle cx="8.5" cy="8.5" r="1.5"></circle>
                                <polyline points="21 15 16 10 5 21"></polyline>
                            </svg>
                            בחר תמונה
                            <input type="file" id="commentImage" name="comment_image" accept="image/png, image/jpeg, image/jpg" style="display: none;">
                        </label>

                        <div id="imagePreviewContainer" class="image-preview-container">
                            <button type="button" id="removeImageBtn" class="remove-image-btn" title="הסר תמונה">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="flex-shrink: 0;">
                                    <line x1="18" y1="6" x2="6" y2="18"></line>
                                    <line x1="6" y1="6" x2="18" y2="18"></line>
                                </svg>
                            </button>
                            <img id="imagePreview" src="" alt="תצוגה מקדימה" class="image-preview">
                            <p id="imageFileName" class="image-file-name"></p>
                        </div>
                    </div>
                </div>

                <!-- Live Preview Section -->
                <div class="form-section" id="livePreviewSection" style="display: block;">
                    <h3 style="text-align: center; margin-top: 0;">תצוגה מקדימה - איך הסוכן שלך יגיב לפוסטים</h3>
                    <h4 style="text-align: center; color: var(--text-secondary); font-weight: 400; margin-top: 8px; margin-bottom: 20px;">לפני שליחת הטופס, בואו נראה איך הסוכן שלך יגיב לפוסטים דומים בתחום שלך</h4>
                    
                    <button type="button" id="generatePreviewBtn" class="preview-btn" style="width: auto; padding: 12px 24px; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin: 20px auto 0 auto; display: block;">
                        🚀 תראה לי איך הסוכן שלי מגיב לפוסטים
                    </button>
                    
                    <div id="previewContainer" style="display: none;">
                        <div id="previewLoading" style="text-align: center; padding: 20px; display: none;">
                            <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                            <p style="margin-top: 10px; color: #6b7280;">יוצר דוגמאות פוסטים ותשובות...</p>
                        </div>
                        
                        <!-- API Status Indicator -->
                        <div id="apiStatusIndicator" class="api-status-indicator">
                            <strong>📡 מצב דמו:</strong> אין חיבור לשרת AI - התגובות שמוצגות הן לדוגמה בלבד
                        </div>
                        
                        <div id="previewResults"></div>
                    </div>
                </div>

                <button type="submit" id="submitBtn">שלח טופס</button>
            </form>

            <div class="footer-info">
                ✅ בסיום המילוי, הטופס יישלח אלינו אוטומטית.<br>
                ⏰ תהליך הכנת המערכת לוקח 24-48 שעות לאחר קבלת הטופס המלא.
                <div class="brand">
                    תודה רבה על הסבלנות! 🙏<br>
                    צוות Collabo AI
                </div>
            </div>
        </div>
    </div>

    <script>
        // Function to format links in text
        function formatLinksInText(text) {
            if (!text) return text;
            
            
            // Convert line breaks to <br> tags first
            let formattedText = text.replace(/\n/g, '<br>');
            
            // Remove automatic period line breaks - handle manually by content structure
            
            // Convert WhatsApp URLs to clickable links - more aggressive regex
            const whatsappRegex = /(https:\/\/wa\.me\/[^\s<>\n]+)/g;
            const matches = formattedText.match(whatsappRegex);
            
            if (matches) {
                matches.forEach(match => {
                    const clickableLink = `<br><a href="${match}" target="_blank" rel="noopener noreferrer" style="color: #25d366; text-decoration: none; font-weight: 500; display: block; margin-top: 8px; direction: ltr;">${match}</a>`;
                    formattedText = formattedText.replace(match, clickableLink);
                });
            }
            
            return formattedText;
        }

        // API Configuration
        const API_BASE_URL = 'https://worthy-choice-badger.ngrok-free.app';

        document.addEventListener('DOMContentLoaded', function() {
            // Load categories and subcategories from JSON
            let categoriesData = [];
            let professions = [];
            let specializations = {};
            
            // District hierarchy data
            let districtData = {};
            let workAreaOptions = [];

            // Load district hierarchy data
            async function loadDistrictData() {
                try {
                    const response = await fetch('district_hierarchy.json');
                    districtData = await response.json();
                    
                    // Extract district names for work areas dropdown
                    workAreaOptions = districtData.Districts.map(district => district.District);
                    workAreaOptions.push('כל הארץ'); // Add "All Country" option
                    
                    console.log('District hierarchy loaded:', workAreaOptions);
                } catch (error) {
                    console.error('Failed to load district_hierarchy.json:', error);
                    
                    // Use dummy district data with same structure as JSON
                    districtData = {
                        "Districts": [
                            {
                                "Counties": [
                                    {
                                        "County": "תל אביב",
                                        "Cities": [
                                            "תל אביב - יפו",
                                            "הרצליה",
                                            "רמת השרון"
                                        ]
                                    },
                                    {
                                        "County": "רמת גן",
                                        "Cities": [
                                            "רמת גן",
                                            "בני ברק",
                                            "גבעתיים"
                                        ]
                                    }
                                ],
                                "District": "גוש דן"
                            },
                            {
                                "Counties": [
                                    {
                                        "County": "ירושלים",
                                        "Cities": [
                                            "ירושלים",
                                            "בית שמש",
                                            "מבשרת ציון"
                                        ]
                                    }
                                ],
                                "District": "ירושלים והסביבה"
                            },
                            {
                                "Counties": [
                                    {
                                        "County": "חיפה",
                                        "Cities": [
                                            "חיפה",
                                            "נשר",
                                            "קרית מוצקין"
                                        ]
                                    }
                                ],
                                "District": "חיפה והסביבה"
                            },
                            {
                                "Counties": [
                                    {
                                        "County": "באר שבע",
                                        "Cities": [
                                            "באר שבע",
                                            "דימונה",
                                            "אשקלון"
                                        ]
                                    }
                                ],
                                "District": "דרום"
                            }
                        ]
                    };
                    
                    workAreaOptions = districtData.Districts.map(district => district.District);
                    workAreaOptions.push('כל הארץ');
                    
                    console.warn('Using dummy district data due to load failure');
                    
                    // Display warning in work areas section
                    const workAreaSection = document.querySelector('.work-area-select-container')?.closest('.form-group');
                    if (workAreaSection) {
                        const warningBanner = document.createElement('div');
                        warningBanner.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 20px; text-align: center;';
                        warningBanner.innerHTML = `
                            <strong>⚠️ שים לב!</strong><br>
                            קובץ המחוזות (district_hierarchy.json) לא נטען. המחוזות המוצגים למטה הם מחוזות דמה בלבד!
                        `;
                        workAreaSection.insertBefore(warningBanner, workAreaSection.firstChild);
                    }
                }
            }
            
            // Load JSON data
            async function loadCategoriesData() {
                try {
                    // Try to fetch from file first
                    const response = await fetch('categories.json');
                    categoriesData = await response.json();
                    
                    // Extract categories for professions dropdown - only Category names
                    professions = categoriesData.map(item => item.Category);
                    
                    // Extract subcategories for specializations (question 5) - only Category and Name fields
                    specializations = {};
                    categoriesData.forEach(item => {
                        if (item.Subcategories && item.Subcategories.length > 0) {
                            specializations[item.Category] = item.Subcategories.map(sub => sub.Name);
                        }
                    });
                    
                    console.log('Categories loaded:', professions);
                    console.log('Specializations loaded:', specializations);
                } catch (error) {
                    console.error('Failed to load categories.json:', error);

                    // Use dummy categories for testing
                    categoriesData = [
                        {
                            "Category": "חשמל",
                            "Subcategories": [
                                {"Name": "התקנת נקודות חשמל"},
                                {"Name": "לוחות חשמל"},
                                {"Name": "תשתיות חשמל"},
                                {"Name": "תיקונים כלליים"}
                            ]
                        },
                        {
                            "Category": "אינסטלציה",
                            "Subcategories": [
                                {"Name": "התקנת כלים סניטריים"},
                                {"Name": "איתור נזילות"},
                                {"Name": "תשתיות אינסטלציה"},
                                {"Name": "החלפת צנרת"},
                                {"Name": "תיקונים כלליים"}
                            ]
                        },
                        {
                            "Category": "שיפוצים",
                            "Subcategories": [
                                {"Name": "שיפוץ דירות/משרדים"}
                            ]
                        },
                        {
                            "Category": "מיזוג אוויר",
                            "Subcategories": [
                                {"Name": "התקנת מזגנים"},
                                {"Name": "התקנת מיני מרכזי"},
                                {"Name": "ניקוי מזגנים"},
                                {"Name": "תיקונים כלליים"}
                            ]
                        }
                    ];

                    professions = categoriesData.map(item => item.Category);
                    specializations = {};
                    categoriesData.forEach(item => {
                        if (item.Subcategories && item.Subcategories.length > 0) {
                            specializations[item.Category] = item.Subcategories.map(sub => sub.Name);
                        }
                    });

                    console.warn('Using dummy categories due to load failure');

                    // Display warning in categories section
                    const categoriesSection = document.getElementById('combinedSpecializationsDisplay')?.closest('.form-section');
                    if (categoriesSection) {
                        const warningBanner = document.createElement('div');
                        warningBanner.style.cssText = 'background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 16px; margin-bottom: 20px; text-align: center;';
                        warningBanner.innerHTML = `
                            <div style="color: #856404; font-weight: 600; font-size: 18px; margin-bottom: 8px;">
                                ⚠️ שגיאה בטעינת קטגוריות
                            </div>
                            <div style="color: #856404; font-size: 14px;">
                                קובץ הקטגוריות (categories.json) לא נטען. הקטגוריות המוצגות למטה הן קטגוריות דמה בלבד!
                            </div>
                        `;
                        categoriesSection.insertBefore(warningBanner, categoriesSection.firstChild.nextSibling);
                    }
                }
            }
            
            // ===========================================
            // COMBINED CATEGORY-LOCATION FUNCTIONALITY
            // ===========================================

            // State variables
            let primaryField = null;
            // Map: subcategoryKey => { category, subcategory, locations: null | [{district, counties: []}] }
            let selectedSubcategories = new Map();
            let expandedCategories = new Set();

            // Current editing state for location modal
            let currentEditingSubcategoryKey = null;
            let tempSelectedCounties = new Set(); // Temporary selection during modal editing

            // Helper to create subcategory key
            function getSubcategoryKey(category, subcategory) {
                return `${category}|${subcategory}`;
            }

            // Helper to parse subcategory key
            function parseSubcategoryKey(key) {
                const [category, subcategory] = key.split('|');
                return { category, subcategory };
            }

            // Initialize combined specializations popup functionality
            function initializeCombinedSpecializationsPopup() {
                const display = document.getElementById('combinedSpecializationsDisplay');
                const popup = document.getElementById('combinedSpecializationsPopup');
                const closeBtn = document.getElementById('closeCombinedSpecializationsPopup');
                const saveBtn = document.getElementById('saveCombinedSpecializations');
                const searchInput = document.getElementById('combinedSearchInput');

                if (!display || !popup) return;

                // Open popup on click
                display.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    openCombinedSpecializationsPopup();
                });

                // Close popup handlers
                closeBtn?.addEventListener('click', closeCombinedSpecializationsPopup);
                popup.addEventListener('click', function(e) {
                    if (e.target === popup) {
                        closeCombinedSpecializationsPopup();
                    }
                });

                // Save selections handler
                saveBtn?.addEventListener('click', saveCombinedSpecializations);

                // Search functionality
                searchInput?.addEventListener('input', function() {
                    filterCombinedCategories(this.value);
                });

                // Initialize location modal
                initializeLocationModal();
            }

            function openCombinedSpecializationsPopup() {
                const popup = document.getElementById('combinedSpecializationsPopup');
                if (!popup) return;

                // Build popup content
                buildCombinedPopupContent();
                updateCombinedSelectionCount();

                // Show popup
                popup.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function closeCombinedSpecializationsPopup() {
                const popup = document.getElementById('combinedSpecializationsPopup');
                if (!popup) return;

                popup.style.display = 'none';
                document.body.style.overflow = '';

                // Clear search
                const searchInput = document.getElementById('combinedSearchInput');
                if (searchInput) searchInput.value = '';
            }

            function buildCombinedPopupContent() {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;

                popupBody.innerHTML = '';

                // Build categories and subcategories hierarchy
                Object.keys(specializations).forEach(category => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-hierarchy-item';
                    categoryDiv.dataset.categoryName = category;

                    // Check selection states
                    const categorySubcategories = specializations[category] || [];
                    const selectedInCategory = categorySubcategories.filter(sub =>
                        selectedSubcategories.has(getSubcategoryKey(category, sub))
                    );
                    const allSelected = selectedInCategory.length === categorySubcategories.length && categorySubcategories.length > 0;
                    const someSelected = selectedInCategory.length > 0 && !allSelected;
                    const isPrimary = primaryField === category;
                    const isExpanded = expandedCategories.has(category);

                    // Category header
                    const header = document.createElement('div');
                    header.className = `category-header${isExpanded ? ' expanded' : ''}`;
                    header.innerHTML = `
                        <span class="category-toggle">▶</span>
                        <input type="checkbox" class="category-checkbox" data-category="${category}"
                               ${allSelected ? 'checked' : ''}>
                        <span class="category-name">${category}</span>
                        ${isPrimary ? '<span class="primary-badge">תחום ראשי</span>' : ''}
                        <button type="button" class="set-primary-btn${isPrimary ? ' is-primary' : ''}" data-category="${category}">
                            ${isPrimary ? '🏆 ראשי' : 'הפוך לראשי'}
                        </button>
                    `;

                    // Set indeterminate state
                    const checkbox = header.querySelector('.category-checkbox');
                    if (someSelected) {
                        checkbox.indeterminate = true;
                    }

                    // Subcategories list
                    const subcatList = document.createElement('div');
                    subcatList.className = `subcategories-list${isExpanded ? ' expanded' : ''}`;

                    categorySubcategories.forEach(subcategory => {
                        const key = getSubcategoryKey(category, subcategory);
                        const isSelected = selectedSubcategories.has(key);

                        const subItem = document.createElement('div');
                        subItem.className = `subcategory-select-item${isSelected ? ' selected' : ''}`;
                        subItem.innerHTML = `
                            <input type="checkbox" class="subcategory-checkbox"
                                   data-category="${category}" data-subcategory="${subcategory}"
                                   ${isSelected ? 'checked' : ''}>
                            <span>${subcategory}</span>
                        `;
                        subcatList.appendChild(subItem);
                    });

                    categoryDiv.appendChild(header);
                    categoryDiv.appendChild(subcatList);
                    popupBody.appendChild(categoryDiv);
                });

                // Add event listeners
                addCombinedPopupEventListeners();
            }

            function addCombinedPopupEventListeners() {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;

                // Category header click - toggle expand
                popupBody.querySelectorAll('.category-header').forEach(header => {
                    header.addEventListener('click', function(e) {
                        // Don't toggle if clicking on checkbox or button
                        if (e.target.type === 'checkbox' || e.target.classList.contains('set-primary-btn')) {
                            return;
                        }
                        const category = this.closest('.category-hierarchy-item').dataset.categoryName;
                        toggleCategoryExpanded(category);
                    });
                });

                // Category checkbox - select/deselect all subcategories
                popupBody.querySelectorAll('.category-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const category = this.dataset.category;
                        toggleCategorySelection(category, this.checked);
                    });
                });

                // Subcategory checkbox
                popupBody.querySelectorAll('.subcategory-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const category = this.dataset.category;
                        const subcategory = this.dataset.subcategory;
                        toggleSubcategorySelection(category, subcategory, this.checked);
                    });
                });

                // Subcategory item click (on the row, not just checkbox)
                popupBody.querySelectorAll('.subcategory-select-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target.type === 'checkbox') return;
                        const checkbox = this.querySelector('.subcategory-checkbox');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });

                // Primary field buttons
                popupBody.querySelectorAll('.set-primary-btn').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const category = this.dataset.category;
                        setPrimaryField(category);
                    });
                });
            }

            function toggleCategoryExpanded(category) {
                if (expandedCategories.has(category)) {
                    expandedCategories.delete(category);
                } else {
                    expandedCategories.add(category);
                }
                buildCombinedPopupContent();
                updateCombinedSelectionCount();
            }

            function toggleCategorySelection(category, selected) {
                const subcategories = specializations[category] || [];

                subcategories.forEach(subcategory => {
                    const key = getSubcategoryKey(category, subcategory);
                    if (selected) {
                        if (!selectedSubcategories.has(key)) {
                            selectedSubcategories.set(key, {
                                category,
                                subcategory,
                                locations: null // null = never set, eligible for default inheritance
                            });
                        }
                    } else {
                        selectedSubcategories.delete(key);
                    }
                });

                // Auto-set primary if none set and selecting
                if (selected && !primaryField) {
                    primaryField = category;
                    document.getElementById('primaryFieldHidden').value = category;
                }

                // Clear primary if deselecting the primary category
                if (!selected && primaryField === category) {
                    primaryField = null;
                    document.getElementById('primaryFieldHidden').value = '';
                }

                buildCombinedPopupContent();
                updateCombinedSelectionCount();
            }

            function toggleSubcategorySelection(category, subcategory, selected) {
                const key = getSubcategoryKey(category, subcategory);

                if (selected) {
                    if (!selectedSubcategories.has(key)) {
                        selectedSubcategories.set(key, {
                            category,
                            subcategory,
                            locations: null
                        });
                    }

                    // Auto-set primary if none set
                    if (!primaryField) {
                        primaryField = category;
                        document.getElementById('primaryFieldHidden').value = category;
                    }
                } else {
                    selectedSubcategories.delete(key);

                    // Check if primary category has any selections left
                    if (primaryField === category) {
                        const hasAnyInCategory = Array.from(selectedSubcategories.values())
                            .some(item => item.category === category);
                        if (!hasAnyInCategory) {
                            primaryField = null;
                            document.getElementById('primaryFieldHidden').value = '';
                        }
                    }
                }

                // Update parent category checkbox state
                updateCategoryCheckboxState(category);
                updateCombinedSelectionCount();
            }

            function updateCategoryCheckboxState(category) {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;

                const categoryItem = popupBody.querySelector(`[data-category-name="${category}"]`);
                if (!categoryItem) return;

                const checkbox = categoryItem.querySelector('.category-checkbox');
                if (!checkbox) return;

                const subcategories = specializations[category] || [];
                const selectedCount = subcategories.filter(sub =>
                    selectedSubcategories.has(getSubcategoryKey(category, sub))
                ).length;

                checkbox.checked = selectedCount === subcategories.length && subcategories.length > 0;
                checkbox.indeterminate = selectedCount > 0 && selectedCount < subcategories.length;
            }

            function setPrimaryField(category) {
                // If clicking on already primary, don't change
                if (primaryField === category) return;

                primaryField = category;
                document.getElementById('primaryFieldHidden').value = category;

                // Also select all subcategories of this category if none selected
                const subcategories = specializations[category] || [];
                const hasAnySelected = subcategories.some(sub =>
                    selectedSubcategories.has(getSubcategoryKey(category, sub))
                );

                if (!hasAnySelected) {
                    subcategories.forEach(subcategory => {
                        const key = getSubcategoryKey(category, subcategory);
                        selectedSubcategories.set(key, {
                            category,
                            subcategory,
                            locations: null
                        });
                    });
                }

                buildCombinedPopupContent();
                updateCombinedSelectionCount();
            }

            function updateCombinedSelectionCount() {
                const countDisplay = document.getElementById('selectedCombinedCount');
                if (!countDisplay) return;

                const count = selectedSubcategories.size;

                if (count === 0) {
                    countDisplay.textContent = 'לא נבחרו התמחויות';
                    countDisplay.style.color = 'var(--text-muted)';
                } else if (!primaryField) {
                    countDisplay.textContent = `נבחרו ${count} התמחויות - יש לבחור תחום ראשי`;
                    countDisplay.style.color = '#d97706';
                } else {
                    countDisplay.textContent = `תחום ראשי: ${primaryField} | ${count} התמחויות`;
                    countDisplay.style.color = 'var(--text-secondary)';
                }
            }

            function saveCombinedSpecializations() {
                if (selectedSubcategories.size === 0) {
                    alert('יש לבחור לפחות התמחות אחת');
                    return;
                }

                if (!primaryField) {
                    alert('יש לבחור תחום ראשי');
                    return;
                }

                // Update the display
                updateCombinedDisplay();
                updateSubcategoryTable();

                // Close popup
                closeCombinedSpecializationsPopup();
            }

            function updateCombinedDisplay() {
                const placeholder = document.getElementById('combinedSpecializationsPlaceholder');
                if (!placeholder) return;

                if (primaryField) {
                    placeholder.textContent = `תחום ראשי: ${primaryField}`;
                    placeholder.style.color = 'var(--text-primary)';
                } else if (selectedSubcategories.size > 0) {
                    placeholder.textContent = `${selectedSubcategories.size} התמחויות נבחרו`;
                    placeholder.style.color = 'var(--text-secondary)';
                } else {
                    placeholder.textContent = 'לחצו לבחירת תחומים והתמחויות';
                    placeholder.style.color = 'var(--text-muted)';
                }
            }

            // ===========================================
            // SUBCATEGORY TABLE
            // ===========================================

            function updateSubcategoryTable() {
                const container = document.getElementById('subcategoryTableContainer');
                const tbody = document.getElementById('subcategoryTableBody');

                if (!container || !tbody) return;

                if (selectedSubcategories.size === 0) {
                    container.style.display = 'none';
                    return;
                }

                container.style.display = 'block';
                tbody.innerHTML = '';

                // Sort: primary category first, then by category name
                const sortedEntries = Array.from(selectedSubcategories.entries()).sort((a, b) => {
                    const catA = a[1].category;
                    const catB = b[1].category;
                    if (catA === primaryField && catB !== primaryField) return -1;
                    if (catB === primaryField && catA !== primaryField) return 1;
                    if (catA !== catB) return catA.localeCompare(catB);
                    return a[1].subcategory.localeCompare(b[1].subcategory);
                });

                sortedEntries.forEach(([key, data]) => {
                    const row = document.createElement('tr');
                    const isPrimary = data.category === primaryField;

                    // First column: subcategory name + category (with primary badge on category)
                    const nameCell = document.createElement('td');
                    nameCell.innerHTML = `
                        <div class="subcategory-name">${data.subcategory}</div>
                        <div class="subcategory-category">
                            ${data.category}
                            ${isPrimary ? '<span class="primary-badge">תחום ראשי</span>' : ''}
                        </div>
                    `;

                    // Second column: locations + edit button (edit on left in RTL, so it comes last in HTML)
                    const locCell = document.createElement('td');
                    const locationsHtml = buildLocationDisplayHtml(data.locations, key);
                    locCell.innerHTML = `
                        <div class="locations-cell">
                            <div class="locations-content">
                                ${locationsHtml}
                            </div>
                            <button type="button" class="edit-locations-btn" data-subcategory-key="${key}" title="עריכת אזורי שירות">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    `;

                    row.appendChild(nameCell);
                    row.appendChild(locCell);
                    tbody.appendChild(row);
                });

                // Add event listeners for edit buttons
                tbody.querySelectorAll('.edit-locations-btn').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const key = this.dataset.subcategoryKey;
                        openLocationEditModal(key);
                    });
                });

                // Add event listeners for remove county buttons
                tbody.querySelectorAll('.remove-county').forEach(btn => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const key = this.dataset.subcategoryKey;
                        const county = this.dataset.county;
                        const district = this.dataset.district;
                        removeCountyFromSubcategory(key, county, district);
                    });
                });
            }

            function buildLocationDisplayHtml(locations, subcategoryKey) {
                if (locations === null || locations === undefined) {
                    return '<span class="no-locations-text">לא נבחרו אזורים</span>';
                }

                if (locations.length === 0) {
                    return '<span class="no-locations-text">לא נבחרו אזורים</span>';
                }

                let html = '';
                locations.forEach(districtData => {
                    if (districtData.counties && districtData.counties.length > 0) {
                        html += `
                            <div class="location-district-group">
                                <div class="district-label">
                                    <span>${districtData.district}</span>
                                    <span class="pin-icon">📍</span>
                                </div>
                                <div class="county-tags">
                                    ${districtData.counties.map(c => `
                                        <span class="county-tag">
                                            <span class="remove-county" data-subcategory-key="${subcategoryKey}" data-county="${c}" data-district="${districtData.district}">×</span>
                                            <span>${c}</span>
                                        </span>
                                    `).join('')}
                                </div>
                            </div>
                        `;
                    }
                });

                return html || '<span class="no-locations-text">לא נבחרו אזורים</span>';
            }

            function removeCountyFromSubcategory(subcategoryKey, county, district) {
                const data = selectedSubcategories.get(subcategoryKey);
                if (!data || !data.locations) return;

                // Find the district and remove the county
                data.locations.forEach(loc => {
                    if (loc.district === district) {
                        loc.counties = loc.counties.filter(c => c !== county);
                    }
                });

                // Remove empty districts
                data.locations = data.locations.filter(loc => loc.counties.length > 0);

                // If no locations left, set to empty array (not null, since it was explicitly edited)
                if (data.locations.length === 0) {
                    data.locations = [];
                }

                // Update the table
                updateSubcategoryTable();
            }

            // ===========================================
            // LOCATION EDIT MODAL
            // ===========================================

            function initializeLocationModal() {
                const modal = document.getElementById('locationEditModal');
                const closeBtn = document.getElementById('closeLocationEditModal');
                const saveBtn = document.getElementById('saveLocationEdit');
                const searchInput = document.getElementById('locationSearchInput');

                if (!modal) return;

                closeBtn?.addEventListener('click', closeLocationEditModal);
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeLocationEditModal();
                    }
                });

                saveBtn?.addEventListener('click', saveLocationEdit);

                searchInput?.addEventListener('input', function() {
                    filterLocationHierarchy(this.value);
                });
            }

            function openLocationEditModal(subcategoryKey) {
                currentEditingSubcategoryKey = subcategoryKey;
                const modal = document.getElementById('locationEditModal');
                const title = document.getElementById('locationEditModalTitle');

                if (!modal) return;

                const data = selectedSubcategories.get(subcategoryKey);
                if (data) {
                    title.textContent = `אזורי שירות: ${data.subcategory}`;
                }

                // Initialize temp selection from current locations
                tempSelectedCounties = new Set();
                if (data && data.locations) {
                    data.locations.forEach(districtData => {
                        districtData.counties.forEach(county => {
                            tempSelectedCounties.add(county);
                        });
                    });
                }

                buildLocationHierarchy();
                updateLocationCount();

                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }

            function closeLocationEditModal() {
                const modal = document.getElementById('locationEditModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }

                currentEditingSubcategoryKey = null;
                tempSelectedCounties.clear();

                // Clear search
                const searchInput = document.getElementById('locationSearchInput');
                if (searchInput) searchInput.value = '';
            }

            function buildLocationHierarchy() {
                const container = document.getElementById('locationHierarchyContainer');
                if (!container || !districtData.Districts) return;

                container.innerHTML = '';

                districtData.Districts.forEach(district => {
                    const districtDiv = document.createElement('div');
                    districtDiv.className = 'district-item';
                    districtDiv.dataset.districtName = district.District;

                    // Check if all counties in this district are selected
                    const allCounties = district.Counties.map(c => c.County);
                    const selectedCountiesInDistrict = allCounties.filter(c => tempSelectedCounties.has(c));
                    const allSelected = selectedCountiesInDistrict.length === allCounties.length;
                    const someSelected = selectedCountiesInDistrict.length > 0 && !allSelected;

                    // District header
                    const header = document.createElement('div');
                    header.className = 'district-header expanded';
                    header.innerHTML = `
                        <input type="checkbox" class="district-checkbox" data-district="${district.District}"
                               ${allSelected ? 'checked' : ''}>
                        <span class="category-toggle">▼</span>
                        <span style="flex: 1;">${district.District}</span>
                    `;

                    const districtCheckbox = header.querySelector('.district-checkbox');
                    if (someSelected) {
                        districtCheckbox.indeterminate = true;
                    }

                    // Counties list
                    const countiesList = document.createElement('div');
                    countiesList.className = 'counties-list expanded';

                    district.Counties.forEach(county => {
                        const isSelected = tempSelectedCounties.has(county.County);

                        // County row
                        const countyDiv = document.createElement('div');
                        countyDiv.className = `county-item${isSelected ? ' selected' : ''}`;
                        countyDiv.dataset.countyName = county.County;
                        countyDiv.dataset.districtName = district.District;

                        const hasCities = county.Cities && county.Cities.length > 0;
                        countyDiv.innerHTML = `
                            <input type="checkbox" ${isSelected ? 'checked' : ''} data-county="${county.County}">
                            ${hasCities ? '<span class="county-expand-toggle">▶</span>' : '<span style="width: 18px;"></span>'}
                            <span class="county-name">${county.County}</span>
                        `;

                        // Cities list (collapsed by default)
                        if (hasCities) {
                            const citiesList = document.createElement('div');
                            citiesList.className = 'cities-list';
                            citiesList.dataset.countyName = county.County;

                            county.Cities.forEach(city => {
                                const cityDiv = document.createElement('div');
                                cityDiv.className = 'city-item';
                                cityDiv.dataset.countyName = county.County;
                                cityDiv.innerHTML = `
                                    ${city}
                                    <span class="county-highlight-hint">(יבחר: ${county.County})</span>
                                `;
                                citiesList.appendChild(cityDiv);
                            });

                            countyDiv.appendChild(citiesList);
                        }

                        countiesList.appendChild(countyDiv);
                    });

                    districtDiv.appendChild(header);
                    districtDiv.appendChild(countiesList);
                    container.appendChild(districtDiv);
                });

                // Add event listeners
                addLocationHierarchyEventListeners();
            }

            function addLocationHierarchyEventListeners() {
                const container = document.getElementById('locationHierarchyContainer');
                if (!container) return;

                // District header click - toggle expand
                container.querySelectorAll('.district-header').forEach(header => {
                    header.addEventListener('click', function(e) {
                        if (e.target.type === 'checkbox') return;
                        const countiesList = this.nextElementSibling;
                        const toggle = this.querySelector('.category-toggle');

                        if (countiesList.classList.contains('expanded')) {
                            countiesList.classList.remove('expanded');
                            this.classList.remove('expanded');
                            toggle.textContent = '▶';
                        } else {
                            countiesList.classList.add('expanded');
                            this.classList.add('expanded');
                            toggle.textContent = '▼';
                        }
                    });
                });

                // District checkbox - select all counties
                container.querySelectorAll('.district-checkbox').forEach(checkbox => {
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const districtName = this.dataset.district;
                        const district = districtData.Districts.find(d => d.District === districtName);

                        if (district) {
                            district.Counties.forEach(county => {
                                if (this.checked) {
                                    tempSelectedCounties.add(county.County);
                                } else {
                                    tempSelectedCounties.delete(county.County);
                                }
                            });
                        }

                        buildLocationHierarchy();
                        updateLocationCount();
                    });
                });

                // County checkbox
                container.querySelectorAll('.county-item > input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', function(e) {
                        e.stopPropagation();
                        const county = this.dataset.county;

                        if (this.checked) {
                            tempSelectedCounties.add(county);
                        } else {
                            tempSelectedCounties.delete(county);
                        }

                        // Update district checkbox state
                        const countyItem = this.closest('.county-item');
                        const districtName = countyItem.dataset.districtName;
                        updateDistrictCheckboxState(districtName);
                        updateLocationCount();

                        // Update visual state
                        countyItem.classList.toggle('selected', this.checked);
                    });
                });

                // County row click (not on checkbox)
                container.querySelectorAll('.county-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        if (e.target.type === 'checkbox' || e.target.classList.contains('county-expand-toggle')) return;
                        if (e.target.classList.contains('city-item')) return;

                        const checkbox = this.querySelector('input[type="checkbox"]');
                        checkbox.checked = !checkbox.checked;
                        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
                    });
                });

                // County expand toggle
                container.querySelectorAll('.county-expand-toggle').forEach(toggle => {
                    toggle.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const countyItem = this.closest('.county-item');
                        const citiesList = countyItem.querySelector('.cities-list');

                        if (citiesList) {
                            if (citiesList.classList.contains('expanded')) {
                                citiesList.classList.remove('expanded');
                                this.classList.remove('expanded');
                                this.textContent = '▶';
                            } else {
                                citiesList.classList.add('expanded');
                                this.classList.add('expanded');
                                this.textContent = '▼';
                            }
                        }
                    });
                });

                // City click - selects parent county
                container.querySelectorAll('.city-item').forEach(item => {
                    item.addEventListener('click', function(e) {
                        e.stopPropagation();
                        const countyName = this.dataset.countyName;

                        // Select the county
                        tempSelectedCounties.add(countyName);

                        // Update UI
                        buildLocationHierarchy();
                        updateLocationCount();
                    });

                    // Highlight parent county on hover
                    item.addEventListener('mouseenter', function() {
                        const countyName = this.dataset.countyName;
                        const countyItem = this.closest('.county-item');
                        if (countyItem) {
                            countyItem.style.backgroundColor = 'rgba(76, 29, 149, 0.1)';
                        }
                    });

                    item.addEventListener('mouseleave', function() {
                        const countyItem = this.closest('.county-item');
                        if (countyItem) {
                            const isSelected = tempSelectedCounties.has(countyItem.dataset.countyName);
                            countyItem.style.backgroundColor = isSelected ? 'rgba(76, 29, 149, 0.08)' : '';
                        }
                    });
                });
            }

            function updateDistrictCheckboxState(districtName) {
                const container = document.getElementById('locationHierarchyContainer');
                const districtItem = container?.querySelector(`[data-district-name="${districtName}"]`);
                if (!districtItem) return;

                const checkbox = districtItem.querySelector('.district-checkbox');
                if (!checkbox) return;

                const district = districtData.Districts.find(d => d.District === districtName);
                if (!district) return;

                const allCounties = district.Counties.map(c => c.County);
                const selectedCount = allCounties.filter(c => tempSelectedCounties.has(c)).length;

                checkbox.checked = selectedCount === allCounties.length;
                checkbox.indeterminate = selectedCount > 0 && selectedCount < allCounties.length;
            }

            function updateLocationCount() {
                const countDisplay = document.getElementById('selectedLocationCount');
                if (!countDisplay) return;

                const count = tempSelectedCounties.size;
                countDisplay.textContent = count === 0 ? 'לא נבחרו מיקומים' : `${count} נפות נבחרו`;
            }

            function saveLocationEdit() {
                if (!currentEditingSubcategoryKey) return;

                const data = selectedSubcategories.get(currentEditingSubcategoryKey);
                if (!data) return;

                // Build locations structure grouped by district
                const locations = [];

                if (tempSelectedCounties.size > 0) {
                    districtData.Districts.forEach(district => {
                        const countiesInDistrict = district.Counties
                            .map(c => c.County)
                            .filter(c => tempSelectedCounties.has(c));

                        if (countiesInDistrict.length > 0) {
                            locations.push({
                                district: district.District,
                                counties: countiesInDistrict
                            });
                        }
                    });
                }

                // Update the subcategory with new locations
                data.locations = locations.length > 0 ? locations : [];

                // Apply default inheritance: if this is the first location set,
                // apply to all subcategories with locations === null
                applyDefaultLocationsIfNeeded(locations);

                // Update table
                updateSubcategoryTable();

                // Close modal
                closeLocationEditModal();
            }

            function applyDefaultLocationsIfNeeded(newLocations) {
                // Only apply if newLocations has content
                if (!newLocations || newLocations.length === 0) return;

                // Find all subcategories with locations === null (never set)
                selectedSubcategories.forEach((data, key) => {
                    if (key === currentEditingSubcategoryKey) return; // Skip the one we just edited

                    if (data.locations === null) {
                        // Deep copy the locations
                        data.locations = JSON.parse(JSON.stringify(newLocations));
                    }
                });
            }

            function filterLocationHierarchy(searchTerm) {
                const container = document.getElementById('locationHierarchyContainer');
                if (!container) return;

                const normalizedSearch = searchTerm.toLowerCase().trim();

                if (!normalizedSearch) {
                    // Show all
                    container.querySelectorAll('.district-item').forEach(item => item.style.display = '');
                    container.querySelectorAll('.county-item').forEach(item => item.style.display = '');
                    container.querySelectorAll('.city-item').forEach(item => item.style.display = '');
                    return;
                }

                // Search and show matching items
                container.querySelectorAll('.district-item').forEach(districtItem => {
                    const districtName = districtItem.dataset.districtName?.toLowerCase() || '';
                    const districtMatches = districtName.includes(normalizedSearch);

                    let hasVisibleCounty = false;

                    districtItem.querySelectorAll('.county-item').forEach(countyItem => {
                        const countyName = countyItem.dataset.countyName?.toLowerCase() || '';
                        const countyMatches = countyName.includes(normalizedSearch);

                        let hasVisibleCity = false;

                        countyItem.querySelectorAll('.city-item').forEach(cityItem => {
                            const cityText = cityItem.textContent?.toLowerCase() || '';
                            const cityMatches = cityText.includes(normalizedSearch);

                            if (cityMatches || countyMatches || districtMatches) {
                                cityItem.style.display = '';
                                hasVisibleCity = true;
                            } else {
                                cityItem.style.display = 'none';
                            }
                        });

                        if (districtMatches || countyMatches || hasVisibleCity) {
                            countyItem.style.display = '';
                            hasVisibleCounty = true;

                            // Expand cities if searching
                            const citiesList = countyItem.querySelector('.cities-list');
                            if (citiesList && hasVisibleCity) {
                                citiesList.classList.add('expanded');
                            }
                        } else {
                            countyItem.style.display = 'none';
                        }
                    });

                    if (districtMatches || hasVisibleCounty) {
                        districtItem.style.display = '';
                        // Expand district
                        const countiesList = districtItem.querySelector('.counties-list');
                        if (countiesList) countiesList.classList.add('expanded');
                    } else {
                        districtItem.style.display = 'none';
                    }
                });
            }

            function filterCombinedCategories(searchTerm) {
                const popupBody = document.getElementById('combinedSpecializationsPopupBody');
                if (!popupBody) return;

                const normalizedSearch = searchTerm.toLowerCase().trim();

                if (!normalizedSearch) {
                    popupBody.querySelectorAll('.category-hierarchy-item').forEach(item => {
                        item.style.display = '';
                    });
                    popupBody.querySelectorAll('.subcategory-select-item').forEach(item => {
                        item.style.display = '';
                    });
                    return;
                }

                popupBody.querySelectorAll('.category-hierarchy-item').forEach(categoryItem => {
                    const categoryName = categoryItem.dataset.categoryName?.toLowerCase() || '';
                    const categoryMatches = categoryName.includes(normalizedSearch);

                    let hasVisibleSubcategory = false;

                    categoryItem.querySelectorAll('.subcategory-select-item').forEach(subItem => {
                        const subName = subItem.textContent?.toLowerCase() || '';
                        const subMatches = subName.includes(normalizedSearch);

                        if (categoryMatches || subMatches) {
                            subItem.style.display = '';
                            hasVisibleSubcategory = true;
                        } else {
                            subItem.style.display = 'none';
                        }
                    });

                    if (categoryMatches || hasVisibleSubcategory) {
                        categoryItem.style.display = '';
                        // Expand category
                        const subcatList = categoryItem.querySelector('.subcategories-list');
                        if (subcatList) subcatList.classList.add('expanded');
                        const header = categoryItem.querySelector('.category-header');
                        if (header) header.classList.add('expanded');
                    } else {
                        categoryItem.style.display = 'none';
                    }
                });
            }

            // Helper function to find category for a subcategory
            function findCategoryForSubcategory(subcategory) {
                for (const category in specializations) {
                    if (specializations[category] && specializations[category].includes(subcategory)) {
                        return category;
                    }
                }
                return null;
            }
            window.findCategoryForSubcategory = findCategoryForSubcategory;

            // Build categories hierarchy for form submission
            function buildCategoriesHierarchy() {
                const result = [];

                // Group by category
                const byCategory = {};
                selectedSubcategories.forEach((data, key) => {
                    if (!byCategory[data.category]) {
                        byCategory[data.category] = [];
                    }
                    byCategory[data.category].push({
                        subcategory: data.subcategory,
                        locations: data.locations || []
                    });
                });

                // Build final structure
                Object.keys(byCategory).forEach(category => {
                    result.push({
                        category: category,
                        subcategories: byCategory[category]
                    });
                });

                return result;
            }
            window.buildCategoriesHierarchy = buildCategoriesHierarchy;

            // Global remove functions (for tag removal if needed later)
            window.removeSubcategory = function(key) {
                selectedSubcategories.delete(key);
                const { category } = parseSubcategoryKey(key);

                // Check if primary field still has selections
                if (primaryField === category) {
                    const hasAnyInCategory = Array.from(selectedSubcategories.values())
                        .some(item => item.category === category);
                    if (!hasAnyInCategory) {
                        primaryField = null;
                        document.getElementById('primaryFieldHidden').value = '';
                    }
                }

                updateCombinedDisplay();
                updateSubcategoryTable();
            };

            // Legacy compatibility - keep additionalSpecializations as getter
            Object.defineProperty(window, 'additionalSpecializations', {
                get: function() {
                    return Array.from(selectedSubcategories.values()).map(d => d.subcategory);
                }
            });

            // Placeholder for legacy function call pattern
            function checkAndDeselectPrimaryIfEmpty() {
                if (!primaryField) return false;

                const hasAnyInPrimary = Array.from(selectedSubcategories.values())
                    .some(item => item.category === primaryField);

                if (!hasAnyInPrimary) {
                    primaryField = null;
                    document.getElementById('primaryFieldHidden').value = '';
                    return true;
                }
                return false;
            }

            // Load categories and district data on page load
            Promise.all([
                loadCategoriesData(),
                loadDistrictData()
            ]).then(() => {
                console.log('Categories and specializations loaded successfully');
                console.log('District hierarchy loaded successfully');

                // Initialize the combined specializations popup
                setTimeout(() => {
                    initializeCombinedSpecializationsPopup();
                }, 100);
            }).catch(error => {
                console.error('Error loading data:', error);
                // Still initialize popup with dummy data
                setTimeout(() => {
                    initializeCombinedSpecializationsPopup();
                }, 100);
            });

            // Old code removed - replaced with combined specializations functionality
            
            // Commented out old primary field code
            /*
            let currentFocus = -1;

            primaryFieldInput.addEventListener('input', function() {
                const value = this.value;
                if (value.length === 0) {
                    dropdownList.style.display = 'none';
                    updateSpecializationsPlaceholder(); // Update specializations when field cleared
                    return;
                }

                const filtered = professions.filter(profession => 
                    profession.includes(value)
                ); // Show all matching results

                if (filtered.length === 0) {
                    dropdownList.style.display = 'none';
                    return;
                }

                dropdownList.innerHTML = '';
                filtered.forEach((profession, index) => {
                    const item = document.createElement('div');
                    item.style.cssText = 'padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; text-align: right; transition: background-color 0.2s ease; height: 48px; display: flex; align-items: center;';
                    item.textContent = profession;
                    item.addEventListener('click', function() {
                        primaryFieldInput.value = profession;
                        dropdownList.style.display = 'none';
                        currentFocus = -1;
                        updateSpecializationsPlaceholder(); // Update specializations when field selected
                    });
                    dropdownList.appendChild(item);
                });

                dropdownList.style.display = 'block';
                currentFocus = -1;
            });

            primaryFieldInput.addEventListener('focus', function() {
                if (this.value.length === 0) {
                    // Show all professions when focused with empty input
                    dropdownList.innerHTML = '';
                    professions.forEach((profession, index) => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #f3f4f6; text-align: right; transition: background-color 0.2s ease; height: 48px; display: flex; align-items: center;';
                        item.textContent = profession;
                        item.addEventListener('click', function() {
                            primaryFieldInput.value = profession;
                            dropdownList.style.display = 'none';
                            currentFocus = -1;
                        });
                        dropdownList.appendChild(item);
                    });
                    dropdownList.style.display = 'block';
                }
            });

            primaryFieldInput.addEventListener('keydown', function(e) {
                const items = dropdownList.children;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus++;
                    if (currentFocus >= items.length) currentFocus = 0;
                    setActiveItem(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus--;
                    if (currentFocus < 0) currentFocus = items.length - 1;
                    setActiveItem(items);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentFocus > -1 && items[currentFocus]) {
                        items[currentFocus].click();
                    }
                } else if (e.key === 'Escape') {
                    dropdownList.style.display = 'none';
                    currentFocus = -1;
                }
            });

            function setActiveItem(items) {
                for (let i = 0; i < items.length; i++) {
                    if (i === currentFocus) {
                        items[i].style.backgroundColor = 'rgba(76, 29, 149, 0.1)';
                        items[i].style.color = 'rgba(76, 29, 149, 0.8)';
                    } else {
                        items[i].style.backgroundColor = '';
                        items[i].style.color = '';
                    }
                }
            }

            // Close autocomplete when clicking outside
            document.addEventListener('click', function(e) {
                if (!primaryFieldInput.contains(e.target) && !dropdownList.contains(e.target)) {
                    dropdownList.style.display = 'none';
                    currentFocus = -1;
                }
            });
            */


            // Handle radio button and checkbox styling
            const radioItems = document.querySelectorAll('.radio-item');
            radioItems.forEach(item => {
                const input = item.querySelector('input[type="radio"], input[type="checkbox"]');
                if (input) {
                    input.addEventListener('change', function() {
                        if (input.type === 'radio') {
                            // Remove selected class from all radio buttons with same name
                            const radioGroup = document.querySelectorAll(`input[name="${input.name}"]`);
                            radioGroup.forEach(radio => {
                                radio.closest('.radio-item').classList.remove('selected');
                            });
                        }
                        
                        if (this.checked) {
                            item.classList.add('selected');
                        } else {
                            item.classList.remove('selected');
                        }



                    });
                }
            });

            // Business Benefits popup functionality
            const businessBenefitsCategories = {
                'שירות ומחירים': [
                    'אני מציע הצעת מחיר מפורטת ללא התחייבות',
                    'בעל המלצות חמות מלקוחות מרוצים',
                    'אני מבצע ביקור ראשוני להערכת העבודה ללא תשלום',
                    'עובד במחירים הוגנים ושקופים',
                    'נותן יחס איכות-מחיר מעולה',
                    'מתאים את התשלום לתקציב הלקוח',
                    'אני עובד ללא עלויות נסתרות'
                ],
                'זמינות וגמישות': [
                    'אני זמין באופן מיידי לקריאות דחופות',
                    'נותן שירות מהיר ואמין בכל שעה',
                    'מגיב במהירות לפניות ושאלות',
                    'אני גמיש לחלוטין בתיאום זמנים',
                    'עובד גם בסופי שבוע וחגים',
                    'מתאים עצמי ללוחות זמנים צמודים',
                    'זמין לייעוץ ולמתן הנחיות'
                ],
                'ניסיון ומקצועיות': [
                    'בעל ניסיון מוכח של שנים בתחום',
                    'אני עובד עם צוות מקצועי ומיומן',
                    'אני משתמש בציוד מתקדם ואיכותי',
                    'עובד עם צוות קבוע בעל ניסיון רב',
                    'מתמחה בפתרון בעיות מורכבות',
                    'משתלם באופן שוטף ומתעדכן',
                    'בעל הסמכות ורישיונות מקצועיים'
                ],
                'איכות ושירות': [
                    'אני עובד בצורה נקייה ומסודרת',
                    'אני משתמש בחומרים ורכיבים איכותיים בלבד',
                    'ניקיון יסודי של אתר העבודה בסיום',
                    'מתחייב לשביעות רצון מלאה של הלקוח',
                    'נותן שירות אדיב ומקצועי',
                    'מדווח באופן שוטף על התקדמות העבודה',
                    'נותן אחריות מלאה על איכות הביצוע'
                ],
                'יעוץ ופתרונות': [
                    'אני נותן ייעוץ מקצועי חינם לפני תחילת העבודה',
                    'מציע פתרונות חכמים ויעילים לכל בעיה',
                    'מתאים את השירות לצרכים הספציפיים',
                    'בדיקה ותכנון מקיפים מראש',
                    'מציע חלופות וחיסכון בעלויות',
                    'מלווה ומטפל לאורך כל הפרויקט',
                    'נותן שירות לאחר מכירה ותמיכה שוטפת'
                ]
            };

            // Business benefits functionality
            const minBusinessBenefits = 4;
            let selectedBusinessBenefits = [];
            
            const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
            const businessBenefitsPopup = document.getElementById('businessBenefitsPopup');
            const businessBenefitsPopupBody = document.getElementById('businessBenefitsPopupBody');
            const businessBenefitsPlaceholder = document.getElementById('businessBenefitsPlaceholder');

            // Specializations functionality
            const specializationsDisplay = document.getElementById('specializationsDisplay');
            const specializationsPopup = document.getElementById('specializationsPopup');
            const specializationsPopupBody = document.getElementById('specializationsPopupBody');
            const specializationsPlaceholder = document.getElementById('specializationsPlaceholder');

            function initializeBusinessBenefitsPopup() {
                if (!businessBenefitsPopupBody) {
                    console.error('businessBenefitsPopupBody element not found!');
                    return;
                }
                businessBenefitsPopupBody.innerHTML = '';
                
                
                // Add custom option input
                const customInputContainer = document.createElement('div');
                customInputContainer.style.cssText = 'padding: 16px 24px; border-bottom: 1px solid var(--border-light);';
                customInputContainer.innerHTML = `
                    <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 8px; font-size: 14px;">✨ הוסף יתרון בשפה חופשית</div>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" placeholder="לדוגמה: מחזיר טלפונים תמיד..." style="flex: 1; padding: 10px 12px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 14px; text-align: right;" id="customBusinessBenefitInput">
                        <button type="button" style="background: var(--ai-purple); color: white; border: none; padding: 10px 16px; border-radius: var(--border-radius); cursor: pointer; font-weight: 500; font-size: 14px; white-space: nowrap;" id="addCustomBusinessBenefit">הוסף</button>
                    </div>
                `;
                businessBenefitsPopupBody.appendChild(customInputContainer);
                
                // Add categories
                Object.entries(businessBenefitsCategories).forEach(([category, benefits]) => {
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-div';
                    categoryDiv.style.cssText = 'border-bottom: 1px solid var(--border-light);';
                    
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = 'padding: 16px 24px; background: var(--bg-gray); font-weight: 600; color: var(--text-primary); font-size: 16px; border-bottom: 1px solid var(--border-light);';
                    categoryHeader.textContent = category;
                    categoryDiv.appendChild(categoryHeader);
                    
                    benefits.forEach(benefit => {
                        const isSelected = selectedBusinessBenefits.find(b => b.text === benefit);
                        const benefitItem = document.createElement('label');
                        benefitItem.className = 'benefit-item';
                        /* Styling handled by CSS class */
                        benefitItem.innerHTML = `
                            <input type="checkbox" class="popup-checkbox" ${isSelected ? 'checked' : ''} data-benefit="${benefit}" data-category="${category}">
                            <span style="flex: 1; text-align: right; color: var(--text-primary); font-size: 16px;">${benefit}</span>
                        `;
                        categoryDiv.appendChild(benefitItem);
                    });
                    
                    businessBenefitsPopupBody.appendChild(categoryDiv);
                });
                
                // Add event listeners
                const customInput = document.getElementById('customBusinessBenefitInput');
                const addBtn = document.getElementById('addCustomBusinessBenefit');
                
                // Custom input functionality
                function addCustomBenefit() {
                    const customValue = customInput.value.trim();
                    if (customValue && !selectedBusinessBenefits.find(b => b.text === customValue)) {
                        selectedBusinessBenefits.push({
                            id: Date.now(),
                            text: customValue,
                            category: 'יתרון מותאם אישית',
                            isCustom: true
                        });
                        updateBusinessBenefitsDisplay();
                        updateBusinessBenefitsCounter();
                        customInput.value = '';
                        closeBusinessBenefitsPopup();
                    }
                }
                
                addBtn.addEventListener('click', addCustomBenefit);
                customInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        addCustomBenefit();
                    }
                });
                
                // Checkbox functionality
                businessBenefitsPopupBody.addEventListener('change', function(e) {
                    if (e.target.type === 'checkbox') {
                        const benefit = e.target.dataset.benefit;
                        const category = e.target.dataset.category;
                        const existingIndex = selectedBusinessBenefits.findIndex(b => b.text === benefit);
                        
                        if (e.target.checked && existingIndex === -1) {
                            selectedBusinessBenefits.push({
                                id: Date.now(),
                                text: benefit,
                                category: category,
                                isCustom: false
                            });
                        } else if (!e.target.checked && existingIndex >= 0) {
                            selectedBusinessBenefits.splice(existingIndex, 1);
                        }
                        
                        updateBusinessBenefitsDisplay();
                        updateBusinessBenefitsCounter();
                    }
                });
            }

            function updateBusinessBenefitsDisplay() {
                // Clear current display
                businessBenefitsDisplay.innerHTML = '';
                
                if (selectedBusinessBenefits.length === 0) {
                    businessBenefitsDisplay.appendChild(businessBenefitsPlaceholder);
                } else {
                    const countSpan = document.createElement('span');
                    const remainingNeeded = Math.max(0, minBusinessBenefits - selectedBusinessBenefits.length);
                    if (remainingNeeded > 0) {
                        countSpan.textContent = `נבחרו ${selectedBusinessBenefits.length} יתרונות (נדרש עוד ${remainingNeeded})`;
                        countSpan.style.color = '#dc2626';
                    } else {
                        countSpan.textContent = `נבחרו ${selectedBusinessBenefits.length} יתרונות`;
                        countSpan.style.color = '#059669';
                    }
                    businessBenefitsDisplay.appendChild(countSpan);
                }
                
                // Update existing chevron color
                const chevron = businessBenefitsDisplay.querySelector('.fa-chevron-down');
                if (chevron) {
                    const isSatisfied = selectedBusinessBenefits.length >= 4;
                    chevron.style.color = isSatisfied ? 'var(--ai-purple)' : 'var(--text-muted)';
                }
                
                // Update separate tags display
                updateBusinessBenefitsTags();

                // Show/hide editable notice
                const noticeElement = document.getElementById('businessBenefitsEditableNotice');
                if (noticeElement) {
                    noticeElement.style.display = selectedBusinessBenefits.length > 0 ? 'block' : 'none';
                }

                // Sync form data - remove ALL existing business_benefits[] inputs first
                const form = document.querySelector('form');
                const existingInputs = form.querySelectorAll('input[name="business_benefits[]"]');
                existingInputs.forEach(input => input.remove());
                
                // Add hidden inputs for each selected benefit
                selectedBusinessBenefits.forEach((benefit, index) => {
                    const hiddenInput = document.createElement('input');
                    hiddenInput.type = 'hidden';
                    hiddenInput.name = 'business_benefits[]';
                    hiddenInput.value = benefit.text;
                    form.appendChild(hiddenInput);
                });
            }
            
            function updateBusinessBenefitsTags() {
                const businessBenefitsTags = document.getElementById('businessBenefitsTags');
                businessBenefitsTags.innerHTML = '';
                
                // Group benefits by category
                const benefitsByCategory = {};
                selectedBusinessBenefits.forEach(benefit => {
                    const categoryName = benefit.category || 'יתרון מותאם אישית';
                    if (!benefitsByCategory[categoryName]) {
                        benefitsByCategory[categoryName] = [];
                    }
                    benefitsByCategory[categoryName].push(benefit);
                });
                
                // Create display for each category
                Object.keys(benefitsByCategory).forEach(categoryName => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = 'margin-bottom: 20px;';
                    
                    // Create category header (only once per category)
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        font-weight: 600;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 12px;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e7eb;
                    `;
                    categoryHeader.textContent = categoryName;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Create input for each benefit in this category
                    benefitsByCategory[categoryName].forEach(benefit => {
                        const inputContainer = document.createElement('div');
                        inputContainer.style.cssText = 'position: relative; margin-bottom: 12px;';
                        
                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.value = benefit.text;
                        textInput.className = 'form-input business-benefit-input';
                        /* Styling handled by CSS class */
                        textInput.placeholder = 'הכנס את תיאור היתרון...';
                        
                        // Update benefit text when input changes
                        textInput.addEventListener('input', function() {
                            benefit.text = this.value.trim();

                            // Also update the corresponding hidden input for form submission
                            const form = document.querySelector('form');
                            const hiddenInputs = form.querySelectorAll('input[name="business_benefits[]"]');
                            const benefitIndex = selectedBusinessBenefits.findIndex(b => b.id === benefit.id);
                            if (benefitIndex >= 0 && hiddenInputs[benefitIndex]) {
                                hiddenInputs[benefitIndex].value = this.value.trim();
                            }
                        });

                        // Prevent Enter key from submitting form
                        textInput.addEventListener('keydown', function(e) {
                            if (e.key === 'Enter') {
                                e.preventDefault();
                            }
                        });

                        // Create remove button
                        const removeBtn = document.createElement('button');
                        removeBtn.type = 'button';
                        removeBtn.innerHTML = '×';
                        removeBtn.style.cssText = `
                            position: absolute;
                            top: 50%;
                            left: 12px;
                            transform: translateY(-50%);
                            background: none;
                            border: none;
                            font-size: 18px;
                            font-weight: bold;
                            color: #dc2626;
                            cursor: pointer;
                            width: 24px;
                            height: 24px;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            border-radius: 50%;
                            transition: background-color 0.2s;
                        `;
                        
                        removeBtn.addEventListener('click', function() {
                            selectedBusinessBenefits = selectedBusinessBenefits.filter(b => b.id !== benefit.id);
                            updateBusinessBenefitsDisplay();
                        });
                        
                        removeBtn.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'rgba(220, 38, 38, 0.1)';
                        });
                        
                        removeBtn.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = 'transparent';
                        });
                        
                        // Focus styling
                        textInput.addEventListener('focus', function() {
                            this.style.borderColor = 'var(--ai-purple)';
                            this.style.boxShadow = '0 0 0 3px rgba(79, 70, 229, 0.1)';
                        });
                        
                        textInput.addEventListener('blur', function() {
                            this.style.borderColor = 'var(--border-light)';
                            this.style.boxShadow = 'none';
                        });
                        
                        inputContainer.appendChild(textInput);
                        inputContainer.appendChild(removeBtn);
                        categoryContainer.appendChild(inputContainer);
                    });
                    
                    businessBenefitsTags.appendChild(categoryContainer);
                });
                
                // Validate minimum benefits
                const form = document.querySelector('.contact-form');
                if (form) {
                    const submitBtn = form.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        if (selectedBusinessBenefits.length < minBusinessBenefits) {
                            submitBtn.style.opacity = '0.6';
                            submitBtn.title = `נדרש לבחור לפחות ${minBusinessBenefits} יתרונות עסקיים`;
                        } else {
                            submitBtn.style.opacity = '1';
                            submitBtn.title = '';
                        }
                    }
                }
            }

            // Specializations popup functionality
            function initializeSpecializationsPopup() {
                if (!specializationsPopupBody) {
                    console.error('specializationsPopupBody element not found!');
                    return;
                }
                
                // Clear popup body
                specializationsPopupBody.innerHTML = '';
                
                // Get selected primary field from question 2
                const primaryFieldInput = document.querySelector('input[name="primary_field"]');
                const selectedPrimaryField = primaryFieldInput ? primaryFieldInput.value.trim() : '';
                
                // Check if primary field is selected
                if (!selectedPrimaryField) {
                    // Show warning message instead of popup
                    const warningContainer = document.createElement('div');
                    warningContainer.style.cssText = 'padding: 40px 24px; text-align: center; margin: 24px; border: 1px solid var(--border-light); border-radius: var(--border-radius); background: var(--bg-light);';
                    warningContainer.innerHTML = `
                        <div style="color: var(--text-primary); font-weight: 600; font-size: 18px; margin-bottom: 12px;">
                            ⚠️ יש לבחור תחום פעילות עיקרי קודם
                        </div>
                        <div style="color: var(--text-secondary); font-size: 16px; line-height: 1.5; margin-bottom: 20px;">
                            כדי לגשת להתמחויות נוספות, יש לבחור תחילה תחום פעילות עיקרי בשאלה 4
                        </div>
                        <button type="button" id="backToQuestion2Btn" style="background: var(--text-primary); color: white; border: none; padding: 12px 24px; border-radius: var(--border-radius); font-size: 16px; cursor: pointer; font-weight: 500;">
                            חזור לשאלה 4
                        </button>
                    `;
                    specializationsPopupBody.appendChild(warningContainer);
                    
                    // Add event listener to the button
                    const backBtn = document.getElementById('backToQuestion2Btn');
                    if (backBtn) {
                        backBtn.addEventListener('click', function() {
                            specializationsPopup.style.display = 'none';
                            document.getElementById('primaryFieldInput').scrollIntoView({ behavior: 'smooth' });
                            setTimeout(() => {
                                document.getElementById('primaryFieldInput').focus();
                            }, 500);
                        });
                    }
                    
                    return;
                }
                
                // Add search input at the top
                const searchContainer = document.createElement('div');
                searchContainer.style.cssText = 'padding: 20px 24px; border-bottom: 1px solid var(--border-light);';
                searchContainer.innerHTML = `
                    <input type="text" placeholder="חיפוש התמחויות..." style="width: 100%; padding: 12px 16px; border: 1px solid var(--border-light); border-radius: var(--border-radius); font-size: 16px; text-align: right; background: var(--bg-light); color: var(--text-primary);" id="specializationsSearch">
                `;
                specializationsPopupBody.appendChild(searchContainer);
                
                // Show all categories but prioritize the selected primary field
                const allCategories = Object.keys(specializations);
                
                // Sort categories: primary field first, then alphabetically
                const sortedCategories = allCategories.sort((a, b) => {
                    if (a === selectedPrimaryField) return -1;
                    if (b === selectedPrimaryField) return 1;
                    return a.localeCompare(b, 'he');
                });
                
                sortedCategories.forEach(category => {
                    const isPrimaryField = category === selectedPrimaryField;
                    const categoryDiv = document.createElement('div');
                    categoryDiv.className = 'category-div';
                    categoryDiv.style.cssText = 'border-bottom: 1px solid var(--border-light);';
                    
                    // Category header with checkbox to select all
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `padding: 16px 24px; background: var(--bg-gray); font-weight: 600; color: var(--text-primary); display: flex; align-items: center; cursor: pointer; border-bottom: 1px solid var(--border-light); ${isPrimaryField ? 'border-right: 3px solid var(--text-primary);' : ''}`;
                    
                    const allSelected = specializations[category].every(spec => 
                        selectedSpecializations.find(s => s.text === spec && s.category === category)
                    );
                    
                    if (isPrimaryField) {
                        categoryHeader.innerHTML = `
                            <div style="width: 100%; display: flex; flex-direction: column; gap: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <span style="font-size: 16px; font-weight: 600;">🎯 ${category}</span>
                                    <span style="background: var(--text-muted); color: white; padding: 4px 8px; border-radius: var(--border-radius); font-size: 12px; font-weight: 400;">עיקרי</span>
                                </div>
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <div style="width: 18px; height: 18px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; ${allSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                        ${allSelected ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                                    </div>
                                    <span style="font-size: 14px; color: var(--text-secondary);">בחירת הכל</span>
                                </div>
                            </div>
                        `;
                    } else {
                        categoryHeader.innerHTML = `
                            <div style="width: 18px; height: 18px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; margin-left: 16px; ${allSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                ${allSelected ? '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>' : ''}
                            </div>
                            <span style="font-size: 16px;">${category} - בחירת הכל</span>
                        `;
                    }
                    
                    // Toggle all specializations in category
                    categoryHeader.addEventListener('click', function(e) {
                        e.stopPropagation();
                        // Find the checkbox (different for primary vs regular categories)
                        let checkbox;
                        if (isPrimaryField) {
                            // In primary field, the checkbox is in the second div with the specific styling
                            const secondRow = this.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
                            if (secondRow) {
                                checkbox = secondRow.querySelector('div[style*="width: 18px"]');
                            }
                        } else {
                            // In regular categories, checkbox is the first div with width 18px
                            checkbox = this.querySelector('div[style*="width: 18px"]');
                        }
                        const isAllSelected = specializations[category].every(spec => 
                            selectedSpecializations.find(s => s.text === spec && s.category === category)
                        );
                        
                        if (isAllSelected) {
                            // Remove all from this category
                            selectedSpecializations = selectedSpecializations.filter(s => s.category !== category);
                        } else {
                            // Add all from this category
                            selectedSpecializations = selectedSpecializations.filter(s => s.category !== category);
                            specializations[category].forEach(spec => {
                                selectedSpecializations.push({
                                    id: Date.now() + Math.random(),
                                    text: spec,
                                    category: category,
                                    isCustom: false
                                });
                            });
                        }
                        
                        updateSpecializationsDisplay();
                        updateSpecializationsCheckboxes(); // Update checkboxes without recreating popup
                    });
                    
                    categoryDiv.appendChild(categoryHeader);
                    
                    
                    // Individual specializations
                    specializations[category].forEach(specialization => {
                        const item = document.createElement('div');
                        item.style.cssText = 'padding: 12px 24px; cursor: pointer; border-bottom: 1px solid var(--border-light); display: flex; align-items: center; gap: 16px;';
                        
                        const isSelected = selectedSpecializations.find(s => s.text === specialization && s.category === category);
                        item.innerHTML = `
                            <div style="width: 16px; height: 16px; border: 1px solid var(--border-light); border-radius: var(--border-radius); display: flex; align-items: center; justify-content: center; ${isSelected ? 'background: var(--text-primary); border-color: var(--text-primary);' : 'background: var(--bg-light);'}">
                                ${isSelected ? '<i class="fas fa-check" style="color: white; font-size: 9px;"></i>' : ''}
                            </div>
                            <span style="flex: 1; text-align: right; color: var(--text-primary);">${specialization}</span>
                        `;
                        
                        item.addEventListener('click', function(e) {
                            e.stopPropagation();
                            const existingIndex = selectedSpecializations.findIndex(s => s.text === specialization && s.category === category);
                            
                            if (existingIndex >= 0) {
                                selectedSpecializations.splice(existingIndex, 1);
                            } else {
                                selectedSpecializations.push({
                                    id: Date.now(),
                                    text: specialization,
                                    category: category,
                                    isCustom: false
                                });
                            }
                            
                            updateSpecializationsDisplay();
                            updateSpecializationsCheckboxes(); // Update checkboxes without recreating popup
                        });
                        
                        item.addEventListener('mouseenter', function() {
                            this.style.backgroundColor = 'var(--bg-gray)';
                        });
                        
                        item.addEventListener('mouseleave', function() {
                            this.style.backgroundColor = '';
                        });
                        
                        categoryDiv.appendChild(item);
                    });
                    
                    specializationsPopupBody.appendChild(categoryDiv);
                });
                
                // Search functionality with autocomplete
                const searchInput = specializationsPopupBody.querySelector('#specializationsSearch');
                if (searchInput) {
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.value.toLowerCase().trim();
                        
                        // If search is empty, show all
                        if (searchTerm === '') {
                            const categoryDivs = specializationsPopupBody.querySelectorAll('.category-div');
                            const items = specializationsPopupBody.querySelectorAll('div[style*="padding: 12px 24px"]');
                            categoryDivs.forEach(el => el.style.display = 'block');
                            items.forEach(el => el.style.display = 'flex');
                            return;
                        }
                        
                        // Find category divs (use class selector for reliability)
                        const categoryDivs = specializationsPopupBody.querySelectorAll('.category-div');
                        
                        categoryDivs.forEach(categoryDiv => {
                            // Get category name from header
                            const categoryHeader = categoryDiv.querySelector('div[style*="background: var(--bg-gray)"]');
                            let categoryName = '';
                            
                            if (categoryHeader) {
                                if (categoryHeader.textContent.includes('🎯')) {
                                    // Primary field - get name from first span
                                    const firstSpan = categoryHeader.querySelector('span');
                                    if (firstSpan) {
                                        categoryName = firstSpan.textContent.replace('🎯 ', '').toLowerCase();
                                    }
                                } else {
                                    // Regular category
                                    categoryName = categoryHeader.textContent.replace(' - בחירת הכל', '').toLowerCase();
                                }
                            }
                            
                            // Get specialization items in this category
                            const specializationItems = categoryDiv.querySelectorAll('div[style*="padding: 12px 24px"]');
                            let hasVisibleItems = false;
                            
                            // Check if category name matches (for showing whole category)
                            const categoryMatches = categoryName.includes(searchTerm);
                            
                            // Check each specialization item
                            specializationItems.forEach(item => {
                                const itemText = item.querySelector('span') ? item.querySelector('span').textContent.toLowerCase() : '';
                                const itemMatches = itemText.includes(searchTerm);
                                
                                if (categoryMatches || itemMatches) {
                                    item.style.display = 'flex';
                                    hasVisibleItems = true;
                                } else {
                                    item.style.display = 'none';
                                }
                            });
                            
                            // Show/hide entire category based on matches
                            categoryDiv.style.display = hasVisibleItems || categoryMatches ? 'block' : 'none';
                        });
                    });
                }
                
                updateSpecializationsCounter();
            }
            
            // Function to update specializations counter in popup footer
            function updateSpecializationsCounter() {
                const counterElement = document.getElementById('selectedSpecializationsCount');
                if (counterElement) {
                    const count = selectedSpecializations.length;
                    if (count === 0) {
                        counterElement.textContent = 'לא נבחרו התמחויות';
                        counterElement.style.color = 'var(--text-secondary)';
                    } else {
                        counterElement.textContent = `נבחרו ${count} התמחויות`;
                        counterElement.style.color = 'var(--text-primary)';
                    }
                }
            }
            
            function updateBusinessBenefitsCounter() {
                const counterElement = document.getElementById('selectedBusinessBenefitsCount');
                if (counterElement) {
                    const count = selectedBusinessBenefits.length;
                    const remainingNeeded = Math.max(0, minBusinessBenefits - count);
                    const isSatisfied = count >= minBusinessBenefits;

                    if (count === 0) {
                        counterElement.textContent = 'לא נבחרו יתרונות';
                        counterElement.style.color = 'var(--text-secondary)';
                    } else if (remainingNeeded > 0) {
                        counterElement.textContent = `נבחרו ${count} יתרונות (נדרש עוד ${remainingNeeded})`;
                        counterElement.style.color = '#dc2626';
                    } else {
                        counterElement.textContent = `נבחרו ${count} יתרונות`;
                        counterElement.style.color = '#059669';
                    }

                    // Update save button appearance
                    const saveBtn = document.getElementById('saveBusinessBenefits');
                    if (saveBtn) {
                        if (isSatisfied) {
                            saveBtn.style.opacity = '1';
                            saveBtn.style.filter = 'none';
                        } else {
                            saveBtn.style.opacity = '0.5';
                            saveBtn.style.filter = 'grayscale(50%)';
                        }
                    }
                }
            }
            
            // Function to open business benefits popup
            function openBusinessBenefitsPopup() {
                initializeBusinessBenefitsPopup();
                updateBusinessBenefitsCounter(); // Update button state on open
                businessBenefitsPopup.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
            
            // Function to close business benefits popup
            function closeBusinessBenefitsPopup() {
                businessBenefitsPopup.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            // Function to update only checkboxes in the popup without recreating the whole content
            function updateSpecializationsCheckboxes() {
                const popupBody = document.getElementById('specializationsPopupBody');
                if (!popupBody) return;
                
                // Update category headers
                const categoryHeaders = popupBody.querySelectorAll('div[style*="background: var(--bg-gray)"]');
                categoryHeaders.forEach(header => {
                    // Check if this is a primary field (has emoji)
                    const isPrimaryField = header.textContent.includes('🎯');
                    let category;
                    
                    if (isPrimaryField) {
                        // For primary field, extract category from the first line
                        const firstLine = header.querySelector('span');
                        if (firstLine) {
                            category = firstLine.textContent.replace('🎯 ', '').trim();
                        }
                    } else {
                        // For regular categories
                        category = header.textContent.replace(' - בחירת הכל', '').trim();
                    }
                    
                    if (category && specializations[category]) {
                        const allSelected = specializations[category].every(spec => 
                            selectedSpecializations.find(s => s.text === spec && s.category === category)
                        );
                        
                        // Find the checkbox - different locations for primary vs regular
                        let checkbox;
                        if (isPrimaryField) {
                            // In primary field, checkbox is in the second row
                            const secondRow = header.querySelector('div[style*="display: flex; align-items: center; gap: 12px"]');
                            if (secondRow) {
                                checkbox = secondRow.querySelector('div[style*="width: 18px"]');
                            }
                        } else {
                            // In regular categories, checkbox is in the main row
                            checkbox = header.querySelector('div[style*="width: 18px"]');
                        }
                        
                        if (checkbox) {
                            if (allSelected) {
                                checkbox.style.background = 'var(--text-primary)';
                                checkbox.style.borderColor = 'var(--text-primary)';
                                checkbox.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 10px;"></i>';
                            } else {
                                checkbox.style.background = 'var(--bg-light)';
                                checkbox.style.borderColor = 'var(--border-light)';
                                checkbox.innerHTML = '';
                            }
                        }
                    }
                });
                
                // Update individual items
                const items = popupBody.querySelectorAll('div[style*="padding: 12px 24px"]');
                items.forEach(item => {
                    const text = item.querySelector('span').textContent;
                    const isSelected = selectedSpecializations.find(s => s.text === text);
                    const checkbox = item.querySelector('div[style*="width: 16px"]');
                    
                    if (checkbox) {
                        if (isSelected) {
                            checkbox.style.background = 'var(--text-primary)';
                            checkbox.style.borderColor = 'var(--text-primary)';
                            checkbox.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 9px;"></i>';
                        } else {
                            checkbox.style.background = 'var(--bg-light)';
                            checkbox.style.borderColor = 'var(--border-light)';
                            checkbox.innerHTML = '';
                        }
                    }
                });
                
                updateSpecializationsCounter();
            }
            
            // Function to open specializations popup
            function openSpecializationsPopup() {
                initializeSpecializationsPopup();
                specializationsPopup.style.display = 'block';
            }
            
            // Function to close specializations popup
            function closeSpecializationsPopup() {
                specializationsPopup.style.display = 'none';
            }
            
            // Make function globally accessible
            window.closeSpecializationsPopup = closeSpecializationsPopup;

            function updateSpecializationsDisplay() {
                // Clear current display
                specializationsDisplay.innerHTML = '';
                
                if (selectedSpecializations.length === 0) {
                    specializationsDisplay.appendChild(specializationsPlaceholder);
                } else {
                    const countSpan = document.createElement('span');
                    countSpan.textContent = `נבחרו ${selectedSpecializations.length} התמחויות נוספות`;
                    countSpan.style.color = '#059669';
                    specializationsDisplay.appendChild(countSpan);
                }
                
                // Update existing chevron color
                const chevron = specializationsDisplay.querySelector('.fa-chevron-down');
                if (chevron) {
                    const isSatisfied = primaryField && additionalSpecializations.length > 0;
                    chevron.style.color = isSatisfied ? 'var(--ai-purple)' : 'var(--text-muted)';
                }
                
                // Update separate tags display
                updateSpecializationsTags();

                // Note: We no longer create hidden inputs - the new system uses categories_hierarchy
            }

            function updateSpecializationsTags() {
                const specializationsTags = document.getElementById('specializationsTags');
                if (!specializationsTags) return;
                
                specializationsTags.innerHTML = '';
                
                if (selectedSpecializations.length === 0) return;
                
                // Group specializations by category
                const specializationsByCategory = {};
                selectedSpecializations.forEach(specialization => {
                    const categoryName = specialization.category || 'התמחויות מותאמות';
                    if (!specializationsByCategory[categoryName]) {
                        specializationsByCategory[categoryName] = [];
                    }
                    specializationsByCategory[categoryName].push(specialization);
                });
                
                // Create display for each category
                Object.keys(specializationsByCategory).forEach(categoryName => {
                    const categoryContainer = document.createElement('div');
                    categoryContainer.style.cssText = 'margin-bottom: 20px;';
                    
                    // Create category header
                    const categoryHeader = document.createElement('div');
                    categoryHeader.style.cssText = `
                        font-weight: 600;
                        color: #374151;
                        font-size: 14px;
                        margin-bottom: 12px;
                        padding: 8px 0;
                        border-bottom: 1px solid #e5e7eb;
                    `;
                    categoryHeader.textContent = `${categoryName} (${specializationsByCategory[categoryName].length})`;
                    categoryContainer.appendChild(categoryHeader);
                    
                    // Create tags for each specialization in this category
                    specializationsByCategory[categoryName].forEach(specialization => {
                        const tagContainer = document.createElement('div');
                        tagContainer.style.cssText = 'display: inline-block; margin: 4px 8px 4px 0;';
                        
                        const tag = document.createElement('span');
                        tag.style.cssText = `
                            display: inline-flex;
                            align-items: center;
                            padding: 6px 12px;
                            background: ${specialization.isCustom ? '#f0f9ff' : '#f3f4f6'};
                            border: 1px solid ${specialization.isCustom ? '#0ea5e9' : '#d1d5db'};
                            border-radius: 20px;
                            font-size: 13px;
                            color: ${specialization.isCustom ? '#0c4a6e' : '#374151'};
                            gap: 8px;
                        `;
                        
                        tag.innerHTML = `
                            <span>${specialization.text}</span>
                            <i class="fas fa-times" style="cursor: pointer; opacity: 0.7;" title="הסר התמחות"></i>
                        `;
                        
                        // Remove specialization on click
                        tag.querySelector('.fa-times').addEventListener('click', function() {
                            selectedSpecializations = selectedSpecializations.filter(s => s.id !== specialization.id);
                            updateSpecializationsDisplay();
                        });
                        
                        tagContainer.appendChild(tag);
                        categoryContainer.appendChild(tagContainer);
                    });
                    
                    specializationsTags.appendChild(categoryContainer);
                });
            }

            // Initialize with a small delay to ensure DOM is ready
            setTimeout(function() {
                initializeBusinessBenefitsPopup();
                updateSpecializationsPlaceholder();
            }, 100);

            // Handle popup toggle
            if (businessBenefitsDisplay && businessBenefitsPopup) {
                businessBenefitsDisplay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    openBusinessBenefitsPopup();
                });
            } else {
            }
            
            // Handle popup close
            if (businessBenefitsPopup) {
                const closeBtn = businessBenefitsPopup.querySelector('.popup-close');
                
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeBusinessBenefitsPopup();
                    });
                }
                
                // Close popup when clicking outside
                businessBenefitsPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeBusinessBenefitsPopup();
                    }
                });
                
                // Save button functionality
                const saveBtn = document.getElementById('saveBusinessBenefits');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        updateBusinessBenefitsDisplay();
                        closeBusinessBenefitsPopup();
                    });
                }
            }

            // Function to update specializations placeholder based on primary field selection
            function updateSpecializationsPlaceholder() {
                const primaryFieldInput = document.querySelector('input[name="primary_field"]');
                const selectedPrimaryField = primaryFieldInput ? primaryFieldInput.value.trim() : '';
                const placeholder = document.getElementById('specializationsPlaceholder');
                
                if (placeholder) {
                    if (!selectedPrimaryField) {
                        placeholder.textContent = 'יש לבחור תחום פעילות עיקרי תחילה בשאלה 4';
                        placeholder.style.color = '#dc2626'; // Red color for warning
                    } else {
                        placeholder.textContent = 'לחצו לבחירת התמחויות נוספות';
                        placeholder.style.color = 'var(--text-muted)'; // Original color
                    }
                }
            }

            // Handle specializations popup toggle
            if (specializationsDisplay && specializationsPopup) {
                specializationsDisplay.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    openSpecializationsPopup();
                });
            }
            
            // Popup event handlers
            if (specializationsPopup) {
                // Close popup when clicking on overlay
                specializationsPopup.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeSpecializationsPopup();
                    }
                });
                
                // Close button
                const closeBtn = document.getElementById('closeSpecializationsPopup');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        closeSpecializationsPopup();
                    });
                }
            }


            // Restriction popup functionality
            const restrictionOptions = [
                'מחירים ספציפיים',
                'פרטים אישיים של לקוחות',
                'ביקורת על מתחרים',
                'נושאים פוליטיים',
                'מידע פיננסי',
                'עבודות שלא בתחום התמחות',
                'המלצות על חברות אחרות',
                'נושאי דת',
                'תלונות על לקוחות',
                'סודות מקצועיים'
            ];

            // שאלה 7 - משתנים וקוד חדש להגבלות
            let selectedRestrictions = [];
            const maxRestrictions = 5;
            let restrictionFieldsCount = 1;

            // פונקציות עבור שדות ההגבלות החדשים
            function initializeRestrictions() {
                const addContainer = document.getElementById('addRestrictionContainer');
                const addBtn = document.getElementById('addRestrictionBtn');
                const restrictionFields = document.getElementById('restrictionFields');
                
                // הוספת שדה חדש - לחיצה על כל המיכל
                addContainer.addEventListener('click', function() {
                    if (restrictionFieldsCount < maxRestrictions) {
                        addRestrictionField();
                        updateAddButton();
                    }
                });

                // מעקב אחר שינויים בשדות
                restrictionFields.addEventListener('input', function(e) {
                    if (e.target.classList.contains('restriction-field')) {
                        updateRestrictionsArray();
                    }
                });

                // טיפול במחיקת שדות
                restrictionFields.addEventListener('click', function(e) {
                    if (e.target.classList.contains('remove-restriction-btn')) {
                        removeRestrictionField(e.target);
                    }
                });

                updateRemoveButtons();
            }

            function addRestrictionField() {
                const restrictionFields = document.getElementById('restrictionFields');
                restrictionFieldsCount++;
                
                // דוגמאות מהטולטיפ לפי סדר השדות
                const examples = [
                    "לדוגמה: לא לדבר על מחירים",  // שדה ראשון (כבר קיים)
                    "לא לפרסם מחירים בפוסטים",   // שדה שני
                    "לא ", // שדה שלישי  
                    "",   // שדה רביעי
                    "" // שדה חמישי
                ];
                
                const placeholder = examples[restrictionFieldsCount - 1] || "לדוגמה: הכנס הגבלה";
                
                const wrapper = document.createElement('div');
                wrapper.className = 'restriction-field-wrapper';
                wrapper.style.cssText = 'position: relative; margin-bottom: 12px;';
                wrapper.innerHTML = `
                    <input type="text" class="form-input restriction-field" placeholder="${placeholder}" style="padding-left: 50px;">
                    <button type="button" class="remove-restriction-btn" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #dc2626; font-size: 18px; cursor: pointer; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center;">×</button>
                `;
                
                restrictionFields.appendChild(wrapper);
                updateRemoveButtons();
                updateRestrictionsArray();
            }

            function removeRestrictionField(button) {
                const wrapper = button.parentElement;
                wrapper.remove();
                restrictionFieldsCount--;
                updateRemoveButtons();
                updateAddButton();
                updateRestrictionsArray();
            }

            function updateRemoveButtons() {
                const wrappers = document.querySelectorAll('.restriction-field-wrapper');
                wrappers.forEach((wrapper, index) => {
                    const removeBtn = wrapper.querySelector('.remove-restriction-btn');
                    if (removeBtn) {
                        // השדה הראשון (index 0) לא יהיה בו כפתור מחיקה
                        removeBtn.style.display = index > 0 ? 'flex' : 'none';
                    }
                });
            }

            function updateAddButton() {
                const addContainer = document.getElementById('addRestrictionContainer');
                const counter = document.getElementById('restrictionCounter');
                
                if (restrictionFieldsCount >= maxRestrictions) {
                    addContainer.style.display = 'none';
                } else {
                    addContainer.style.display = 'flex';
                    const remaining = maxRestrictions - restrictionFieldsCount;
                    counter.textContent = `הוסף נושא נוסף (עוד ${remaining} אפשריים)`;
                }
            }

            function updateRestrictionsArray() {
                const fields = document.querySelectorAll('.restriction-field');
                selectedRestrictions = [];
                fields.forEach(field => {
                    const value = field.value.trim();
                    if (value) {
                        selectedRestrictions.push(value);
                    }
                });
            }


            // אתחול השדות כשהדף נטען
            setTimeout(() => {
                initializeRestrictions();
                initializeRestrictionTooltip();
            }, 100);

            // פונקציה לטולטיפ הלחיץ
            function initializeRestrictionTooltip() {
                const trigger = document.querySelector('.restriction-tooltip-trigger');
                const tooltip = document.getElementById('restrictionTooltip');
                
                if (trigger && tooltip) {
                    // תוכן מובנה היררכית
                    tooltip.innerHTML = `
                        <div style="font-weight: 600; color: #f59e0b; margin-bottom: 12px; font-size: 15px;">💡 דוגמאות להגבלות:</div>
                        <div style="margin-bottom: 8px;">• לא לפרסם מחירים בפוסטים</div>
                        <div style="margin-bottom: 8px;">• </div>
                        <div style="margin-bottom: 8px;">• </div>
                        <div>• </div>
                    `;
                    console.log('Tooltip initialized with structured content');
                    
                    let isTooltipVisible = false;
                    
                    trigger.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        
                        if (isTooltipVisible) {
                            tooltip.style.display = 'none';
                            isTooltipVisible = false;
                            trigger.style.color = '#f59e0b';
                        } else {
                            tooltip.style.display = 'block';
                            isTooltipVisible = true;
                            trigger.style.color = '#d97706';
                        }
                    });
                    
                    // סגירה בלחיצה מחוץ לטולטיפ
                    document.addEventListener('click', function(e) {
                        if (!trigger.contains(e.target) && !tooltip.contains(e.target)) {
                            tooltip.style.display = 'none';
                            isTooltipVisible = false;
                            trigger.style.color = '#f59e0b';
                        }
                    });
                    
                    // הוספת אפקט hover
                    trigger.addEventListener('mouseenter', function() {
                        if (!isTooltipVisible) {
                            this.style.color = '#d97706';
                        }
                    });
                    
                    trigger.addEventListener('mouseleave', function() {
                        if (!isTooltipVisible) {
                            this.style.color = '#f59e0b';
                        }
                    });
                }
            }

            // Work area popup functionality - REMOVED
            // Location selection is now integrated into the category/subcategory table

            // Image upload handling
            window.uploadedImage = null; // Store the image data globally for later server upload
            const commentImageInput = document.getElementById('commentImage');
            const imagePreviewContainer = document.getElementById('imagePreviewContainer');
            const imagePreview = document.getElementById('imagePreview');
            const imageFileName = document.getElementById('imageFileName');
            const removeImageBtn = document.getElementById('removeImageBtn');

            commentImageInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    // Validate file type
                    const validTypes = ['image/png', 'image/jpeg', 'image/jpg'];
                    if (!validTypes.includes(file.type)) {
                        alert('אנא בחר קובץ תמונה בפורמט PNG, JPG או JPEG');
                        return;
                    }

                    // Validate file size (max 5MB)
                    if (file.size > 5 * 1024 * 1024) {
                        alert('גודל הקובץ חייב להיות עד 5MB');
                        return;
                    }

                    // Read file and create preview
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        window.uploadedImage = {
                            data: event.target.result, // base64 data
                            name: file.name,
                            type: file.type,
                            size: file.size
                        };

                        // Show preview
                        imagePreview.src = event.target.result;
                        imageFileName.textContent = file.name;
                        imagePreviewContainer.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            });

            removeImageBtn.addEventListener('click', function() {
                window.uploadedImage = null;
                commentImageInput.value = '';
                imagePreview.src = '';
                imageFileName.textContent = '';
                imagePreviewContainer.style.display = 'none';
            });

            // Getter function for accessing the uploaded image
            window.getUploadedImage = function() {
                return window.uploadedImage;
            };


            // Prevent Enter key from submitting the form
            document.getElementById('clientForm').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                }
            });

            // Form submission
            document.getElementById('clientForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Collect form data
                const formData = new FormData(this);
                const data = {};
                
                for (let [key, value] of formData.entries()) {
                    if (key === 'work_area' || key === 'business_benefits[]') {
                        // Handle multiple values for these fields
                        if (!data[key]) {
                            data[key] = [];
                        }
                        data[key].push(value);
                    } else {
                        data[key] = value;
                    }
                }
                
                // Validate business benefits minimum requirement
                const businessBenefits = data['business_benefits[]'] || [];
                const businessBenefitsArray = Array.isArray(businessBenefits) ? businessBenefits : [businessBenefits];
                const validBenefits = businessBenefitsArray.filter(b => b && b.trim());
                
                
                if (validBenefits.length < 4) {
                    alert(`נדרש לבחור לפחות 4 יתרונות עסקיים. נמצאו ${validBenefits.length} יתרונות: ${validBenefits.join(', ')}`);
                    const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                    if (businessBenefitsDisplay) {
                        businessBenefitsDisplay.scrollIntoView({ behavior: 'smooth' });
                        businessBenefitsDisplay.style.borderColor = '#dc2626';
                        setTimeout(() => {
                            businessBenefitsDisplay.style.borderColor = '';
                        }, 3000);
                    }
                    return;
                }

                // Validate that all subcategories have locations selected
                const subcategoriesWithoutLocations = [];
                selectedSubcategories.forEach((subData, key) => {
                    if (!subData.locations || subData.locations.length === 0) {
                        subcategoriesWithoutLocations.push(subData.subcategory);
                    }
                });

                if (subcategoriesWithoutLocations.length > 0) {
                    alert(`יש לבחור אזורי שירות עבור כל ההתמחויות.\n\nהתמחויות ללא אזורים:\n• ${subcategoriesWithoutLocations.join('\n• ')}`);
                    const tableContainer = document.getElementById('subcategoryTableContainer');
                    if (tableContainer) {
                        tableContainer.scrollIntoView({ behavior: 'smooth' });
                    }
                    return;
                }

                // Normalize business_benefits[] to business_benefits
                if (data['business_benefits[]']) {
                    data.business_benefits = data['business_benefits[]'];
                }

                // הוספת השדות החסרים
                // שאלה 7 - הגבלות
                data.restrictions = selectedRestrictions;

                // Format phone number to 9725XXXXXXXX
                if (data.phone_number) {
                    data.phone_number = formatPhoneNumber(data.phone_number);
                }

                // Build hierarchical categories structure
                data.categories = buildCategoriesHierarchy();

                // Clean up old/unused field names
                delete data['specializations[]'];
                delete data['business_benefits[]'];
                delete data['comment_image']; // Remove the file input field from FormData

                // Add uploaded image if exists (after cleanup)
                const uploadedImg = window.getUploadedImage ? window.getUploadedImage() : null;
                if (uploadedImg) {
                    data.comment_image = {
                        data: uploadedImg.data,
                        name: uploadedImg.name,
                        type: uploadedImg.type,
                        size: uploadedImg.size
                    };
                }
                
                try {
                    // יצירת System Prompt JSON מהטמפלט הקיים
                    const generator = new SimpleFormToPrompt();
                    const result = await generator.generateJSONFile(data);
                    
                    alert(`System Prompt JSON נוצר בהצלחה! 
📄 שם הקובץ: ${result.fileName}
👤 בעל המקצוע: ${data.name || 'לא צוין'}
🔧 תחום: ${data.primary_field || 'לא צוין'}
📊 גודל: ${Math.round(result.size / 1024)} KB
                    
הקובץ JSON כולל:
• System Prompt מלא עם הפרטים שלך כבר מוחלפים
• הטמפלט המקצועי עם השם והפרטים שלך
• מוכן להעתקה ישירה ל-ChatGPT/Claude!
• ללא פליסהולדרים - הכל מוחלף בפרטים האמיתיים!`);
                    
                } catch (error) {
                    console.error('שגיאה ביצירת System Prompt JSON:', error);
                    
                    // Fallback - הורדת JSON כמו קודם
                    const jsonData = JSON.stringify(data, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `client_data_${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    alert('שגיאה ביצירת System Prompt JSON. הטופס נשמר כקובץ נתונים רגיל במקום.');
                }
                
                // Reset form
                this.reset();
                
                // Remove all selected classes
                radioItems.forEach(item => {
                    item.classList.remove('selected');
                });
                
                // Reset business benefits
                selectedBusinessBenefits = [];
                updateBusinessBenefitsDisplay();
                
                // Reset specializations
                selectedSpecializations = [];
                updateSpecializationsDisplay();
                
                // Reset subcategory selections
                if (typeof selectedSubcategories !== 'undefined') {
                    selectedSubcategories.clear();
                    primaryField = null;
                    updateCombinedDisplay();
                    updateSubcategoryTable();
                }
                
                // Clear any error styles
                const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                if (businessBenefitsDisplay) {
                    businessBenefitsDisplay.style.borderColor = '';
                }
                
            });

        }); // End of DOMContentLoaded

        // Live Preview System
        class LivePreviewSystem {
            constructor() {
                this.initializePreview();
            }

            initializePreview() {
                const generateBtn = document.getElementById('generatePreviewBtn');
                if (generateBtn) {
                    generateBtn.addEventListener('click', () => this.generatePreview());
                }

                // Show preview section when form is mostly filled
                this.watchFormProgress();
            }

            watchFormProgress() {
                const requiredFields = ['client_name', 'primary_field', 'experience_years', 'phone_number'];
                const previewSection = document.getElementById('livePreviewSection');
                
                setInterval(() => {
                    const filledFields = requiredFields.filter(fieldName => {
                        const field = document.querySelector(`[name="${fieldName}"]`);
                        return field && field.value.trim() !== '';
                    });

                    // Check business benefits from the display
                    const businessBenefitsDisplay = document.getElementById('businessBenefitsDisplay');
                    const businessBenefitsFilled = businessBenefitsDisplay && 
                        businessBenefitsDisplay.children.length >= 4;
                    
                    if (filledFields.length >= 3 && businessBenefitsFilled) {
                        previewSection.style.display = 'block';
                    }
                }, 1000);
            }

            generateSamplePosts(primaryField, workAreas) {
                const postTemplates = {
                    'חשמל': [
                        'שלום, אני צריך חשמלאי בדחיפות! יש לי בעיה עם הלוח חשמל ונופל לי המגן. מישהו יכול להגיע היום?',
                        'מחפש חשמלאי להתקנת נקודות חשמל בבית החדש. יש לי 5 חדרים. מישהו יכול לתת הערכת מחיר?',
                        'היי! דרוש חשמלאי לתיקון בעיית תאורה בסלון. הנורות נדלקות ומכבות מעצמן. מישהו פנוי?'
                    ],
                    'אינסטלציה': [
                        'עזרה! יש לי דלפת מים חזקה מהברז במטבח. מישהו יכול להגיע עכשיו?',
                        'מחפש אינסטלטור לבדיקת לחץ מים בבית. המים זורמים חלש מאוד. מישהו יכול לעזור?',
                        'צריך התקנת אינסטלציה חדשה לחדר רחצה. מחפש מישהו מנוסה ואמין.'
                    ],
                    'שיפוצים כלליים': [
                        'מחפש בעל מקצוע לשיפוץ דירת 3 חדרים. כולל צבע, גבס ותיקונים קלים.',
                        'דרוש מקצוען לתיקון חור בקיר גבס + צביעה. מישהו פנוי השבוע?',
                        'רוצה לשפץ את הסלון. מחפש מישהו שיכול לעשות הכל - צבע, רצפה, תקרה.'
                    ],
                    'פיתוח מגרשים': [
                        'מחפש חברה לפיתוח מגרש של 800 מ"ר לבניית בית פרטי. יש תוכניות מאושרות.',
                        'צריך פיתוח מגרש חקלאי כולל דרכי גישה וחיבור לתשתיות. מי יכול לעזור?',
                        'דרוש יזם לפיתוח קרקע של 2 דונם. מחפש מישהו עם ניסיון בפרויקטים דומים.'
                    ],
                    'בנייה': [
                        'מחפש קבלן לבניית בית פרטי 200 מ"ר. יש תוכניות מאושרות והיתרים.',
                        'צריך קבלן בנייה לתוספת חדר 20 מ"ר לבית קיים. מישהו יכול להמליץ?',
                        'דרוש קבלן מנוסה לפרויקט בנייה של וילה דו קומתית.'
                    ],
                    'ריצוף וחיפוי': [
                        'מחפש מרצף לדירה 80 מ"ר. רוצה גרניט פורצלן. מישהו יכול לתת הצעת מחיר?',
                        'צריך חיפוי קיר למטבח 15 מ"ר. יש לי כבר את החומרים. מישהו פנוי השבוע?',
                        'דרוש מרצף מנוסה לריצוף חצר בבית פרטי. שטח של 50 מ"ר.'
                    ],
                    'ציור': [
                        'מחפש צייר לצביעת דירה 3 חדרים. כולל תקרות וקירות. מישהו יכול להמליץ?',
                        'צריך צייר לצביעת חדר ילדים. רוצה צבעים עמידים ובטוחים. מי יכול לעזור?',
                        'דרוש צייר מקצועי לצביעת חזית בית פרטי. 2 קומות.'
                    ],
                    'גינון': [
                        'מחפש גנן לעיצוב גינה חדשה בבית פרטי. שטח 200 מ"ר. מישהו יכול להמליץ?',
                        'צריך גיזום עצים בגינה + הקמת מערכת השקיה. מישהו מנוסה בתחום?',
                        'דרוש גנן לתחזוקה חודשית של גינה. מחפש מישהו אמין וקבוע.'
                    ],
                    'מזגנים': [
                        'המזגן לא מקרר! צריך טכנאי בדחיפות. החום הורג אותנו כאן.',
                        'מחפש טכנאי מזגנים להתקנה חדשה בסלון. מה המחיר לאינוורטר?',
                        'המזגן עושה רעשים מוזרים ומטפטף מים. מישהו יכול לבוא לבדוק?'
                    ],
                    'נגרות': [
                        'מחפש נגר לבניית ארון חדר שינה לפי מידה. גובה 2.40 מטר.',
                        'צריך תיקון דלת כניסה שלא נסגרת טוב. מישהו יכול להגיע השבוע?',
                        'דרוש נגר לבניית ספסל פינת אוכל + אחסון. יש לי סקיצות.'
                    ],
                    'מסגרות': [
                        'מחפש מסגר להתקנת גדר לחצר. אורך 30 מטר. מישהו יכול לתת הערכת מחיר?',
                        'צריך תיקון שער חניה שנתקע. המנוע עובד אבל השער לא זז.',
                        'דרוש מסגר לבניית פרגולה בחצר. יש לי את התוכניות מוכנות.'
                    ]
                };

                // Create contextual posts based on field
                const getDefaultPosts = (field) => {
                    if (field.includes('עורך דין') || field.includes('משפטי')) {
                        return [
                            `מחפש עורך דין לייעוץ משפטי בנושא ${field.replace('עורך דין ', '')}. מישהו יכול להמליץ?`,
                            `צריך ייצוג משפטי בעניין דחוף. מחפש עורך דין מנוסה ב${field}.`,
                            `שלום, רוצה להתייעץ עם עורך דין לגבי חוזה. מישהו זמין לפגישה?`
                        ];
                    } else if (field.includes('רופא') || field.includes('רפואה')) {
                        return [
                            `מחפש ${field} טוב ומנוסה. מישהו יכול להמליץ על מומחה?`,
                            `צריך לקבוע תור ל${field} בדחיפות. מישהו מכיר מי זמין?`,
                            `שלום, מחפש המלצה על ${field} באזור. תודה מראש!`
                        ];
                    } else if (field.includes('מדריך') || field.includes('הדרכה')) {
                        return [
                            `מחפש ${field} למפגש חד פעמי. מישהו יכול להמליץ?`,
                            `צריך ${field} לקבוצה של 10 אנשים. מישהו זמין השבוע?`,
                            `שלום, רוצה להזמין ${field} לאירוע. מה המחירים?`
                        ];
                    } else {
                        return [
                            `מחפש ${field} מנוסה ואמין. מישהו יכול להמליץ?`,
                            `צריך ${field} לפרויקט חדש. מישהו זמין השבוע?`,
                            `שלום, מחפש ${field} איכותי. מה המחירים?`
                        ];
                    }
                };
                
                const defaultPosts = getDefaultPosts(primaryField);

                const templates = postTemplates[primaryField] || defaultPosts;
                
                // Add location context if work areas are specified
                const locations = workAreas && workAreas.length > 0 ? workAreas : ['אזור המרכז'];
                
                // Fixed list of author names
                const authorNames = ['דני כהן', 'שרה לוי', 'יוסי אברהם'];
                
                return templates.map((template, index) => {
                    const location = locations[index % locations.length];
                    const authorName = authorNames[index % authorNames.length];
                    return {
                        content: `${authorName}: ${template}`,
                        displayContent: template,
                        authorName: authorName,
                        location: location
                    };
                });
            }

            async callLocalPreviewAPI(formData, samplePosts) {
                try {
                    // Call the backend AI response endpoint with form data
                    // Server will generate the prompt using the master template
                    const response = await fetch(`${API_BASE_URL}/collabo-api/generate-ai-responses`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            form_data: formData,
                            posts: samplePosts
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`Server Error: ${response.status}`);
                    }

                    const data = await response.json();

                    if (data.success && data.responses && data.responses.length > 0) {
                        // Format responses to match expected structure
                        return {
                            success: true,
                            responses: samplePosts.map((post, index) => ({
                                post: post,
                                response: this.appendWhatsAppLink(data.responses[index], formData.phone_number),
                                source: 'ai'
                            })),
                            apiKeyAvailable: true
                        };
                    } else {
                        throw new Error(data.error || 'AI response generation failed');
                    }
                } catch (error) {
                    console.error('AI API Error:', error);
                    // Fallback to mock responses
                    return {
                        success: true,
                        responses: samplePosts.map(post => ({
                            post: post,
                            response: this.generateMockResponse(post, formData.phone_number),
                            source: 'mock'
                        })),
                        apiKeyAvailable: false
                    };
                }
            }

            appendWhatsAppLink(response, phoneNumber) {
                // Append WhatsApp link in the format wa.me/+9725XXXXXXXX
                if (!phoneNumber) return response;
                return `${response}\nhttps://wa.me/+${phoneNumber}`;
            }

            generateMockResponse(userMessage, phoneNumber) {
                const clientName = document.querySelector('[name="client_name"]').value || 'המקצוען';
                const primaryField = document.querySelector('[name="primary_field"]').value || 'השירות';
                const phone = phoneNumber || '972521234567';

                return `שלום!

${clientName} כאן, ${primaryField} עם ניסיון רב בתחום.

אני זמין לעזור לך עם הבקשה שלך.

אשמח לתאם פגישה או שיחה קצרה כדי להבין בדיוק מה נדרש ולתת לך הערכת מחיר מדויקת.

ניתן ליצור קשר בווצאפ: wa.me/+${phone}

בהצלחה!
${clientName}`;
            }

            async generatePreview() {
                const previewContainer = document.getElementById('previewContainer');
                const loadingDiv = document.getElementById('previewLoading');
                const resultsDiv = document.getElementById('previewResults');
                
                // Show loading
                previewContainer.style.display = 'block';
                loadingDiv.style.display = 'block';
                resultsDiv.innerHTML = '';

                try {
                    // Get form data
                    const formData = this.collectFormData();
                    
                    // Validate form data before generating preview
                    const validationResult = this.validateFormData(formData);
                    if (!validationResult.isValid) {
                        throw new Error(validationResult.errorMessage);
                    }
                    
                    // Generate sample posts
                    const samplePosts = this.generateSamplePosts(formData.primary_field, formData.work_areas);
                    const selectedPosts = samplePosts.slice(0, 3);
                    const postsContent = selectedPosts.map(p => p.content);
                    
                    // Call local API to generate responses
                    const apiResponse = await this.callLocalPreviewAPI(formData, postsContent);
                    
                    if (apiResponse.success) {
                        this.updatePreviewResults(apiResponse.responses, selectedPosts);
                        
                        // Show API status indicator
                        const apiIndicator = document.getElementById('apiStatusIndicator');
                        if (!apiResponse.apiKeyAvailable) {
                            apiIndicator.classList.add('show');
                        } else {
                            apiIndicator.classList.remove('show');
                        }
                    } else {
                        throw new Error('API response failed');
                    }
                    
                } catch (error) {
                    console.error('Preview generation error:', error);
                    
                    // Check if this is a validation error
                    if (error.message.includes('חסרים הפרטים הבאים:')) {
                        resultsDiv.innerHTML = `<div style="color: #dc2626; text-align: center; padding: 20px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; margin: 10px 0;">
                            <strong>לא ניתן ליצור תצוגה מקדימה</strong><br>
                            ${error.message}
                        </div>`;
                    } else {
                        resultsDiv.innerHTML = '<div style="color: #dc2626; text-align: center;">שגיאה ביצירת התצוגה המקדימה. וודא שהשרת פועל.</div>';
                    }
                } finally {
                    loadingDiv.style.display = 'none';
                }
            }

            collectFormData() {

                // Extract unique work areas (counties) from categories structure
                const categories = buildCategoriesHierarchy();
                const workAreasSet = new Set();
                categories.forEach(cat => {
                    cat.subcategories.forEach(sub => {
                        if (sub.locations && sub.locations.length > 0) {
                            sub.locations.forEach(loc => {
                                loc.counties.forEach(county => workAreasSet.add(county));
                            });
                        }
                    });
                });
                const workAreas = Array.from(workAreasSet);

                // Collect business benefits from the global array (if available) or hidden inputs
                let businessBenefits = [];
                if (typeof selectedBusinessBenefits !== 'undefined' && selectedBusinessBenefits.length > 0) {
                    businessBenefits = selectedBusinessBenefits.map(b => b.text || b);
                } else {
                    // Fallback: read from hidden inputs
                    const benefitInputs = document.querySelectorAll('input[name="business_benefits[]"]');
                    businessBenefits = Array.from(benefitInputs).map(input => input.value).filter(v => v);
                }

                // Collect restrictions from the global array
                let restrictions = [];
                if (typeof selectedRestrictions !== 'undefined' && selectedRestrictions.length > 0) {
                    restrictions = selectedRestrictions;
                }

                // Format phone number to 9725XXXXXXXX
                const rawPhone = document.querySelector('[name="phone_number"]').value || '';
                const phoneNumber = formatPhoneNumber(rawPhone);

                // categories already built above for work areas extraction

                const formData = {
                    client_name: document.querySelector('[name="client_name"]').value || 'המקצוען',
                    primary_field: document.getElementById('primaryFieldHidden').value || 'שיפוצים כלליים',
                    experience_years: document.querySelector('[name="experience_years"]').value || '10',
                    phone_number: phoneNumber,
                    zap_customer_number: document.querySelector('[name="zap_customer_number"]').value || '',
                    work_areas: workAreas,
                    business_benefits: businessBenefits,
                    categories: categories,
                    restrictions: restrictions
                };

                return formData;
            }

            updatePreviewResults(results, selectedPosts) {
                const resultsDiv = document.getElementById('previewResults');

                // Get the uploaded image if exists
                const uploadedImg = window.getUploadedImage ? window.getUploadedImage() : null;
                const imageHTML = uploadedImg ? `
                    <div style="margin-top: 8px; padding: 0 16px 12px;">
                        <img src="${uploadedImg.data}" alt="תמונה מצורפת" style="max-width: 100%; max-height: 400px; border-radius: 8px; border: 1px solid #e4e6eb; object-fit: contain; display: block;">
                    </div>
                ` : '';

                resultsDiv.innerHTML = results.map((result, index) => {
                    // Get post data from selectedPosts
                    const postData = selectedPosts[index];
                    const authorName = postData.authorName;
                    const postContent = postData.displayContent;


                    // Get first letter for avatar
                    const avatarLetter = authorName.charAt(0);

                    return `
                        <div class="facebook-post-card">
                            <div class="post-header">
                                <div class="post-avatar">${avatarLetter}</div>
                                <div class="post-meta">
                                    <div class="post-author">${authorName}</div>
                                    <div class="post-time">${Math.floor(Math.random() * 12) + 1} דק'</div>
                                </div>
                            </div>
                            <div class="post-content">${postContent}</div>

                            <div class="post-interactions">
                                <div class="interactions-bar">
                                    <span class="interaction-btn">אהבתי</span>
                                    <span class="interaction-btn">תגובה</span>
                                    <span class="interaction-btn">שתף</span>
                                </div>
                            </div>

                            <div class="comments-section">
                                <div class="comment">
                                    <div class="comment-avatar">ס</div>
                                    <div class="comment-content">
                                        <div class="comment-author">הסוכן שלך (${document.querySelector('[name="client_name"]').value || 'בעל המקצוע'})</div>
                                        <div class="comment-time">עכשיו</div>
                                    </div>
                                </div>
                                <div class="comment-text">${formatLinksInText(result.response)}</div>
                                ${imageHTML}
                            </div>
                        </div>
                    `;
                }).join('');
            }

            validateFormData(formData) {
                const missingFields = [];
                
                // Question 1: Name (required)
                if (!formData.client_name || formData.client_name.trim() === '') {
                    missingFields.push('1. שם העסק שלכם');
                }
                
                // Question 2: Experience years (required)
                if (!formData.experience_years || formData.experience_years.trim() === '') {
                    missingFields.push('2. כמה שנים העסק שלכם פעיל');
                }
                
                // Question 3: Phone number (required)
                if (!formData.phone_number || formData.phone_number.trim() === '') {
                    missingFields.push('3. מספר טלפון');
                }

                // Question 4: Zap customer number (OPTIONAL - not required)

                // Question 5: Primary field (required)
                if (!formData.primary_field || formData.primary_field.trim() === '') {
                    missingFields.push('5. תחום פעילות ראשי');
                }

                // Question 6: Categories with locations (work_areas derived from categories)
                if (!formData.work_areas || formData.work_areas.length === 0) {
                    missingFields.push('6. תחומים ואזורי שירות');
                }

                // Question 7: Business benefits (required - at least 4)
                if (!formData.business_benefits || formData.business_benefits.length < 4) {
                    missingFields.push('7. יתרונות עסקיים (נדרשים לפחות 4)');
                }

                // Question 8: Specializations (OPTIONAL - not required)

                // Question 9: Restrictions/limitations (OPTIONAL - not required)
                
                if (missingFields.length > 0) {
                    const errorMessage = `חסרים הפרטים הבאים:\n${missingFields.join('\n')}`;
                    return {
                        isValid: false,
                        errorMessage: errorMessage
                    };
                }
                
                return {
                    isValid: true,
                    errorMessage: null
                };
            }
        }

        // Initialize Live Preview System when DOM is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                new LivePreviewSystem();
            });
        } else {
            new LivePreviewSystem();
        }

        /**
         * SimpleFormToPrompt Class - מוטמע מהקובץ המקורי
         * Simple Form to Prompt JSON - יצירת JSON עם הטמפלט המלא והחלפת פליסהולדרים
         */
        class SimpleFormToPrompt {
            /**
             * יצירת JSON עם metadata ו-form data בלבד
             */
            generateJSON(formData) {
                return {
                    metadata: {
                        client_name: formData.client_name || formData.name || 'לא צוין',
                        primary_field: formData.primary_field || 'לא צוין',
                        creation_date: new Date().toISOString(),
                        version: "3.0"
                    },
                    original_form_data: formData
                };
            }

            /**
             * יצירת קובץ JSON ושליחתו לשרת
             */
            async generateJSONFile(formData) {
                const data = this.generateJSON(formData);
                const fileName = `system_prompt_${(formData.name || 'client').replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;

                // שליחת JSON לשרת
                const jsonString = this.formatJSONNicely(data);

                const response = await fetch(`${API_BASE_URL}/collabo-api/pro-form`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: jsonString
                });

                if (!response.ok) {
                    throw new Error(`Server error: ${response.status}`);
                }

                const result = await response.json();

                return {
                    fileName: fileName,
                    data: data,
                    size: jsonString.length,
                    serverResponse: result
                };
            }

            /**
             * פורמט JSON יפה עם שורות חדשות אמיתיות
             */
            formatJSONNicely(data) {
                // מטאדאטה מצומצמת - רק החלקים הרלוונטיים
                const cleanMetadata = {
                    client_name: data.metadata.client_name,
                    primary_field: data.metadata.primary_field,
                    creation_date: data.metadata.creation_date
                };

                const jsonObj = {
                    metadata: cleanMetadata,
                    original_form_data: data.original_form_data
                };

                return JSON.stringify(jsonObj, null, 2);
            }
        }

        window.SimpleFormToPrompt = SimpleFormToPrompt;

        /**
         * Format Israeli phone number to 9725XXXXXXXX format
         * @param {string} phone - Phone number in any Israeli format
         * @returns {string} Formatted phone number as 9725XXXXXXXX
         */
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            const clean = phone.replace(/\D/g, '');
            if (clean.startsWith('0')) {
                return '972' + clean.slice(1);
            } else if (clean.startsWith('972')) {
                return clean;
            } else {
                return '972' + clean;
            }
        }

        // Make it globally available
        window.formatPhoneNumber = formatPhoneNumber;
    </script>
</body>

</html>



